<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Registros de Series</title>
    <style>
        .tabla-serie { margin-bottom:2rem; }
        .plan-label { font-size:.75rem; text-transform:uppercase; letter-spacing:.5px; font-weight:600; color:#6c757d; }
        .plan-valor { font-size:.85rem; font-weight:600; color:#495057; }
        .celda-form input[type=number], .celda-form textarea { max-width:160px; }
        table.table th, table.table td { vertical-align:middle; }
        .solo-lectura-note { font-size:.8rem; color:#6c757d; }
        .acciones-col { min-width:130px; }
        .acciones-col button { width:100%; margin-bottom:.35rem; }
        .acciones-col button:last-child { margin-bottom:0; }
        .contador-series { font-size:.85rem; color:#6c757d; }
        .debug { font-size:.7rem; font-family:monospace; }
    </style>
</head>
<body th:replace="layout/layout :: layout('Registros de Series', ~{::section})">
<section th:fragment="section">
    <div class="alert alert-danger" th:if="${error}" th:text="${error}"></div>
    <div class="alert alert-secondary debug" th:if="${debugSeriesCount != null}">
        <strong>DEBUG:</strong>
        series=[[${debugSeriesCount}]] ids=[[${debugSeriesIds}]] registros=[[${debugRegistrosCount}]]
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3 mb-0 text-gray-800">Registros de Series</h1>
        <div>
            <a th:if="${idDia != null}"
               th:href="@{/ejes/detallar/{idDia}(idDia=${idDia}, readonly=${readonly != null ? readonly : false})}"
               class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Volver a Ejercicios Asignados
            </a>
        </div>
    </div>

    <!-- Pestañas de navegación: semanas / dias / ejes (copiado de series/lista.html) -->
    <div class="semanas row">
        <button class="col-md-2" th:each="se : ${semanas}"
                th:classappend="${(dia != null and dia.idSemana != null and se != null and se.id == dia.idSemana)} ? 'bg-info text-white' : ''">
            <a th:href="@{/dias/detallar/{idSemana}(idSemana=${se.id}, readonly=${readonly != null ? readonly : false})}"
               th:text="'Semana '+${se.numeroSemana}"
               class="text-decoration-none text-reset"></a>
        </button>
        <button class="col-md-1">
            <a sec:authorize="hasAnyRole('ENTRENADOR')" th:if="${!readonly}"
               th:href="@{/semanas/crear/{idRutina}(idRutina=${idRutina})}">
                <i class="fas fa-plus"></i>
            </a>
        </button>
    </div>
    <div class="dias row">
        <button class="col-md-2" th:each="d : ${dias}"
                th:classappend="${(dia != null and dia.idDia != null and d != null and d.id == dia.idDia)} ? 'bg-info text-white' : ''">
            <a th:href="@{/ejes/detallar/{idDia}(idDia=${d.id}, readonly=${readonly != null ? readonly : false})}"
               th:text="'Dia '+${d.numeroDia}"
               class="text-decoration-none text-reset"></a>
        </button>
        <button class="col-md-1">
            <a sec:authorize="hasAnyRole('ENTRENADOR')" th:if="${!readonly and dia != null and dia.idSemana != null}"
               th:href="@{/dias/crear/{idSemana}(idSemana=${dia.idSemana})}">
                <i class="fas fa-plus"></i>
            </a>
        </button>
    </div>
    <div class="ejes row mb-5">
        <button class="col-md-2" th:each="e : ${ejes}"
                th:classappend="${(e != null and ejercicioAsignado != null and e.idEjercicioAsignado != null and ejercicioAsignado.idEjercicioAsignado != null and e.idEjercicioAsignado.equals(ejercicioAsignado.idEjercicioAsignado))} ? 'bg-info text-white' : ''">
            <!-- Sólo renderizar el enlace si 'e' existe y tiene id -->
            <a th:if="${e != null and e.idEjercicioAsignado != null}"
               th:href="@{/series/detallar/{idEje}(idEje=${e.idEjercicioAsignado}, readonly=${readonly != null ? readonly : false})}"
               th:text="${e != null and e.nombreEjercicio != null ? e.nombreEjercicio : 'Sin nombre'}"
               class="text-decoration-none text-reset"></a>
            <!-- Si no hay 'e', mostrar texto sin enlace -->
            <span th:if="${e == null or e.idEjercicioAsignado == null}"
                  th:text="${e != null and e.nombreEjercicio != null ? e.nombreEjercicio : 'Sin nombre'}"
                  class="text-decoration-none text-reset"></span>
        </button>
        <button class="col-md-1">
            <a sec:authorize="hasAnyRole('ENTRENADOR')" th:if="${!readonly and dia != null and dia.idDia != null}"
               th:href="@{/ejes/crear/{idDia}(idDia=${dia.idDia})}">
                <i class="fas fa-plus"></i>
            </a>
        </button>
    </div>

    <div class="mb-2 contador-series" th:if="${series != null}" th:text="${'Series encontradas: ' + #lists.size(series)}"></div>

    <div class="mb-4">
        <h5 class="mb-1" th:text="${ejercicioAsignado != null && ejercicioAsignado.ejercicio != null ? ejercicioAsignado.ejercicio.nombre : 'Ejercicio'}"></h5>
        <p class="text-muted mb-0" th:if="${ejercicioAsignado != null}" th:text="${'Orden en el día: ' + ejercicioAsignado.orden}"></p>
        <p class="solo-lectura-note" sec:authorize="hasRole('ENTRENADOR')">Vista solo lectura para entrenador.</p>
    </div>

    <div th:if="${series == null || #lists.isEmpty(series)}" class="alert alert-info">No hay series planificadas todavía.</div>

    <div th:each="serie : ${series}" class="tabla-serie" th:with="reg=${registrosMap[serie.id]}">
        <form th:action="@{/registros-series/guardar}" method="post" class="mb-0">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <input type="hidden" name="idSerie" th:value="${serie.id}"/>
            <input type="hidden" name="idRegistroSerie" th:value="${reg != null ? reg.idRegistroSerie : null}"/>
            <input type="hidden" name="fechaEjecucion" th:value="${reg != null ? reg.fechaEjecucion : null}"/>
            <input type="hidden" name="estado" value="true">
            <table class="table table-bordered table-hover shadow-sm bg-white mb-0">
                <thead class="table-light">
                <tr>
                    <th style="width:8%"># Serie</th>
                    <th style="width:16%">Repeticiones</th>
                    <th style="width:16%">Peso (kg)</th>
                    <th style="width:16%">Descanso</th>
                    <th style="width:12%">Intensidad</th>
                    <th style="width:22%">Comentario Cliente</th>
                    <th style="width:10%" class="acciones-col">Acciones</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td><span class="plan-valor" th:text="${serie.orden}"></span></td>
                    <td class="celda-form">
                        <div class="plan-label">Plan</div>
                        <div class="plan-valor" th:text="${serie.repeticiones != null ? serie.repeticiones : '-'}"></div>
                        <div class="plan-label mt-2">Real</div>
                        <input type="number" min="0" name="repeticionesReales" class="form-control"
                               th:value="${reg != null ? reg.repeticionesReales : null}" placeholder="0"
                               th:disabled="${readonly}">
                    </td>
                    <td class="celda-form">
                        <div class="plan-label">Plan</div>
                        <div class="plan-valor" th:text="${serie.peso != null ? serie.peso : '-'}"></div>
                        <div class="plan-label mt-2">Real</div>
                        <input type="number" min="0" step="0.25" name="pesoReal" class="form-control"
                               th:value="${reg != null ? reg.pesoReal : null}" placeholder="0.0"
                               th:disabled="${readonly}">
                    </td>
                    <td class="celda-form">
                        <div class="plan-label">Plan</div>
                        <div class="plan-valor" th:text="${serie.descanso != null ? serie.descanso : '-'}"></div>
                        <div class="plan-label mt-2">Real (seg)</div>
                        <input type="number" min="0" name="descansoReal" class="form-control"
                               th:value="${reg != null ? reg.descansoReal : null}" placeholder="0"
                               th:disabled="${readonly}">
                    </td>
                    <td>
                        <div class="plan-label">Plan</div>
                        <div class="plan-valor" th:text="${serie.intensidad != null ? serie.intensidad : '-'}"></div>
                    </td>
                    <td class="celda-form">
                        <div class="plan-label">Comentario</div>
                        <textarea name="comentariosCliente" rows="3" class="form-control"
                                  th:text="${reg != null ? reg.comentariosCliente : ''}" placeholder="Notas opcionales"
                                  th:disabled="${readonly}"></textarea>
                    </td>
                    <td class="acciones-col">
                        <div sec:authorize="hasRole('CLIENTE')" th:if="${!readonly}">
                            <button type="submit" class="btn btn-sm btn-success mb-1">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                            <button type="submit" class="btn btn-sm btn-outline-warning"
                                    formaction="/registros-series/limpiar" formmethod="post"
                                    name="idSerie" th:value="${serie.id}"
                                    onclick="return confirm('¿Limpiar registro de esta serie?');">
                                <i class="fas fa-eraser"></i> Limpiar
                            </button>
                        </div>
                        <div sec:authorize="hasRole('ENTRENADOR')" th:if="${readonly}" class="text-muted" style="font-size:.7rem;">Solo lectura</div>
                    </td>
                </tr>
                </tbody>
            </table>
        </form>
    </div>
</section>
</body>
</html>