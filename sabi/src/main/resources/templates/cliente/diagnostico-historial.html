<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Historial de Diagnósticos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/diagnostico-form.css}">
</head>
<body th:replace="layout/layout :: layout('Historial de Diagnósticos', ~{::section})">
<section th:fragment="section">
<div class="container py-4">
    <h2 class="mb-4">Historial de Diagnósticos</h2>
    <div class="d-flex justify-content-end mb-3">
        <a class="btn btn-success" th:href="@{/cliente/diagnostico/descargar}">
            <i class="fas fa-file-excel"></i> Descargar Excel
        </a>
    </div>
    <table class="table table-bordered table-hover">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Peso</th>
                <th>Estatura</th>
                <th>Nivel</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="diag : ${historial}">
                <td th:text="${#temporals.format(diag.fecha, 'dd/MM/yyyy')}"></td>
                <td th:text="${diag.peso}"></td>
                <td th:text="${diag.estatura}"></td>
                <td th:text="${diag.nivelExperiencia}"></td>
                <td>
                    <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#modalDetalle" th:attr="data-id=${diag.idDiagnostico}">Ver detalle</button>
                    <a th:href="@{/cliente/diagnostico/descargar/{id}(id=${diag.idDiagnostico})}" class="btn btn-success btn-sm">
                        <i class="fas fa-file-excel"></i> Descargar Excel
                    </a>
                </td>
            </tr>
        </tbody>
    </table>
    <!-- Modal para detalle de diagnóstico -->
    <div class="modal fade" id="modalDetalle" tabindex="-1" aria-labelledby="modalDetalleLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="modalDetalleLabel">Detalle de Diagnóstico</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div id="detalleDiagnosticoContent">
              <!-- Aquí se cargan los datos por AJAX -->
            </div>
            <div class="alert alert-info mt-3">
              <i class="fas fa-info-circle"></i> Los datos mostrados son solo informativos y no pueden ser editados.
            </div>
          </div>
        </div>
      </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var modal = document.getElementById('modalDetalle');
    modal.addEventListener('show.bs.modal', function (event) {
      var button = event.relatedTarget;
      var diagId = button.getAttribute('data-id');
      fetch('/diagnostico/detalle/' + diagId)
        .then(response => response.json())
        .then(data => {
          document.getElementById('detalleDiagnosticoContent').innerHTML = `
            <div class='row'>
              <div class='col-md-6'>
                <ul class='list-group mb-3'>
                  <li class='list-group-item'><strong>Fecha:</strong> ${data.fecha}</li>
                  <li class='list-group-item'><strong>Peso:</strong> ${data.peso} kg</li>
                  <li class='list-group-item'><strong>Estatura:</strong> ${data.estatura} cm</li>
                  <li class='list-group-item'><strong>IMC:</strong> ${data.peso && data.estatura ? (Math.round((data.peso / Math.pow(data.estatura/100,2))*10)/10) : '--'}</li>
                  <li class='list-group-item'><strong>Nivel de experiencia:</strong> ${data.nivelExperiencia}</li>
                  <li class='list-group-item'><strong>Disponibilidad de tiempo:</strong> ${data.disponibilidadTiempo || 'N/A'}</li>
                  <li class='list-group-item'><strong>Acceso a recursos:</strong> ${data.accesoRecursos || 'N/A'}</li>
                  <li class='list-group-item'><strong>Lesiones:</strong> ${data.lesiones || 'N/A'}</li>
                  <li class='list-group-item'><strong>Condiciones médicas:</strong> ${data.condicionesMedicas || 'N/A'}</li>
                </ul>
              </div>
              <div class='col-md-6'>
                <ul class='list-group mb-3'>
                  <li class='list-group-item'><strong>Foto Frontal:</strong> ${data.fotoFrontalUrl ? `<a href='${data.fotoFrontalUrl}' target='_blank'>Ver foto</a>` : 'N/A'}</li>
                  <li class='list-group-item'><strong>Foto Lateral:</strong> ${data.fotoLateralUrl ? `<a href='${data.fotoLateralUrl}' target='_blank'>Ver foto</a>` : 'N/A'}</li>
                  <li class='list-group-item'><strong>Foto Trasera:</strong> ${data.fotoTraseraUrl ? `<a href='${data.fotoTraseraUrl}' target='_blank'>Ver foto</a>` : 'N/A'}</li>
                  <li class='list-group-item'><strong>% Grasa Corporal:</strong> ${data.porcentajeGrasaCorporal || 'N/A'}</li>
                  <li class='list-group-item'><strong>Circunferencia Cintura:</strong> ${data.circunferenciaCintura || 'N/A'} cm</li>
                  <li class='list-group-item'><strong>Circunferencia Cadera:</strong> ${data.circunferenciaCadera || 'N/A'} cm</li>
                  <li class='list-group-item'><strong>Circunferencia Brazo:</strong> ${data.circunferenciaBrazo || 'N/A'} cm</li>
                  <li class='list-group-item'><strong>Circunferencia Pierna:</strong> ${data.circunferenciaPierna || 'N/A'} cm</li>
                  <li class='list-group-item'><strong>Frecuencia Cardíaca Reposo:</strong> ${data.frecuenciaCardiacaReposo || 'N/A'} bpm</li>
                  <li class='list-group-item'><strong>Presión Arterial:</strong> ${data.presionArterial || 'N/A'}</li>
                  <li class='list-group-item'><strong>Horas de Sueño:</strong> ${data.horasSueno || 'N/A'}</li>
                  <li class='list-group-item'><strong>Hábitos Alimenticios:</strong> ${data.habitosAlimenticios || 'N/A'}</li>
                </ul>
              </div>
            </div>
          `;
        });
    });
  });
</script>
</section>
</body>
</html>
