<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Mi DiagnÃ³stico</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/diagnostico-form.css}">
</head>
<body th:replace="layout/layout :: layout('Mi DiagnÃ³stico', ~{::section})">
<section th:fragment="section">
<div class="container py-4">
    <h2 class="mb-4">Mi DiagnÃ³stico</h2>
    <div th:if="${mensajeObligatorio}" class="alert alert-warning d-flex align-items-center" role="alert" style="font-size:1.1rem;">
        <i class="fa-solid fa-triangle-exclamation me-2"></i>
        <span th:text="${mensajeObligatorio}"></span>
    </div>
    <form th:action="@{/diagnostico/crear}" method="post" enctype="multipart/form-data" class="needs-validation" novalidate th:object="${diagnostico}">
        <!-- Campo oculto para ID del diagnÃ³stico en caso de actualizaciÃ³n -->
        <input type="hidden" th:field="*{idDiagnostico}" th:if="${diagnostico?.idDiagnostico != null}"/>
         <!-- Obligatorios -->
        <div class="categoria">
            <div class="categoria-titulo">Datos fÃ­sicos <span class="badge bg-danger">Obligatorio</span></div>
            <div class="row g-3 align-items-end">
                <div class="col-md-12">
                    <label for="objetivo" class="form-label">Â¿CuÃ¡l es tu objetivo?</label>

                    <!-- Mensaje informativo sobre el objetivo -->
                    <div class="alert alert-info" style="background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%); border-left: 4px solid #17a2b8; margin-bottom: 12px;">
                        <div style="display: flex; align-items: start; gap: 10px;">
                            <i class="fas fa-info-circle" style="font-size: 1.3rem; color: #0c5460; margin-top: 2px;"></i>
                            <div style="flex: 1;">
                                <strong style="color: #0c5460; display: block; margin-bottom: 4px;">
                                    <i class="fas fa-bullseye"></i> Tu objetivo es fundamental
                                </strong>
                                <small style="color: #0c5460; line-height: 1.5;">
                                    El objetivo que definas aquÃ­ se guardarÃ¡ en tu <strong>perfil</strong> y serÃ¡ visible tanto para <strong>ti</strong> como para tu <strong>entrenador</strong>.
                                    Es esencial para crear un plan de entrenamiento personalizado que se ajuste a tus metas.
                                    Puedes actualizarlo en cualquier momento desde tu perfil.
                                </small>
                            </div>
                        </div>
                    </div>

                    <textarea class="form-control" id="objetivo" th:field="*{objetivo}" rows="2" required placeholder="Ej: Perder peso, ganar masa muscular, mejorar resistencia..."></textarea>
                    <small class="text-muted">Describe quÃ© quieres lograr con tu entrenamiento.</small>
                    <div class="invalid-feedback">Este campo es obligatorio.</div>
                </div>
                <div class="col-md-4">
                    <label for="peso" class="form-label">Peso (kg)</label>
                    <input type="number" step="0.1" min="30" max="300" class="form-control" id="peso" th:field="*{peso}" required placeholder="Ej: 70.5">
                    <small class="text-muted">Ingrese su peso actual en kilogramos.</small>
                    <div class="invalid-feedback">Este campo es obligatorio.</div>
                    <!-- Comparativa con diagnÃ³stico anterior -->
                    <div class="comparativa-badge" id="pesoComparativa" style="display: none;"></div>
                </div>
                <div class="col-md-4">
                    <label for="estatura" class="form-label">Estatura (cm)</label>
                    <input type="number" step="0.1" min="100" max="250" class="form-control" id="estatura" th:field="*{estatura}" required placeholder="Ej: 175">
                    <small class="text-muted">Ingrese su estatura en centÃ­metros.</small>
                    <div class="invalid-feedback">Este campo es obligatorio.</div>
                    <!-- Comparativa con diagnÃ³stico anterior -->
                    <div class="comparativa-badge" id="estaturaComparativa" style="display: none;"></div>
                </div>
                <div class="col-md-4">
                    <div id="imcBox" class="imc-box">IMC: <span id="imcValue">--</span></div>
                    <small class="text-muted">El IMC se calcula automÃ¡ticamente.</small>
                    <!-- Comparativa con diagnÃ³stico anterior -->
                    <div class="comparativa-badge" id="imcComparativa" style="display: none;"></div>
                </div>
                <div class="col-md-4">
                    <label for="nivelExperiencia" class="form-label">Nivel de experiencia</label>
                    <select class="form-select" id="nivelExperiencia" th:field="*{nivelExperiencia}" required>
                        <option value="">Seleccione...</option>
                        <option value="PRINCIPIANTE">Principiante</option>
                        <option value="INTERMEDIO">Intermedio</option>
                        <option value="AVANZADO">Avanzado</option>
                    </select>
                    <small class="text-muted">Seleccione su nivel de experiencia fÃ­sica.</small>
                    <div class="invalid-feedback">Este campo es obligatorio.</div>
                    <!-- Comparativa con diagnÃ³stico anterior -->
                    <div class="comparativa-badge" id="nivelExperienciaComparativa" style="display: none;"></div>
                </div>
                <div class="col-md-4">
                    <label for="disponibilidadTiempo" class="form-label">Disponibilidad de tiempo</label>
                    <input type="text" class="form-control" id="disponibilidadTiempo" th:field="*{disponibilidadTiempo}" required placeholder="Ej: 3 veces por semana, 45 min">
                    <small class="text-muted">Ejemplo: 3 veces por semana, 45 min.</small>
                    <div class="invalid-feedback">Este campo es obligatorio.</div>
                </div>
                <div class="col-md-4">
                    <label for="accesoRecursos" class="form-label">Acceso a recursos</label>
                    <input type="text" class="form-control" id="accesoRecursos" th:field="*{accesoRecursos}" required placeholder="Ej: casa, gimnasio, pesas">
                    <small class="text-muted">Ejemplo: casa, gimnasio, pesas.</small>
                    <div class="invalid-feedback">Este campo es obligatorio.</div>
                </div>
                <div class="col-md-4">
                    <label for="lesiones" class="form-label">Lesiones</label>
                    <input type="text" class="form-control" id="lesiones" th:field="*{lesiones}" required placeholder="Ej: ninguna, rodilla, espalda">
                    <small class="text-muted">Indique si tiene alguna lesiÃ³n relevante.</small>
                    <div class="invalid-feedback">Este campo es obligatorio.</div>
                </div>
                <div class="col-md-4">
                    <label for="condicionesMedicas" class="form-label">Condiciones mÃ©dicas</label>
                    <input type="text" class="form-control" id="condicionesMedicas" th:field="*{condicionesMedicas}" required placeholder="Ej: hipertensiÃ³n, diabetes">
                    <small class="text-muted">Indique si tiene alguna condiciÃ³n mÃ©dica relevante.</small>
                    <div class="invalid-feedback">Este campo es obligatorio.</div>
                </div>
                 <div class="col-md-4">
                    <label for="horasSueno" class="form-label">Horas de sueÃ±o</label>
                    <input type="number" step="0.1" min="0" max="24" class="form-control" id="horasSueno" th:field="*{horasSueno}" required placeholder="Ej: 8">
                    <small class="text-muted">Ingrese el promedio de horas de sueÃ±o diarias.</small>
                    <div class="invalid-feedback">Este campo es obligatorio.</div>
                </div>
                <div class="col-md-4">
                    <label for="habitosAlimenticios" class="form-label">HÃ¡bitos Alimenticios</label>
                    <input type="text" class="form-control" id="habitosAlimenticios" th:field="*{habitosAlimenticios}" required placeholder="Ej: dieta balanceada, vegetariano">
                    <small class="text-muted">Describa brevemente su alimentaciÃ³n.</small>
                    <div class="invalid-feedback">Este campo es obligatorio.</div>
                </div>
            </div>
        </div>

        <!-- FOTOS OBLIGATORIAS -->
        <div class="categoria">
            <div class="categoria-titulo">Fotos del DiagnÃ³stico <span class="badge bg-danger">Obligatorio</span></div>
            <small class="text-muted d-block mb-3">
                ðŸ“¸ <span th:if="${diagnostico?.idDiagnostico == null}">Las 3 fotos son obligatorias para crear tu diagnÃ³stico.</span>
                <span th:if="${diagnostico?.idDiagnostico != null}">Sube nuevas fotos solo si quieres cambiarlas (opcional).</span>
                Sube cualquier imagen desde tu PC (mÃ¡x. 10MB cada una)
            </small>
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="fotoFrontal" class="form-label">
                        <i class="fas fa-camera"></i> Foto Frontal *
                    </label>
                    <input type="file"
                           class="form-control"
                           id="fotoFrontal"
                           name="fotoFrontal"
                           accept="image/*"
                           th:required="${diagnostico?.idDiagnostico == null}"
                           onchange="previewImage(this, 'preview-frontal')">
                    <small class="text-muted">Foto de frente, posiciÃ³n relajada</small>
                    <div class="mt-2">
                        <img id="preview-frontal" 
                             th:src="${diagnosticoActual?.fotoFrontalUrl}" 
                             th:style="${diagnosticoActual?.fotoFrontalUrl != null} ? 'max-width: 100%; max-height: 200px; display: block; border-radius: 8px; border: 2px solid #ddd;' : 'max-width: 100%; max-height: 200px; display: none; border-radius: 8px; border: 2px solid #ddd;'"
                             alt="Foto Frontal">
                        <small th:if="${diagnosticoActual?.fotoFrontalUrl != null}" class="text-muted">Foto actual - selecciona nueva para cambiar</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <label for="fotoLateral" class="form-label">
                        <i class="fas fa-camera"></i> Foto Lateral *
                    </label>
                    <input type="file"
                           class="form-control"
                           id="fotoLateral"
                           name="fotoLateral"
                           accept="image/*"
                           th:required="${diagnostico?.idDiagnostico == null}"
                           onchange="previewImage(this, 'preview-lateral')">
                    <small class="text-muted">Foto de perfil lateral</small>
                    <div class="mt-2">
                        <img id="preview-lateral" 
                             th:src="${diagnosticoActual?.fotoLateralUrl}" 
                             th:style="${diagnosticoActual?.fotoLateralUrl != null} ? 'max-width: 100%; max-height: 200px; display: block; border-radius: 8px; border: 2px solid #ddd;' : 'max-width: 100%; max-height: 200px; display: none; border-radius: 8px; border: 2px solid #ddd;'"
                             alt="Foto Lateral">
                        <small th:if="${diagnosticoActual?.fotoLateralUrl != null}" class="text-muted">Foto actual - selecciona nueva para cambiar</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <label for="fotoTrasera" class="form-label">
                        <i class="fas fa-camera"></i> Foto Trasera *
                    </label>
                    <input type="file"
                           class="form-control"
                           id="fotoTrasera"
                           name="fotoTrasera"
                           accept="image/*"
                           th:required="${diagnostico?.idDiagnostico == null}"
                           onchange="previewImage(this, 'preview-trasera')">
                    <small class="text-muted">Foto de espalda</small>
                    <div class="mt-2">
                        <img id="preview-trasera" 
                             th:src="${diagnosticoActual?.fotoTraseraUrl}" 
                             th:style="${diagnosticoActual?.fotoTraseraUrl != null} ? 'max-width: 100%; max-height: 200px; display: block; border-radius: 8px; border: 2px solid #ddd;' : 'max-width: 100%; max-height: 200px; display: none; border-radius: 8px; border: 2px solid #ddd;'"
                             alt="Foto Trasera">
                        <small th:if="${diagnosticoActual?.fotoTraseraUrl != null}" class="text-muted">Foto actual - selecciona nueva para cambiar</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Opcionales -->
        <div class="categoria">
            <div class="categoria-titulo">Datos adicionales <span class="badge bg-info">Opcional</span></div>
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="porcentajeGrasaCorporal" class="form-label">% Grasa Corporal</label>
                    <input type="number" step="0.1" min="0" max="100" class="form-control" id="porcentajeGrasaCorporal" name="porcentajeGrasaCorporal" th:field="*{porcentajeGrasaCorporal}" placeholder="Ej: 18.5">
                    <small class="text-muted">Porcentaje estimado de grasa corporal.</small>
                </div>
                <div class="col-md-4">
                    <label for="circunferenciaCintura" class="form-label">Circunferencia Cintura (cm)</label>
                    <input type="number" step="0.1" min="0" class="form-control" id="circunferenciaCintura" name="circunferenciaCintura" th:field="*{circunferenciaCintura}" placeholder="Ej: 80">
                    <small class="text-muted">Medida de la cintura en centÃ­metros.</small>
                </div>
                <div class="col-md-4">
                    <label for="circunferenciaCadera" class="form-label">Circunferencia Cadera (cm)</label>
                    <input type="number" step="0.1" min="0" class="form-control" id="circunferenciaCadera" name="circunferenciaCadera" th:field="*{circunferenciaCadera}" placeholder="Ej: 95">
                    <small class="text-muted">Medida de la cadera en centÃ­metros.</small>
                </div>
                <div class="col-md-4">
                    <label for="circunferenciaBrazo" class="form-label">Circunferencia Brazo (cm)</label>
                    <input type="number" step="0.1" min="0" class="form-control" id="circunferenciaBrazo" name="circunferenciaBrazo" th:field="*{circunferenciaBrazo}" placeholder="Ej: 32">
                    <small class="text-muted">Medida del brazo en centÃ­metros.</small>
                </div>
                <div class="col-md-4">
                    <label for="circunferenciaPierna" class="form-label">Circunferencia Pierna (cm)</label>
                    <input type="number" step="0.1" min="0" class="form-control" id="circunferenciaPierna" name="circunferenciaPierna" th:field="*{circunferenciaPierna}" placeholder="Ej: 40">
                    <small class="text-muted">Medida de la pierna en centÃ­metros.</small>
                </div>
                <div class="col-md-4">
                    <label for="frecuenciaCardiacaReposo" class="form-label">Frecuencia CardÃ­aca Reposo (bpm)</label>
                    <input type="number" min="30" max="200" class="form-control" id="frecuenciaCardiacaReposo" name="frecuenciaCardiacaReposo" th:field="*{frecuenciaCardiacaReposo}" placeholder="Ej: 70">
                    <small class="text-muted">Latidos por minuto en reposo.</small>
                </div>
                <div class="col-md-4">
                    <label for="presionArterial" class="form-label">PresiÃ³n Arterial</label>
                    <input type="text" class="form-control" id="presionArterial" name="presionArterial" th:field="*{presionArterial}" placeholder="Ej: 120/80">
                    <small class="text-muted">Ejemplo: 120/80.</small>
                </div>
            </div>
        </div>

        <!-- Informacion para el Entrenador (OPCIONAL) -->
        <div class="categoria">
            <div class="categoria-titulo">Informacion para tu Entrenador <span class="badge bg-info">Opcional</span></div>
            <small class="text-muted d-block mb-3">
                ðŸ’¡ Esta informacion ayudara a tu entrenador a disenar la mejor rutina para ti
            </small>
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="preferenciasEntrenamiento" class="form-label">Preferencias de Entrenamiento</label>
                    <textarea class="form-control" id="preferenciasEntrenamiento" name="preferenciasEntrenamiento" rows="2" th:field="*{preferenciasEntrenamiento}" placeholder="Ej: Prefiero ejercicios funcionales, me gusta variar, no me gusta correr"></textarea>
                    <small class="text-muted">Â¿Que tipo de ejercicios prefieres o disfrutas mas?</small>
                </div>
                <div class="col-md-6">
                    <label for="experienciaPreviaDeportes" class="form-label">Experiencia Previa en Deportes</label>
                    <textarea class="form-control" id="experienciaPreviaDeportes" name="experienciaPreviaDeportes" rows="2" th:field="*{experienciaPreviaDeportes}" placeholder="Ej: Jugue futbol 5 anos, natacion 2 anos"></textarea>
                    <small class="text-muted">Â¿Has practicado deportes antes? Â¿Cuales y por cuanto tiempo?</small>
                </div>
                <div class="col-md-4">
                    <label for="diasDisponiblesSemana" class="form-label">Dias Disponibles por Semana</label>
                    <input type="number" min="1" max="7" class="form-control" id="diasDisponiblesSemana" name="diasDisponiblesSemana" th:field="*{diasDisponiblesSemana}" placeholder="Ej: 4">
                    <small class="text-muted">Â¿Cuantos dias a la semana puedes entrenar?</small>
                </div>
                <div class="col-md-4">
                    <label for="horarioPreferido" class="form-label">Horario Preferido</label>
                    <input type="text" class="form-control" id="horarioPreferido" name="horarioPreferido" th:field="*{horarioPreferido}" placeholder="Ej: Mananas 6am-8am">
                    <small class="text-muted">Â¿En que horario prefieres entrenar?</small>
                <div class="col-md-4">
            </div>
                    <label for="nivelEstres" class="form-label">Nivel de Estres</label>
                    <select class="form-select" id="nivelEstres" name="nivelEstres" th:field="*{nivelEstres}">
                        <option value="">Seleccionar...</option>
                        <option value="BAJO">Bajo</option>
                        <option value="MEDIO">Medio</option>
                        <option value="ALTO">Alto</option>
                    </select>
                    <small class="text-muted">Â¿Como es tu nivel de estres diario?</small>
                </div>
                <div class="col-md-6">
                    <label for="limitacionesFisicas" class="form-label">Limitaciones Fisicas</label>
                    <textarea class="form-control" id="limitacionesFisicas" name="limitacionesFisicas" rows="2" th:field="*{limitacionesFisicas}" placeholder="Ej: No puedo hacer sentadillas profundas por problema de rodilla"></textarea>
                    <small class="text-muted">Â¿Hay algun movimiento o ejercicio que no puedas hacer?</small>
                </div>
                <div class="col-md-6">
                    <label for="motivacionPrincipal" class="form-label">Motivacion Principal</label>
                    <textarea class="form-control" id="motivacionPrincipal" name="motivacionPrincipal" rows="2" th:field="*{motivacionPrincipal}" placeholder="Ej: Mejorar mi salud, verme mejor, competir"></textarea>
                    <small class="text-muted">Â¿Que te motiva a entrenar?</small>
                </div>
                <div class="col-md-6">
                    <label for="suplementosActuales" class="form-label">Suplementos Actuales</label>
                    <input type="text" class="form-control" id="suplementosActuales" name="suplementosActuales" th:field="*{suplementosActuales}" placeholder="Ej: Proteina whey, creatina">
                    <small class="text-muted">Â¿Tomas algun suplemento actualmente?</small>
                </div>
                <div class="col-md-3">
                    <label for="fumador" class="form-label">Â¿Fumas?</label>
                    <select class="form-select" id="fumador" name="fumador" th:field="*{fumador}">
                        <option value="">Seleccionar...</option>
                        <option value="false">No</option>
                        <option value="true">Si</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="consumeAlcohol" class="form-label">Â¿Consumes Alcohol?</label>
                    <select class="form-select" id="consumeAlcohol" name="consumeAlcohol" th:field="*{consumeAlcohol}">
                        <option value="">Seleccionar...</option>
                        <option value="false">No</option>
                        <option value="true">Si</option>
                    </select>
                </div>
                </div>
                <div class="col-md-6" th:if="${diagnosticoActual?.consumeAlcohol == true}">
                    <label for="frecuenciaAlcohol" class="form-label">Frecuencia de Consumo de Alcohol</label>
                    <input type="text" class="form-control" id="frecuenciaAlcohol" name="frecuenciaAlcohol" th:field="*{frecuenciaAlcohol}" placeholder="Ej: 1 vez por semana, 2-3 veces/semana">
                    <small class="text-muted">Â¿Con que frecuencia consumes alcohol?</small>
                </div>
        <div class="col-12 text-end">
            <button type="submit" class="btn btn-primary" 
                    th:text="${diagnostico?.idDiagnostico == null ? 'Crear diagnÃ³stico' : 'Actualizar diagnÃ³stico'}">
                    Guardar diagnÃ³stico
            </button>
        </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Datos del diagnÃ³stico actual para comparaciÃ³n (Thymeleaf) -->
<script th:inline="javascript">
    /*<![CDATA[*/
    var diagnosticoAnterior = {
        peso: /*[[${diagnosticoActual?.peso}]]*/ null,
        estatura: /*[[${diagnosticoActual?.estatura}]]*/ null,
        nivelExperiencia: /*[[${diagnosticoActual?.nivelExperiencia}]]*/ null
    };
    /*]]>*/
</script>
<script th:src="@{/js/diagnostico-form.js}"></script>
<script>
/// Funcion para mostrar preview de las imagenes
    function previewImage(input, previewId) {
        const file = input.files[0];
        const preview = document.getElementById(previewId);

        if (!file) {
            preview.style.display = 'none';
            return;
        }

        // Validar tamano (10MB maximo)
        const maxSize = 10 * 1024 * 1024;
        if (file.size > maxSize) {
            alert('La imagen es demasiado grande. El tamaÃ±o maximo es 10MB.\n\nTamaÃ±o actual: ' + (file.size / 1024 / 1024).toFixed(2) + 'MB');
            input.value = '';
            preview.style.display = 'none';
            return;
        }

        // Mostrar preview
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }

    // Validacion antes de enviar el formulario
    document.querySelector('form').addEventListener('submit', function(e) {
        const fotoFrontal = document.getElementById('fotoFrontal');
        const fotoLateral = document.getElementById('fotoLateral');
        const fotoTrasera = document.getElementById('fotoTrasera');
        
        // Verificar si es creaciÃ³n (las fotos son required) o actualizaciÃ³n (opcionales)
        const esCreacion = fotoFrontal.required;

        if (esCreacion && (!fotoFrontal.files.length || !fotoLateral.files.length || !fotoTrasera.files.length)) {
            e.preventDefault();
            alert('Las 3 fotos son obligatorias para crear el diagnÃ³stico:\n\nâœ“ Foto Frontal\nâœ“ Foto Lateral\nâœ“ Foto Trasera\n\nPor favor, sube todas las fotos antes de continuar.');
            return false;
        }
    });
</script>
</section>
</body>
</html>
