<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Mi Diagnóstico</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/diagnostico-form.css}">
</head>
<body th:replace="layout/layout :: layout('Mi Diagnóstico', ~{::section})">
<section th:fragment="section">
<div class="container py-4">
    <h2 class="mb-4">Mi Diagnóstico</h2>
    <div th:if="${mensajeObligatorio}" class="alert alert-warning d-flex align-items-center" role="alert" style="font-size:1.1rem;">
        <i class="fa-solid fa-triangle-exclamation me-2"></i>
        <span th:text="${mensajeObligatorio}"></span>
    </div>
    <form th:action="@{/diagnostico/crear}" method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
         <!-- Obligatorios -->
        <div class="categoria">
            <div class="categoria-titulo">Datos físicos <span class="badge bg-danger">Obligatorio</span></div>
            <div class="row g-3 align-items-end">
                <div class="col-md-12">
                    <label for="objetivo" class="form-label">¿Cuál es tu objetivo?</label>
                    <textarea class="form-control" id="objetivo" name="objetivo" rows="2" required placeholder="Ej: Perder peso, ganar masa muscular, mejorar resistencia..."
                              th:text="${diagnosticoActual?.objetivo}"></textarea>
                    <small class="text-muted">Describe qué quieres lograr con tu entrenamiento.</small>
                    <div class="invalid-feedback">Este campo es obligatorio.</div>
                </div>
                <div class="col-md-4">
                    <label for="peso" class="form-label">Peso (kg)</label>
                    <input type="number" step="0.1" min="30" max="300" class="form-control" id="peso" name="peso" th:value="${diagnosticoActual?.peso}" required placeholder="Ej: 70.5">
                    <small class="text-muted">Ingrese su peso actual en kilogramos.</small>
                    <div class="invalid-feedback">Este campo es obligatorio.</div>
                </div>
                <div class="col-md-4">
                    <label for="estatura" class="form-label">Estatura (cm)</label>
                    <input type="number" step="0.1" min="100" max="250" class="form-control" id="estatura" name="estatura" th:value="${diagnosticoActual?.estatura}" required placeholder="Ej: 175">
                    <small class="text-muted">Ingrese su estatura en centímetros.</small>
                    <div class="invalid-feedback">Este campo es obligatorio.</div>
                </div>
                <div class="col-md-4">
                    <div id="imcBox" class="imc-box">IMC: <span id="imcValue">--</span></div>
                    <small class="text-muted">El IMC se calcula automáticamente.</small>
                </div>
                <div class="col-md-4">
                    <label for="nivelExperiencia" class="form-label">Nivel de experiencia</label>
                    <select class="form-select" id="nivelExperiencia" name="nivelExperiencia" required>
                        <option value="">Seleccione...</option>
                        <option th:selected="${diagnosticoActual?.nivelExperiencia == 'PRINCIPIANTE'}" value="PRINCIPIANTE">Principiante</option>
                        <option th:selected="${diagnosticoActual?.nivelExperiencia == 'INTERMEDIO'}" value="INTERMEDIO">Intermedio</option>
                        <option th:selected="${diagnosticoActual?.nivelExperiencia == 'AVANZADO'}" value="AVANZADO">Avanzado</option>
                    </select>
                    <small class="text-muted">Seleccione su nivel de experiencia física.</small>
                    <div class="invalid-feedback">Este campo es obligatorio.</div>
                </div>
                <div class="col-md-4">
                    <label for="disponibilidadTiempo" class="form-label">Disponibilidad de tiempo</label>
                    <input type="text" class="form-control" id="disponibilidadTiempo" name="disponibilidadTiempo" th:value="${diagnosticoActual?.disponibilidadTiempo}" required placeholder="Ej: 3 veces por semana, 45 min">
                    <small class="text-muted">Ejemplo: 3 veces por semana, 45 min.</small>
                    <div class="invalid-feedback">Este campo es obligatorio.</div>
                </div>
                <div class="col-md-4">
                    <label for="accesoRecursos" class="form-label">Acceso a recursos</label>
                    <input type="text" class="form-control" id="accesoRecursos" name="accesoRecursos" th:value="${diagnosticoActual?.accesoRecursos}" required placeholder="Ej: casa, gimnasio, pesas">
                    <small class="text-muted">Ejemplo: casa, gimnasio, pesas.</small>
                    <div class="invalid-feedback">Este campo es obligatorio.</div>
                </div>
                <div class="col-md-4">
                    <label for="lesiones" class="form-label">Lesiones</label>
                    <input type="text" class="form-control" id="lesiones" name="lesiones" th:value="${diagnosticoActual?.lesiones}" required placeholder="Ej: ninguna, rodilla, espalda">
                    <small class="text-muted">Indique si tiene alguna lesión relevante.</small>
                    <div class="invalid-feedback">Este campo es obligatorio.</div>
                </div>
                <div class="col-md-4">
                    <label for="condicionesMedicas" class="form-label">Condiciones médicas</label>
                    <input type="text" class="form-control" id="condicionesMedicas" name="condicionesMedicas" th:value="${diagnosticoActual?.condicionesMedicas}" required placeholder="Ej: hipertensión, diabetes">
                    <small class="text-muted">Indique si tiene alguna condición médica relevante.</small>
                    <div class="invalid-feedback">Este campo es obligatorio.</div>
                </div>
                 <div class="col-md-4">
                    <label for="horasSueno" class="form-label">Horas de sueño</label>
                    <input type="number" step="0.1" min="0" max="24" class="form-control" id="horasSueno" name="horasSueno" th:value="${diagnosticoActual?.horasSueno}" required placeholder="Ej: 8">
                    <small class="text-muted">Ingrese el promedio de horas de sueño diarias.</small>
                    <div class="invalid-feedback">Este campo es obligatorio.</div>
                </div>
                <div class="col-md-4">
                    <label for="habitosAlimenticios" class="form-label">Hábitos Alimenticios</label>
                    <input type="text" class="form-control" id="habitosAlimenticios" name="habitosAlimenticios" th:value="${diagnosticoActual?.habitosAlimenticios}" required placeholder="Ej: dieta balanceada, vegetariano">
                    <small class="text-muted">Describa brevemente su alimentación.</small>
                    <div class="invalid-feedback">Este campo es obligatorio.</div>
                </div>
            </div>
        </div>

        <!-- FOTOS OBLIGATORIAS -->
        <div class="categoria">
            <div class="categoria-titulo">Fotos del Diagnóstico <span class="badge bg-danger">Obligatorio</span></div>
            <small class="text-muted d-block mb-3">
                📸 Las 3 fotos son obligatorias para crear tu diagnóstico. Sube cualquier imagen desde tu PC (máx. 10MB cada una)
            </small>
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="fotoFrontal" class="form-label">
                        <i class="fas fa-camera"></i> Foto Frontal *
                    </label>
                    <input type="file"
                           class="form-control"
                           id="fotoFrontal"
                           name="fotoFrontal"
                           accept="image/*"
                           required
                           onchange="previewImage(this, 'preview-frontal')">
                    <small class="text-muted">Foto de frente, posición relajada</small>
                    <div class="mt-2">
                        <img id="preview-frontal" src="" alt="Preview" style="max-width: 100%; max-height: 200px; display: none; border-radius: 8px; border: 2px solid #ddd;">
                    </div>
                </div>
                <div class="col-md-4">
                    <label for="fotoLateral" class="form-label">
                        <i class="fas fa-camera"></i> Foto Lateral *
                    </label>
                    <input type="file"
                           class="form-control"
                           id="fotoLateral"
                           name="fotoLateral"
                           accept="image/*"
                           required
                           onchange="previewImage(this, 'preview-lateral')">
                    <small class="text-muted">Foto de perfil lateral</small>
                    <div class="mt-2">
                        <img id="preview-lateral" src="" alt="Preview" style="max-width: 100%; max-height: 200px; display: none; border-radius: 8px; border: 2px solid #ddd;">
                    </div>
                </div>
                <div class="col-md-4">
                    <label for="fotoTrasera" class="form-label">
                        <i class="fas fa-camera"></i> Foto Trasera *
                    </label>
                    <input type="file"
                           class="form-control"
                           id="fotoTrasera"
                           name="fotoTrasera"
                           accept="image/*"
                           required
                           onchange="previewImage(this, 'preview-trasera')">
                    <small class="text-muted">Foto de espalda</small>
                    <div class="mt-2">
                        <img id="preview-trasera" src="" alt="Preview" style="max-width: 100%; max-height: 200px; display: none; border-radius: 8px; border: 2px solid #ddd;">
                    </div>
                </div>
            </div>
        </div>

        <!-- Opcionales -->
        <div class="categoria">
            <div class="categoria-titulo">Datos adicionales <span class="badge bg-info">Opcional</span></div>
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="porcentajeGrasaCorporal" class="form-label">% Grasa Corporal</label>
                    <input type="number" step="0.1" min="0" max="100" class="form-control" id="porcentajeGrasaCorporal" name="porcentajeGrasaCorporal" th:value="${diagnosticoActual?.porcentajeGrasaCorporal}" placeholder="Ej: 18.5">
                    <small class="text-muted">Porcentaje estimado de grasa corporal.</small>
                </div>
                <div class="col-md-4">
                    <label for="circunferenciaCintura" class="form-label">Circunferencia Cintura (cm)</label>
                    <input type="number" step="0.1" min="0" class="form-control" id="circunferenciaCintura" name="circunferenciaCintura" th:value="${diagnosticoActual?.circunferenciaCintura}" placeholder="Ej: 80">
                    <small class="text-muted">Medida de la cintura en centímetros.</small>
                </div>
                <div class="col-md-4">
                    <label for="circunferenciaCadera" class="form-label">Circunferencia Cadera (cm)</label>
                    <input type="number" step="0.1" min="0" class="form-control" id="circunferenciaCadera" name="circunferenciaCadera" th:value="${diagnosticoActual?.circunferenciaCadera}" placeholder="Ej: 95">
                    <small class="text-muted">Medida de la cadera en centímetros.</small>
                </div>
                <div class="col-md-4">
                    <label for="circunferenciaBrazo" class="form-label">Circunferencia Brazo (cm)</label>
                    <input type="number" step="0.1" min="0" class="form-control" id="circunferenciaBrazo" name="circunferenciaBrazo" th:value="${diagnosticoActual?.circunferenciaBrazo}" placeholder="Ej: 32">
                    <small class="text-muted">Medida del brazo en centímetros.</small>
                </div>
                <div class="col-md-4">
                    <label for="circunferenciaPierna" class="form-label">Circunferencia Pierna (cm)</label>
                    <input type="number" step="0.1" min="0" class="form-control" id="circunferenciaPierna" name="circunferenciaPierna" th:value="${diagnosticoActual?.circunferenciaPierna}" placeholder="Ej: 40">
                    <small class="text-muted">Medida de la pierna en centímetros.</small>
                </div>
                <div class="col-md-4">
                    <label for="frecuenciaCardiacaReposo" class="form-label">Frecuencia Cardíaca Reposo (bpm)</label>
                    <input type="number" min="30" max="200" class="form-control" id="frecuenciaCardiacaReposo" name="frecuenciaCardiacaReposo" th:value="${diagnosticoActual?.frecuenciaCardiacaReposo}" placeholder="Ej: 70">
                    <small class="text-muted">Latidos por minuto en reposo.</small>
                </div>
                <div class="col-md-4">
                    <label for="presionArterial" class="form-label">Presión Arterial</label>
                    <input type="text" class="form-control" id="presionArterial" name="presionArterial" th:value="${diagnosticoActual?.presionArterial}" placeholder="Ej: 120/80">
                    <small class="text-muted">Ejemplo: 120/80.</small>
                </div>
            </div>
        </div>

        <!-- Informacion para el Entrenador (OPCIONAL) -->
        <div class="categoria">
            <div class="categoria-titulo">Informacion para tu Entrenador <span class="badge bg-info">Opcional</span></div>
            <small class="text-muted d-block mb-3">
                💡 Esta informacion ayudara a tu entrenador a disenar la mejor rutina para ti
            </small>
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="preferenciasEntrenamiento" class="form-label">Preferencias de Entrenamiento</label>
                    <textarea class="form-control" id="preferenciasEntrenamiento" name="preferenciasEntrenamiento" rows="2" th:text="${diagnosticoActual?.preferenciasEntrenamiento}" placeholder="Ej: Prefiero ejercicios funcionales, me gusta variar, no me gusta correr"></textarea>
                    <small class="text-muted">¿Que tipo de ejercicios prefieres o disfrutas mas?</small>
                </div>
                <div class="col-md-6">
                    <label for="experienciaPreviaDeportes" class="form-label">Experiencia Previa en Deportes</label>
                    <textarea class="form-control" id="experienciaPreviaDeportes" name="experienciaPreviaDeportes" rows="2" th:text="${diagnosticoActual?.experienciaPreviaDeportes}" placeholder="Ej: Jugue futbol 5 anos, natacion 2 anos"></textarea>
                    <small class="text-muted">¿Has practicado deportes antes? ¿Cuales y por cuanto tiempo?</small>
                </div>
                <div class="col-md-4">
                    <label for="diasDisponiblesSemana" class="form-label">Dias Disponibles por Semana</label>
                    <input type="number" min="1" max="7" class="form-control" id="diasDisponiblesSemana" name="diasDisponiblesSemana" th:value="${diagnosticoActual?.diasDisponiblesSemana}" placeholder="Ej: 4">
                    <small class="text-muted">¿Cuantos dias a la semana puedes entrenar?</small>
                </div>
                <div class="col-md-4">
                    <label for="horarioPreferido" class="form-label">Horario Preferido</label>
                    <input type="text" class="form-control" id="horarioPreferido" name="horarioPreferido" th:value="${diagnosticoActual?.horarioPreferido}" placeholder="Ej: Mananas 6am-8am">
                    <small class="text-muted">¿En que horario prefieres entrenar?</small>
                <div class="col-md-4">
            </div>
                    <label for="nivelEstres" class="form-label">Nivel de Estres</label>
                    <select class="form-select" id="nivelEstres" name="nivelEstres">
                        <option value="">Seleccionar...</option>
                        <option th:selected="${diagnosticoActual?.nivelEstres == 'BAJO'}" value="BAJO">Bajo</option>
                        <option th:selected="${diagnosticoActual?.nivelEstres == 'MEDIO'}" value="MEDIO">Medio</option>
                        <option th:selected="${diagnosticoActual?.nivelEstres == 'ALTO'}" value="ALTO">Alto</option>
                    </select>
                    <small class="text-muted">¿Como es tu nivel de estres diario?</small>
                </div>
                <div class="col-md-6">
                    <label for="limitacionesFisicas" class="form-label">Limitaciones Fisicas</label>
                    <textarea class="form-control" id="limitacionesFisicas" name="limitacionesFisicas" rows="2" th:text="${diagnosticoActual?.limitacionesFisicas}" placeholder="Ej: No puedo hacer sentadillas profundas por problema de rodilla"></textarea>
                    <small class="text-muted">¿Hay algun movimiento o ejercicio que no puedas hacer?</small>
                </div>
                <div class="col-md-6">
                    <label for="motivacionPrincipal" class="form-label">Motivacion Principal</label>
                    <textarea class="form-control" id="motivacionPrincipal" name="motivacionPrincipal" rows="2" th:text="${diagnosticoActual?.motivacionPrincipal}" placeholder="Ej: Mejorar mi salud, verme mejor, competir"></textarea>
                    <small class="text-muted">¿Que te motiva a entrenar?</small>
                </div>
                <div class="col-md-6">
                    <label for="suplementosActuales" class="form-label">Suplementos Actuales</label>
                    <input type="text" class="form-control" id="suplementosActuales" name="suplementosActuales" th:value="${diagnosticoActual?.suplementosActuales}" placeholder="Ej: Proteina whey, creatina">
                    <small class="text-muted">¿Tomas algun suplemento actualmente?</small>
                </div>
                <div class="col-md-3">
                    <label for="fumador" class="form-label">¿Fumas?</label>
                    <select class="form-select" id="fumador" name="fumador">
                        <option value="">Seleccionar...</option>
                        <option th:selected="${diagnosticoActual?.fumador == false}" value="false">No</option>
                        <option th:selected="${diagnosticoActual?.fumador == true}" value="true">Si</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="consumeAlcohol" class="form-label">¿Consumes Alcohol?</label>
                    <select class="form-select" id="consumeAlcohol" name="consumeAlcohol">
        </div>
                        <option th:selected="${diagnosticoActual?.consumeAlcohol == false}" value="false">No</option>
                        <option th:selected="${diagnosticoActual?.consumeAlcohol == true}" value="true">Si</option>
                    </select>
                </div>
                <div class="col-md-6" th:if="${diagnosticoActual?.consumeAlcohol == true}">
                    <label for="frecuenciaAlcohol" class="form-label">Frecuencia de Consumo de Alcohol</label>
                    <input type="text" class="form-control" id="frecuenciaAlcohol" name="frecuenciaAlcohol" th:value="${diagnosticoActual?.frecuenciaAlcohol}" placeholder="Ej: 1 vez por semana, 2-3 veces/semana">
                    <small class="text-muted">¿Con que frecuencia consumes alcohol?</small>
                </div>
        <div class="col-12 text-end">
            <button type="submit" class="btn btn-primary">Guardar diagnóstico</button>
        </div>
            <button type="submit" class="btn btn-primary">Guardar diagnostico</button>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/diagnostico-form.js}"></// Funcion para mostrar preview de las imagenes
    function previewImage(input, previewId) {
        const file = input.files[0];
        const preview = document.getElementById(previewId);

        if (!file) {
            preview.style.display = 'none';
            return;
        }

        // Validar tamano (10MB maximo)
        const maxSize = 10 * 1024 * 1024;
        if (file.size > maxSize) {
            alert('La imagen es demasiado grande. El tamaño maximo es 10MB.\n\nTamaño actual: ' + (file.size / 1024 / 1024).toFixed(2) + 'MB');
            input.value = '';
            preview.style.display = 'none';
            return;
        }

        // Mostrar preview
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }

    // Validacion antes de enviar el formulario
    document.querySelector('form').addEventListener('submit', function(e) {
        const fotoFrontal = document.getElementById('fotoFrontal');
        const fotoLateral = document.getElementById('fotoLateral');
        const fotoTrasera = document.getElementById('fotoTrasera');

        if (!fotoFrontal.files.length || !fotoLateral.files.length || !fotoTrasera.files.length) {
            e.preventDefault();
            alert('Las 3 fotos son obligatorias:\n\n✓ Foto Frontal\n✓ Foto Lateral\n✓ Foto Trasera\n\nPor favor, sube todas las fotos antes de continuar.');
            return false;
        }
    });
</script>
</section>
</body>
</html>
