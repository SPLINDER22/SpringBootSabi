<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es" th:replace="~{layout/layout :: layout('Mi Suscripción', ~{::section})}">

<section th:fragment="section">
    <div class="container container-suscripcion">

        <!-- Header: título + botón historial (fuera del box) -->
        <div class="page-header">
            <h1 class="page-title">Mi Suscripción</h1>
            <div class="historial-global">
                <a th:href="@{/cliente/suscripcion/historial}" class="btn-outline">Ver historial de suscripciones</a>
            </div>
        </div>

        <div class="content-box">
            <!-- Si no hay suscripción activa -->
            <div th:if="${suscripcion == null}" class="alert alert-info">
                <h4>Aún no tienes una suscripción activa</h4>
                <p th:if="${cliente != null}">Cotiza un entrenador y recibe una rutina personalizada adaptada a tu
                    objetivo.</p>
                <a th:href="@{/cliente/listaEntrenadores}" class="btn btn-primary">Buscar entrenadores</a>
            </div>
            <!-- Contenido cuando hay suscripción: secciones ordenadas -->
            <div th:if="${suscripcion != null}" class="subscription-card">
                <!-- Panel izquierdo: entrenador -->
                <div class="left-col">
                    <img src="/img/entrenador.jpg"
                         th:src="${fotoEntrenador != null ? fotoEntrenador : '/img/entrenador.jpg'}"
                         alt="Foto Entrenador">
                    <!-- Contacto y acciones del entrenador -->
                    <div style="display:flex;flex-direction:column;align-items:center;margin-top:8px;">
                        <div class="name" th:text="${nombreEntrenador != null ? nombreEntrenador : 'Tu entrenador'}">
                            Entrenador
                        </div>
                        <div class="title">Entrenador</div>
                        <div class="contact"><i class="fas fa-phone-alt me-2" aria-hidden="true"></i>
                            <span th:text="${telefonoEntrenador != null ? telefonoEntrenador : 'No disponible'}">--</span>
                        </div>
                        <div class="contact"><i class="fas fa-envelope me-2" aria-hidden="true"></i>
                            <span th:text="${emailEntrenador != null ? emailEntrenador : 'No disponible'}">--</span>
                        </div>
                    </div>
                    <div class="btns" style="margin-top:8px;">
                        <a id="btnWhatsAppEntrenador" href="#"
                           class="btn-whatsapp" th:classappend="${telefonoEntrenador == null ? ' disabled' : ''}"
                           target="_blank" th:attr="data-telefono=${telefonoEntrenador}">
                            <i class="fab fa-whatsapp me-2" aria-hidden="true"></i>WhatsApp
                        </a>
                        <a th:href="${emailEntrenador != null ? 'mailto:' + emailEntrenador : '#'}" class="btn-email"
                           th:classappend="${emailEntrenador == null ? ' disabled' : ''}"><i class="fas fa-envelope me-2" aria-hidden="true"></i>Enviar un correo</a>
                    </div>
                </div>
                <div class="right-col centered">
                    <div class="subscription-header">
                        <div>
                            <div class="subscription-title">Resumen de tu suscripción</div>
                        </div>
                        <div class="badges">
                            <span class="badge bg-success"
                                  th:if="${suscripcion.estadoSuscripcion == T(com.sabi.sabi.entity.enums.EstadoSuscripcion).ACEPTADA}">ACEPTADA</span>
                            <span class="badge bg-info text-dark"
                                  th:if="${suscripcion.estadoSuscripcion == T(com.sabi.sabi.entity.enums.EstadoSuscripcion).COTIZADA}">COTIZADA</span>
                            <span class="badge bg-warning text-dark"
                                  th:if="${suscripcion.estadoSuscripcion == T(com.sabi.sabi.entity.enums.EstadoSuscripcion).PENDIENTE}">PENDIENTE</span>
                        </div>
                        <div class="estado-descripcion" th:if="${suscripcion != null}">
                            <p th:if="${suscripcion.estadoSuscripcion == T(com.sabi.sabi.entity.enums.EstadoSuscripcion).ACEPTADA and rutina != null and rutina.idEntrenador != null}">tu rutina esta pagada y ya tienes tu rutina asignada</p>
                            <p th:if="${suscripcion.estadoSuscripcion == T(com.sabi.sabi.entity.enums.EstadoSuscripcion).ACEPTADA and (rutina == null or rutina.idEntrenador == null)}">ya pagaste la suscripcion y estas a la espera de que tu entrenador te asigne tu rutina</p>
                            <p th:if="${suscripcion.estadoSuscripcion == T(com.sabi.sabi.entity.enums.EstadoSuscripcion).COTIZADA}">Tu entrenador ya te envio la cotizacion y esta a la espera de tu pago para continuar con el proceso</p>
                            <p th:if="${suscripcion.estadoSuscripcion == T(com.sabi.sabi.entity.enums.EstadoSuscripcion).PENDIENTE}">Tu entrenador esta revisando tu diagnostico y esta ajustando tu cotizacion</p>
                        </div>
                    </div>

                    <!-- Tarjeta resumen: Precio y Duración -->
                    <div class="subscription-summary">
                        <div class="info-inline">
                            <div class="item">
                                <span class="label">Precio</span>
                                <span class="value"
                                      th:text="${suscripcion.precio != null ? '$' + #numbers.formatDecimal(suscripcion.precio, 1, 'COMMA', 2, 'POINT') : 'Por Definirse'}">--</span>
                            </div>
                            <div class="item">
                                <span class="label">Duración</span>
                                <span class="value"
                                      th:text="${suscripcion.duracionSemanas != null ? suscripcion.duracionSemanas + ' semana(s)' : 'Por Definirse'}">--</span>
                            </div>
                        </div>
                        <div class="actions">
                            <form th:if="${suscripcion.estadoSuscripcion == T(com.sabi.sabi.entity.enums.EstadoSuscripcion).COTIZADA and suscripcion.idSuscripcion != null}"
                                  th:action="@{/suscripciones/pagar/{id}(id=${suscripcion.idSuscripcion})}"
                                  method="post">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <input type="hidden" name="redirectTo" value="/cliente/suscripcion" />
                                <button type="submit" class="btn-primary">Pagar</button>
                            </form>
                            <form id="formCancelarSuscripcion" th:if="${suscripcion != null and suscripcion.idSuscripcion != null and suscripcion.estadoSuscripcion != T(com.sabi.sabi.entity.enums.EstadoSuscripcion).RECHAZADA}"
                                  th:action="@{/cliente/suscripcion/cancelar/{id}(id=${suscripcion.idSuscripcion})}" method="post">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                <button type="submit" class="btn btn-danger">Cancelar</button>
                            </form>
                        </div>
                    </div>

                    <!-- Sección: información de la rutina -->
                    <div class="rutina-card">
                        <div class="header" th:if="${rutina != null}">
                            <div>
                                <div class="titulo" th:text="${rutina.nombre}">Nombre rutina</div>
                                <div class="small text-muted" th:text="${rutina.descripcion}">Descripción breve</div>
                            </div>
                            <div class="badges">
                                <span class="badge bg-success" th:if="${rutina.estadoRutina == 'ACTIVA'}">ACTIVA</span>
                                <span class="badge bg-warning"
                                      th:if="${rutina.estadoRutina == 'PENDIENTE'}">PENDIENTE</span>
                                <span class="badge bg-info" th:if="${rutina.estadoRutina == 'COTIZADA'}">COTIZADA</span>
                            </div>
                        </div>
                        <div th:if="${rutina == null}" class="descripcion">No tienes una rutina asignada todavía. Una
                            vez tu entrenador la asigne, aparecerá aquí.
                        </div>

                        <div class="progress-wrap" th:if="${rutina != null}">
                            <div class="progress">
                                <div class="progress-bar"
                                     th:style="${'width:' + (porcentajeCompletado != null ? porcentajeCompletado : 0) + '%;'}"></div>
                            </div>
                            <div class="progress-meta">
                                <div class="small text-muted"
                                     th:text="${diaActual != null ? ('Día ' + diaActual.numeroDia) : 'Sin día activo'}">
                                    Sin día activo
                                </div>
                                <div class="fw-bold"
                                     th:text="${porcentajeCompletado != null ? porcentajeCompletado + '%' : '0%'}">0%
                                </div>
                            </div>
                            <div class="small text-muted mt-1" th:if="${rutina.objetivo != null}"
                                 th:text="${'Objetivo: ' + rutina.objetivo}">Objetivo
                            </div>
                            <div class="small text-muted" th:if="${rutina.numeroSemanas != null}"
                                 th:text="${'Total semanas: ' + rutina.numeroSemanas}">Total semanas
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div> <!-- /.content-box -->
        <!-- Script de confirmación SweetAlert para cancelar suscripción -->
        <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function(){
            // Formatear número de WhatsApp con prefijo +57 para Colombia
            const btnWhatsApp = document.getElementById('btnWhatsAppEntrenador');
            if (btnWhatsApp) {
                const telefono = btnWhatsApp.getAttribute('data-telefono');
                if (telefono && telefono.trim() !== '') {
                    // Limpiar el número (eliminar espacios, guiones, paréntesis, etc.)
                    let numeroLimpio = telefono.replace(/[\s\-\(\)]/g, '');

                    // Si el número no empieza con +57, agregarlo
                    if (!numeroLimpio.startsWith('+57') && !numeroLimpio.startsWith('57')) {
                        // Si empieza con 0, quitarlo (ej: 0300 -> 300)
                        if (numeroLimpio.startsWith('0')) {
                            numeroLimpio = numeroLimpio.substring(1);
                        }
                        numeroLimpio = '57' + numeroLimpio;
                    } else if (numeroLimpio.startsWith('+57')) {
                        // Remover el + si ya lo tiene
                        numeroLimpio = numeroLimpio.substring(1);
                    }

                    // Crear el enlace de WhatsApp
                    btnWhatsApp.href = 'https://wa.me/' + numeroLimpio;
                } else {
                    btnWhatsApp.href = '#';
                }
            }

            // Confirmación para cancelar suscripción
            const formCancelar = document.getElementById('formCancelarSuscripcion');
            if(formCancelar){
                formCancelar.addEventListener('submit', function(e){
                    e.preventDefault();
                    Swal.fire({
                        title: '¿Cancelar suscripción?',
                        text: 'Esta acción detendrá el progreso y tendrás que solicitar de nuevo si deseas continuar más adelante.',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#dc3545',
                        cancelButtonColor: '#6c757d',
                        confirmButtonText: 'Sí, cancelar',
                        cancelButtonText: 'No, volver'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            formCancelar.submit();
                        }
                    });
                });
            }
        });
        </script>
    </div> <!-- /.container-suscripcion -->
</section>
</html>
