<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Mi Suscripción</title>
    <style>
        /* Colores: cobalto principal y verde secundario */
        :root{
            --cobalt: #0047AB;
            --accent-green: #00B894;
            --muted: #64748B;
            --card-bg: #ffffff;
        }
        .subscription-card{
            border-radius:18px;
            overflow:hidden;
            box-shadow: 0 10px 30px rgba(2,6,23,0.12);
            border: 1px solid rgba(0,71,171,0.06);
            background: linear-gradient(180deg, rgba(0,71,171,0.03), rgba(0,71,171,0.01));
        }
        .subscription-card .left-col{
            background: linear-gradient(180deg,var(--cobalt), rgba(0,71,171,0.95));
            color: #fff;
            padding: 28px;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            min-width:260px;
        }
        .subscription-card .left-col img{border:4px solid rgba(255,255,255,0.18);}
        .subscription-card .right-col{padding:22px;}
        .subscription-title{font-weight:800;color:var(--cobalt);letter-spacing:0.2px}
        .small-muted{color:var(--muted);font-size:.95rem}
        .kpi{background:#f7fbff;padding:12px;border-radius:12px;margin-bottom:10px;border:1px solid rgba(0,71,171,0.04)}
        .cta-btn{border-radius:10px;padding:10px 16px}
        .progress-bar.bg-accent{background: linear-gradient(90deg,var(--accent-green), #00d084);}
        .info-label{font-size:.95rem;color:#0f172a;font-weight:600}
        .info-desc{font-size:.9rem;color:var(--muted)}
        @media (max-width: 991px){
            .subscription-card{flex-direction:column}
            .subscription-card .left-col{min-width:100%;padding:18px}
            .subscription-card .right-col{padding:16px}
        }
    </style>
</head>

<body th:replace="layout/layout :: layout('suscripcion actual', ~{::section})">
<section th:fragment="section">
    <div class="container">
        <div class="row justify-content-center">

            <!-- Si no hay suscripción -->
            <div th:if="${suscripcion == null}" class="col-12 col-lg-10">
                <div class="alert alert-info text-center rounded-4 py-4">
                    <h4 class="mb-2">Aún no tienes una suscripción activa</h4>
                    <p class="mb-3 small-muted">Solicita un entrenador y recibe un plan personalizado adaptado a tu objetivo.</p>
                    <a th:href="@{/cliente/listaEntrenadores}" class="btn btn-primary">Buscar entrenadores</a>
                </div>
            </div>

            <!-- Suscripción: tarjeta horizontal mejorada -->
            <div th:if="${suscripcion != null}" class="col-12 col-lg-11">
                <div class="d-flex subscription-card">
                    <!-- LEFT: foto + contacto + historial integrado -->
                    <div class="left-col text-center">
                        <img src="/img/entrenador.jpg" th:src="${fotoEntrenador != null ? fotoEntrenador : '/img/entrenador.jpg'}" alt="Foto Entrenador" class="rounded-circle mb-3" style="width:120px;height:120px;object-fit:cover;">
                        <h4 class="mb-0" th:text="${nombreEntrenador} ?: 'Tu entrenador'">Entrenador</h4>
                        <p class="small-muted mb-3" th:text="${suscripcion.estadoSuscripcion}">Estado</p>

                        <div class="d-flex gap-2">
                            <a th:href="${telefonoEntrenador != null ? 'https://wa.me/' + telefonoEntrenador : '#'}" target="_blank" class="btn btn-light btn-sm cta-btn" th:classappend="${telefonoEntrenador == null ? ' disabled' : ''}">
                                <i class="fab fa-whatsapp text-success me-1"></i> WhatsApp
                            </a>
                            <a th:href="${emailEntrenador != null ? 'mailto:' + emailEntrenador : '#'}" class="btn btn-light btn-sm cta-btn" th:classappend="${emailEntrenador == null ? ' disabled' : ''}">
                                <i class="fas fa-envelope text-primary me-1"></i> Email
                            </a>
                        </div>

                        <div class="mt-3 w-100">
                            <!-- Botón de ver perfil eliminado por diseño simplificado -->
                            <div style="height:0.5rem"></div>
                        </div>

                        <!-- Botón historial integrado -->
                        <div class="mt-3 w-100">
                            <a th:href="@{/cliente/suscripcion/historial}" class="btn btn-white w-100" style="background:transparent;border:2px solid rgba(255,255,255,0.12);color:#fff;">Historial de suscripciones</a>
                        </div>
                    </div>

                    <!-- RIGHT: contenido principal: detalles suscripción + rutina + acciones -->
                    <div class="right-col flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h2 class="subscription-title mb-1">Resumen de tu suscripción</h2>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-success" th:if="${suscripcion.estadoSuscripcion == 'ACEPTADA'}">ACEPTADA</span>
                                <span class="badge bg-info text-dark" th:if="${suscripcion.estadoSuscripcion == 'COTIZADA'}">COTIZADA</span>
                                <span class="badge bg-warning text-dark" th:if="${suscripcion.estadoSuscripcion == 'PENDIENTE'}">PENDIENTE</span>
                            </div>
                        </div>

                        <!-- Explicación concisa del estado -->
                        <div class="mb-3">
                            <div th:if="${suscripcion.estadoSuscripcion == 'PENDIENTE'}" class="info-desc">Pendiente: Tu entrenador está revisando tu cotización y te dará un precio pronto.</div>
                            <div th:if="${suscripcion.estadoSuscripcion == 'COTIZADA'}" class="info-desc">Cotizada: Tu entrenador ya te asignó un precio; ahora puedes pagar para iniciar tu suscripción.</div>
                            <div th:if="${suscripcion.estadoSuscripcion == 'ACEPTADA' and !tieneRutinaActiva}" class="info-desc">Aceptada: Tu suscripción ya fue pagada y estás a la espera de tu rutina.</div>
                            <div th:if="${suscripcion.estadoSuscripcion == 'ACEPTADA' and tieneRutinaActiva}" class="info-desc">Aceptada + Rutina asignada: Tu suscripción está pagada y ya cuentas con una rutina activa.</div>
                        </div>

                        <div class="row">
                            <div class="col-12 col-md-6">
                                <div class="kpi mb-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="info-label">Precio</div>
                                            <!-- texto reducido: solo etiqueta -->
                                        </div>
                                        <div class="text-end">
                                            <div class="fw-semibold fs-5" th:text="${suscripcion.precio != null ? '$' + #numbers.formatDecimal(suscripcion.precio, 1, 'COMMA', 2, 'POINT') : 'Por Definirse'}">--</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="kpi mb-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="info-label">Duración</div>
                                            <!-- texto reducido: solo etiqueta -->
                                        </div>
                                        <div class="text-end">
                                            <div class="fw-semibold" th:text="${suscripcion.duracionSemanas != null ? suscripcion.duracionSemanas + ' semana(s)' : 'Por Definirse'}">--</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="kpi">
                                    <div class="info-label">Detalles de la rutina</div>
                                     <div th:if="${tieneRutinaActiva}">
                                         <div class="fw-semibold" th:text="${rutina.nombre}">Nombre rutina</div>
                                        <div class="small text-muted" th:text="${rutina.descripcion}">Descripción breve</div>
                                     </div>
                                     <div th:unless="${tieneRutinaActiva}">
                                        <div class="small-muted">No hay rutina activa todavía.</div>
                                     </div>
                                 </div>
                             </div>

                             <div class="col-12 col-md-6">
                                 <!-- Rutina: sección separada y centrada en progreso -->
                                <div class="card p-3 mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <div class="info-label">Progreso</div>
                                        </div>
                                        <div>
                                            <a th:href="@{/cliente/rutinas}" class="btn btn-outline-primary btn-sm">Ver progreso de rutina</a>
                                        </div>
                                    </div>
                                    <div class="progress mb-3" style="height:18px;border-radius:12px;background:#e6f2ff;">
                                        <div class="progress-bar bg-accent" role="progressbar" style="border-radius:12px;width:0%;" th:style="${'width:' + (porcentajeCompletado != null ? porcentajeCompletado : 0) + '%;'}" th:text="${porcentajeCompletado != null ? porcentajeCompletado + '%' : '0%'}"></div>
                                    </div>
                                    <div>
                                        <div class="info-label">Día actual</div>
                                        <div class="info-desc" th:text="${diaActual != null ? ('Semana ' + diaActual.semana.numeroSemana + ' · Día ' + diaActual.numeroDia) : 'Sin día activo'}">--</div>
                                    </div>
                                </div>

                                <!-- Acciones rápidas: pagar / cancelar -->
                                <div class="d-flex gap-2">
                                    <form th:if="${suscripcion.estadoSuscripcion == T(com.sabi.sabi.entity.enums.EstadoSuscripcion).COTIZADA}" th:action="@{/suscripciones/pagar/{id}(id=${suscripcion.idSuscripcion})}" method="post">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                        <button type="submit" class="btn" style="background:var(--accent-green);color:#fff;border-radius:12px;padding:10px 18px;font-weight:700;">Pagar</button>
                                    </form>

                                    <form th:if="${suscripcion.estadoSuscripcion != 'RECHAZADA'}" th:action="@{/cliente/suscripcion/cancelar/{id}(id=${suscripcion.idSuscripcion})}" method="post">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                        <button type="submit" class="btn btn-outline-secondary" style="border-radius:12px;padding:10px 18px;">Cancelar</button>
                                    </form>
                                </div>
                            </div>

                        </div>

                    </div>
                </div>
            </div>

        </div>
    </div>
</section>
</body>

</html>