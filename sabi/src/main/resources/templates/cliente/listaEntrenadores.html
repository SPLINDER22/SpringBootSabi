<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Lista De Entrenadores</title>
</head>

<body th:replace="layout/layout :: layout('Lista de entrenadores', ~{::section})">
<section th:fragment="section">
    <div class="page-entrenadores">
        <!-- Panel de filtros ampliado -->
        <div class="filters-panel">
            <h1 class="h3 mb-3 text-dark text-center">Entrenadores Disponibles</h1>

            <!-- ========================================
                  RECOMENDACIN BASADA EN OBJETIVO
                 ======================================== -->
            <div th:if="${mostrarRecomendacion != null && mostrarRecomendacion && especialidadRecomendada != null}"
                 class="alert alert-info alert-dismissible fade show"
                 style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border: none;
                        color: white;
                        border-radius: 12px;
                        padding: 20px;
                        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
                        margin-bottom: 20px;">
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="font-size: 3rem;"></div>
                    <div>
                        <h5 style="margin: 0 0 8px 0; font-weight: bold; color: white;">
                            <i class="fas fa-lightbulb"></i> Recomendaci贸n Personalizada
                        </h5>
                        <p style="margin: 0; font-size: 0.95rem; line-height: 1.6;">
                            Seg煤n tu objetivo <strong>"<span th:text="${objetivoCliente}"></span>"</strong>,
                            te recomendamos entrenadores especializados en
                            <strong><span th:text="${especialidadRecomendada}"></span></strong>.
                            <br>
                            <small style="opacity: 0.9;">
                                 Puedes cambiar a <strong>"Todas"</strong> en el filtro de especialidad para ver todos los entrenadores.
                            </small>
                        </p>
                    </div>
                </div>
            </div>

            <form th:action="@{/cliente/listaEntrenadores}" method="get">
                <div class="filters-grid">
                    <!-- Nombre -->
                    <div>
                        <label for="inputNombre">Nombre</label>
                        <input id="inputNombre" type="text" name="nombre" class="form-control"
                               placeholder="Buscar por nombre" th:value="${nombre}">
                    </div>
                    <!-- Especialidad -->
                    <div>
                        <label for="inputEspecialidad">Especialidad</label>
                        <select id="inputEspecialidad" name="especialidad" class="form-select">
                            <option value="">Todas</option>
                            <option value="Fuerza y Acondicionamiento"
                                    th:selected="${especialidad == 'Fuerza y Acondicionamiento'}">Fuerza y Acondicionamiento
                            </option>
                            <option value="P茅rdida de Peso" th:selected="${especialidad == 'P茅rdida de Peso'}">P茅rdida de
                                Peso
                            </option>
                            <option value="Ganancia Muscular" th:selected="${especialidad == 'Ganancia Muscular'}">Ganancia
                                Muscular
                            </option>
                            <option value="Yoga" th:selected="${especialidad == 'Yoga'}">Yoga</option>
                            <option value="Pilates" th:selected="${especialidad == 'Pilates'}">Pilates</option>
                            <option value="CrossFit" th:selected="${especialidad == 'CrossFit'}">CrossFit</option>
                            <option value="Entrenamiento Funcional"
                                    th:selected="${especialidad == 'Entrenamiento Funcional'}">Entrenamiento Funcional
                            </option>
                            <option value="Cardio y Resistencia"
                                    th:selected="${especialidad == 'Cardio y Resistencia'}">Cardio y Resistencia
                            </option>
                            <option value="Deportes Espec铆ficos"
                                    th:selected="${especialidad == 'Deportes Espec铆ficos'}">Deportes Espec铆ficos
                            </option>
                            <option value="Rehabilitaci贸n" th:selected="${especialidad == 'Rehabilitaci贸n'}">Rehabilitaci贸n
                            </option>
                            <option value="Nutrici贸n Deportiva" th:selected="${especialidad == 'Nutrici贸n Deportiva'}">Nutrici贸n
                                Deportiva
                            </option>
                            <option value="Entrenamiento Personal" th:selected="${especialidad == 'Entrenamiento Personal'}">
                                Entrenamiento Personal
                            </option>
                            <option value="Powerlifting" th:selected="${especialidad == 'Powerlifting'}">Powerlifting
                            </option>
                            <option value="Calistenia" th:selected="${especialidad == 'Calistenia'}">Calistenia</option>
                            <option value="Running" th:selected="${especialidad == 'Running'}">Running</option>
                            <option value="Ciclismo" th:selected="${especialidad == 'Ciclismo'}">Ciclismo</option>
                            <option value="Nataci贸n" th:selected="${especialidad == 'Nataci贸n'}">Nataci贸n</option>
                            <option value="Boxeo" th:selected="${especialidad == 'Boxeo'}">Boxeo</option>
                            <option value="Artes Marciales" th:selected="${especialidad == 'Artes Marciales'}">Artes
                                Marciales
                            </option>
                            <option value="Movilidad y Flexibilidad"
                                    th:selected="${especialidad == 'Movilidad y Flexibilidad'}">Movilidad y Flexibilidad
                            </option>
                        </select>
                    </div>
                    <!-- Puntuaci贸n m铆nima -->
                    <div>
                        <label for="inputMinPuntuacion">Puntuaci贸n m铆n.</label>
                        <input id="inputMinPuntuacion" type="number" name="minPuntuacion" class="form-control" min="0"
                               max="5" step="0.1" th:value="${minPuntuacion}">
                    </div>
                    <!-- Puntuaci贸n m谩xima -->
                    <div>
                        <label for="inputMaxPuntuacion">Puntuaci贸n m谩x.</label>
                        <input id="inputMaxPuntuacion" type="number" name="maxPuntuacion" class="form-control" min="0"
                               max="5" step="0.1" th:value="${maxPuntuacion}">
                    </div>
                    <!-- Experiencia m铆nima -->
                    <div>
                        <label for="inputMinExperiencia">Experiencia m铆n.</label>
                        <input id="inputMinExperiencia" type="number" name="minExperiencia" class="form-control" min="0"
                               max="50" th:value="${minExperiencia}" placeholder="A帽os">
                    </div>
                    <!-- Precio m铆nimo -->
                    <div>
                        <label for="inputMinPrecio">Precio m铆n.</label>
                        <input id="inputMinPrecio" type="number" name="minPrecio" class="form-control" min="0"
                               step="1000" th:value="${minPrecio}" placeholder="COP">
                    </div>
                    <!-- Precio m谩ximo -->
                    <div>
                        <label for="inputMaxPrecio">Precio m谩x.</label>
                        <input id="inputMaxPrecio" type="number" name="maxPrecio" class="form-control" min="0"
                               step="1000" th:value="${maxPrecio}" placeholder="COP">
                    </div>
                    <!-- Certificaciones -->
                    <div class="span-2" style="grid-column:span 2;">
                        <label for="inputCertificaciones">Certificaciones</label>
                        <input id="inputCertificaciones" type="text" name="certificaciones" class="form-control"
                               placeholder="Ej: ACE, NASM" th:value="${certificaciones}">
                    </div>
                </div>
                <div class="filters-actions justify-content-center mt-3">
                    <button class="btn btn-primary btn-search-wide" type="submit"><i class="fas fa-search me-1"></i>
                        Buscar
                    </button>
                    <a class="btn btn-outline-secondary btn-search-wide" th:href="@{/cliente/listaEntrenadores}"><i
                            class="fas fa-eraser me-1"></i> Limpiar</a>
                </div>
            </form>
        </div>

        <!-- Grid de entrenadores -->
        <div class="entrenadores-grid-wrapper" th:if="${!#lists.isEmpty(entrenadores)}">
            <div class="entrenadores-grid">
                <th:block th:each="entrenador : ${entrenadores}">
                    <div class="trainer-card">
                        <div class="trainer-header">
                            <div class="trainer-avatar-wrapper">
                                <div class="ring">
                                    <img class="trainer-avatar" src="/img/fotoPerfil.png"
                                         th:src="${entrenador.fotoPerfilUrl != null ? entrenador.fotoPerfilUrl : '/img/fotoPerfil.png'}"
                                         th:alt="|Foto de ${entrenador.nombre}|" alt="Foto"/>
                                </div>
                            </div>
                            <div class="trainer-name" th:text="|${entrenador.nombre} ${entrenador.apellido}|">Nombre
                                Apellido
                            </div>
                            <!-- Badge de verificaci贸n -->
                            <div th:if="${entrenador.verified}" class="text-center mb-2">
                                <span class="badge badge-success" 
                                      style="font-size: 0.9rem; padding: 0.4rem 0.8rem;"
                                      title="Entrenador verificado por SABI">
                                    <i class="fas fa-check-circle"></i> Verificado por SABI
                                </span>
                            </div>
                            <div class="trainer-rating"
                                 th:with="cal=${entrenador.calificacionPromedio} ?: 0, full=${T(java.lang.Math).floor(cal)}, frac=${cal - T(java.lang.Math).floor(cal)}">
                                <span class="rating-value" th:text="${#numbers.formatDecimal(cal,1,1)}">0.0</span>
                                <span th:each="i : ${#numbers.sequence(1,5)}">
                                    <i class="fas fa-star text-warning" th:if="${i <= full}"></i>
                                    <i class="fas fa-star-half-alt text-warning"
                                       th:if="${i == full + 1 and frac >= 0.5}"></i>
                                    <i class="far fa-star text-warning"
                                       th:if="${!(i <= full) and !(i == full + 1 and frac >= 0.5)}"></i>
                                </span>
                            </div>
                        </div>
                        <div class="trainer-footer">
                            <div class="trainer-meta">
                                <div class="trainer-meta-item">
                                    <h6>Especialidad Principal</h6>
                                    <!--  Mostrar solo la PRIMERA especialidad -->
                                    <span th:if="${entrenador.especialidades != null and !entrenador.especialidades.isEmpty()}"
                                          th:with="primeraEsp=${#strings.arraySplit(entrenador.especialidades, ',')[0]}"
                                          th:text="${primeraEsp}">
                                        Especialidad
                                    </span>
                                    <span th:if="${entrenador.especialidades == null or entrenador.especialidades.isEmpty()}"
                                          th:text="${entrenador.especialidad} ?: 'No especificado'">
                                        No especificado
                                    </span>
                                </div>
                                <div class="trainer-meta-item">
                                    <h6>Experiencia</h6>
                                    <span
                                        th:text="${entrenador.aniosExperiencia != null ? entrenador.aniosExperiencia + ' a帽os' : '0 a帽os'}">0
                                        a帽os
                                    </span>
                                </div>
                                <div class="trainer-meta-item" th:if="${entrenador.precioMinimo != null or entrenador.precioMaximo != null}">
                                    <h6>Precio sesi贸n</h6>
                                    <span th:if="${entrenador.precioMinimo != null and entrenador.precioMaximo != null}"
                                          th:text="${#numbers.formatDecimal(entrenador.precioMinimo, 0, 'COMMA', 0, 'POINT')} + ' - ' + ${#numbers.formatDecimal(entrenador.precioMaximo, 0, 'COMMA', 0, 'POINT')} + ' COP'">Rango</span>
                                    <span th:if="${entrenador.precioMinimo != null and entrenador.precioMaximo == null}"
                                          th:text="'Desde ' + ${#numbers.formatDecimal(entrenador.precioMinimo, 0, 'COMMA', 0, 'POINT')} + ' COP'">Desde</span>
                                    <span th:if="${entrenador.precioMinimo == null and entrenador.precioMaximo != null}"
                                          th:text="'Hasta ' + ${#numbers.formatDecimal(entrenador.precioMaximo, 0, 'COMMA', 0, 'POINT')} + ' COP'">Hasta</span>
                                </div>
                            </div>
                            <div class="trainer-actions">
                                <button type="button" class="btn-detalles btn-ver-info-entrenador"
                                        th:attr="data-entrenador-id=${entrenador.id}">
                                    <i class="fas fa-info-circle me-1"></i> Detalles
                                </button>
                                <form th:action="@{/entrenadores/solicitar/{idEntrenador}(idEntrenador=${entrenador.id})}"
                                      method="post" class="flex-grow-1">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <button type="submit" class="btn-cotizar w-100">
                                        <i class="fas fa-money-bill-wave me-1"></i> Cotizar
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </th:block>
            </div>
        </div>

        <!-- Mensaje cuando no hay entrenadores -->
        <div th:if="${#lists.isEmpty(entrenadores)}" class="alert alert-info text-center no-entrenadores-alert"
             role="alert">
            <strong>A煤n no hay entrenadores disponibles</strong><br>Cuando haya entrenadores, aqu铆 se mostrar谩n.
        </div>
    </div>

    <!-- Modal Info del Entrenador -->
    <div class="modal fade" id="modalInfoEntrenador" tabindex="-1" aria-labelledby="modalInfoEntrenadorLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="modalInfoEntrenadorLabel">
                        <i class="fas fa-user-tie me-2"></i> Informaci贸n del Entrenador
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 text-center mb-3">
                            <img id="modalEntrenadorFoto" src="/img/fotoPerfil.png" alt="Foto del entrenador"
                                 class="rounded-circle img-fluid"
                                 style="width: 150px; height: 150px; object-fit: cover; border: 4px solid #28a745;">
                            <h4 id="modalEntrenadorNombre" class="mt-3 mb-0">Nombre</h4>
                            <!-- Badge de verificaci贸n en modal -->
                            <div id="modalEntrenadorVerificado" style="display: none;" class="mt-2">
                                <span class="badge badge-success" style="font-size: 0.85rem;">
                                    <i class="fas fa-check-circle"></i> Verificado por SABI
                                </span>
                            </div>
                            <div class="rating-stars mt-2" id="modalEntrenadorEstrellas">
                                <span class="text-muted me-2" id="modalEntrenadorCalificacion">0.0</span>
                                <div id="modalEstrellas"></div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="mb-3">
                                <h6 class="text-success"><i class="fas fa-envelope me-2"></i> Email</h6>
                                <p id="modalEntrenadorEmail" class="text-muted"></p>
                            </div>
                            <div class="mb-3" id="modalEntrenadorGeneroContainer" style="display: none;">
                                <h6 class="text-success"><i class="fas fa-venus-mars me-2"></i> G茅nero</h6>
                                <p id="modalEntrenadorGenero" class="text-muted"></p>
                            </div>
                            <div class="mb-3">
                                <h6 class="text-success"><i class="fas fa-dumbbell me-2"></i> Especialidades</h6>
                                <p id="modalEntrenadorEspecialidades" class="text-muted"></p>
                            </div>
                            <div class="mb-3">
                                <h6 class="text-success"><i class="fas fa-calendar-alt me-2"></i> Experiencia</h6>
                                <p id="modalEntrenadorExperiencia" class="text-muted"></p>
                            </div>
                            <div class="mb-3" id="modalEntrenadorPrecioContainer" style="display: none;">
                                <h6 class="text-success"><i class="fas fa-dollar-sign me-2"></i> Precio por sesi贸n</h6>
                                <p id="modalEntrenadorPrecio" class="text-muted"></p>
                            </div>
                            <div class="mb-3" id="modalEntrenadorCertificacionesContainer" style="display: none;">
                                <h6 class="text-success"><i class="fas fa-certificate me-2"></i> Certificaciones</h6>
                                <div id="modalEntrenadorCertificaciones" class="text-muted">
                                    <!-- Lista de certificaciones con botones para ver -->
                                </div>
                            </div>
                            <div class="mb-3" id="modalEntrenadorTelefonoContainer" style="display: none;">
                                <h6 class="text-success"><i class="fas fa-phone me-2"></i> Tel茅fono</h6>
                                <p id="modalEntrenadorTelefono" class="text-muted"></p>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div id="modalEntrenadorDescripcionContainer" style="display: none;">
                        <h6 class="text-success"><i class="fas fa-comment-dots me-2"></i> Sobre el Entrenador</h6>
                        <p id="modalEntrenadorDescripcion" class="bg-light p-3 rounded"></p>
                    </div>
                    <div id="modalSinDescripcion" style="display: none;" class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i> El entrenador a煤n no ha agregado una descripci贸n
                        personal.
                    </div>

                    <!-- Secci贸n Comentarios -->
                    <div class="mb-3">
                        <h6 class="text-success mb-3"><i class="fas fa-comments me-2"></i> Opiniones de Clientes</h6>
                        <div id="comentariosLoader" class="text-center py-3" style="display:none;">
                            <div class="spinner-border text-success" role="status">
                                <span class="sr-only">Cargando...</span>
                            </div>
                            <p class="mt-2 mb-0 text-muted small">Cargando comentarios...</p>
                        </div>
                        <div id="comentariosError" class="alert alert-danger py-2 px-3" style="display:none;"></div>
                        <div id="comentariosVacio" class="alert alert-info py-2 px-3" style="display:none;">
                            <i class="fas fa-info-circle me-1"></i> A煤n no hay comentarios para este entrenador.
                        </div>
                        <div id="comentariosLista" class="comentarios-lista" style="max-height:300px; overflow-y:auto;">
                            <!-- Comentarios se insertan aqu铆 -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <form id="modalFormSolicitar" method="post" style="display: inline;">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-money-bill-wave me-1"></i> Cotizar Suscripci贸n
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Visualizar PDF -->
    <div class="modal fade" id="modalVisualizadorPDF" tabindex="-1" aria-labelledby="modalVisualizadorPDFLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="modalVisualizadorPDFLabel">
                        <i class="fas fa-file-pdf me-2"></i> <span id="pdfTitulo">Certificaci贸n</span>
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body p-0" style="height: 70vh;">
                    <iframe id="pdfViewer" style="width: 100%; height: 100%; border: none;"></iframe>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <a id="pdfDownloadLink" href="#" download class="btn btn-primary">
                        <i class="fas fa-download me-1"></i> Descargar PDF
                    </a>
                </div>
            </div>
        </div>
    </div>


    <script>
        // =========================================================
        // Funciones utilitarias (solo una vez, evitar duplicados)
        // =========================================================
        function abrirVisualizadorPDF(rutaPDF, nombreArchivo) {
            document.getElementById('pdfTitulo').textContent = nombreArchivo;
            document.getElementById('pdfViewer').src = rutaPDF;
            document.getElementById('pdfDownloadLink').href = rutaPDF;
            document.getElementById('pdfDownloadLink').download = nombreArchivo;
            if (window.jQuery && typeof jQuery.fn.modal === 'function') {
                jQuery('#modalVisualizadorPDF').modal('show');
            } else if (window.bootstrap && window.bootstrap.Modal) {
                window.bootstrap.Modal.getOrCreateInstance(document.getElementById('modalVisualizadorPDF')).show();
            }
        }

        function formatearFecha(fechaIso) {
            if (!fechaIso) return '';
            try {
                const d = new Date(fechaIso);
                if (isNaN(d.getTime())) return '';
                return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
            } catch (e) {
                return '';
            }
        }

        function construirEstrellas(valor) {
            if (valor == null || isNaN(valor)) return '<span class="text-muted small">Sin calificaci贸n</span>';
            const full = Math.floor(valor), frac = valor - full;
            let html = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= full) html += '<i class="fas fa-star text-warning"></i>';
                else if (i === full + 1 && frac >= 0.5) html += '<i class="fas fa-star-half-alt text-warning"></i>';
                else html += '<i class="far fa-star text-warning"></i>';
            }
            return `<span class="me-2 fw-semibold">${valor.toFixed(1)}</span>${html}`;
        }

        async function cargarComentariosEntrenador(id) {
            const loader = document.getElementById('comentariosLoader');
            const lista = document.getElementById('comentariosLista');
            const vacio = document.getElementById('comentariosVacio');
            const errorBox = document.getElementById('comentariosError');
            if (!loader || !lista) return; // seguridad
            loader.style.display = 'block';
            lista.innerHTML = '';
            vacio.style.display = 'none';
            errorBox.style.display = 'none';
            try {
                const resp = await fetch(`/api/cliente/entrenador/${id}/comentarios`, {credentials: 'same-origin'});
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const data = await resp.json();
                loader.style.display = 'none';
                if (!Array.isArray(data) || data.length === 0) {
                    vacio.style.display = 'block';
                    return;
                }
                const fragment = document.createDocumentFragment();
                data.forEach(c => {
                    const card = document.createElement('div');
                    card.className = 'comentario-item mb-3 p-3 rounded shadow-sm';
                    card.style.border = '1px solid #e3e6f0';
                    const header = `<div class="d-flex justify-content-between align-items-start mb-2"><div class="fw-semibold">${c.clienteNombre ? c.clienteNombre : 'Cliente'}</div><div class="text-end">${construirEstrellas(c.calificacion)}</div></div>`;
                    const cuerpo = `<p class="mb-2" style="white-space:pre-wrap;">${c.texto ? c.texto : '<span class=\"text-muted\">(Sin texto)</span>'}</p>`;
                    const pie = `<div class="text-muted small"><i class="far fa-clock me-1"></i>${formatearFecha(c.fechaCreacion)}</div>`;
                    card.innerHTML = header + cuerpo + pie;
                    fragment.appendChild(card);
                });
                lista.appendChild(fragment);
            } catch (err) {
                loader.style.display = 'none';
                errorBox.textContent = 'No se pudieron cargar los comentarios: ' + err.message;
                errorBox.style.display = 'block';
            }
        }

        function resetModal() {
            const estrellasVacias = '<i class="far fa-star text-warning"></i>'.repeat(5);
            const ids = ['modalEntrenadorFoto', 'modalEntrenadorNombre', 'modalEntrenadorEmail', 'modalEntrenadorEspecialidades', 'modalEntrenadorExperiencia', 'modalEntrenadorCalificacion', 'modalEstrellas', 'modalEntrenadorTelefono', 'modalEntrenadorDescripcion'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (id === 'modalEntrenadorFoto') el.src = '/img/fotoPerfil.png';
                    else if (id === 'modalEstrellas') el.innerHTML = estrellasVacias;
                    else el.textContent = '';
                }
            });
            ['modalEntrenadorTelefonoContainer', 'modalEntrenadorPrecioContainer', 'modalEntrenadorCertificacionesContainer', 'modalEntrenadorDescripcionContainer', 'modalSinDescripcion', 'modalEntrenadorGeneroContainer'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            const certs = document.getElementById('modalEntrenadorCertificaciones');
            if (certs) certs.innerHTML = '';
            const comLista = document.getElementById('comentariosLista');
            if (comLista) comLista.innerHTML = '';
            const comError = document.getElementById('comentariosError');
            if (comError) comError.style.display = 'none';
            const comVacio = document.getElementById('comentariosVacio');
            if (comVacio) comVacio.style.display = 'none';
            const loader = document.getElementById('comentariosLoader');
            if (loader) loader.style.display = 'none';
        }

        function mostrarModal() {
            const modal = document.getElementById('modalInfoEntrenador');
            if (window.jQuery && typeof jQuery.fn.modal === 'function') {
                jQuery(modal).modal('show');
            } else if (window.bootstrap && window.bootstrap.Modal) {
                window.bootstrap.Modal.getOrCreateInstance(modal).show();
            } else {
                modal.style.display = 'block';
            }
        }

        // =========================================================
        // Listener 煤nico para los botones Detalles
        // =========================================================
        document.querySelectorAll('.btn-ver-info-entrenador').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.preventDefault();
                const entrenadorId = btn.getAttribute('data-entrenador-id');
                if (!entrenadorId) return;
                resetModal();
                try {
                    const resp = await fetch(`/api/cliente/entrenador/${entrenadorId}/info`, {credentials: 'same-origin'});
                    if (!resp.ok) throw new Error('Error al cargar informaci贸n');
                    const info = await resp.json();
                    // Cargar datos b谩sicos
                    document.getElementById('modalEntrenadorFoto').src = info.fotoPerfilUrl || '/img/fotoPerfil.png';
                    document.getElementById('modalEntrenadorNombre').textContent = info.nombre || '';
                    
                    // Mostrar badge de verificaci贸n si el entrenador est谩 verificado
                    const badgeVerificado = document.getElementById('modalEntrenadorVerificado');
                    if (info.verified === true && badgeVerificado) {
                        badgeVerificado.style.display = 'block';
                    } else if (badgeVerificado) {
                        badgeVerificado.style.display = 'none';
                    }
                    
                    document.getElementById('modalEntrenadorEmail').textContent = info.email || '';

                    //  Mostrar g茅nero del entrenador
                    const genero = info.sexo || '';
                    if (genero) {
                        let generoTexto = genero;
                        let generoIcono = '';

                        if (genero.toLowerCase() === 'masculino' || genero.toLowerCase() === 'm') {
                            generoTexto = ' Masculino';
                        } else if (genero.toLowerCase() === 'femenino' || genero.toLowerCase() === 'f') {
                            generoTexto = ' Femenino';
                        } else if (genero.toLowerCase() === 'otro') {
                            generoTexto = 'э Otro';
                        }

                        document.getElementById('modalEntrenadorGenero').textContent = generoTexto;
                        document.getElementById('modalEntrenadorGeneroContainer').style.display = 'block';
                    }

                    document.getElementById('modalEntrenadorEspecialidades').textContent = info.especialidades || 'No especificado';
                    document.getElementById('modalEntrenadorExperiencia').textContent = (info.experiencia || 0) + ' a帽os';
                    const cal = typeof info.calificacionPromedio === 'number' ? info.calificacionPromedio : 0;
                    document.getElementById('modalEntrenadorCalificacion').textContent = cal.toFixed(1);
                    const full = Math.floor(cal), frac = cal - full;
                    let estrellasHTML = '';
                    for (let i = 1; i <= 5; i++) {
                        if (i <= full) estrellasHTML += '<i class="fas fa-star text-warning"></i>';
                        else if (i === full + 1 && frac >= 0.5) estrellasHTML += '<i class="fas fa-star-half-alt text-warning"></i>';
                        else estrellasHTML += '<i class="far fa-star text-warning"></i>';
                    }
                    document.getElementById('modalEstrellas').innerHTML = estrellasHTML;
                    const tel = (info.telefono || '').trim();
                    if (tel) {
                        document.getElementById('modalEntrenadorTelefono').textContent = tel;
                        document.getElementById('modalEntrenadorTelefonoContainer').style.display = 'block';
                    }
                    const pMin = info.precioMinimo, pMax = info.precioMaximo;
                    if (pMin != null || pMax != null) {
                        let txt = '';
                        if (pMin != null && pMax != null) txt = `$${pMin.toLocaleString('es-CO')} - $${pMax.toLocaleString('es-CO')} COP`;
                        else if (pMin != null) txt = `Desde $${pMin.toLocaleString('es-CO')} COP`;
                        else if (pMax != null) txt = `Hasta $${pMax.toLocaleString('es-CO')} COP`;
                        document.getElementById('modalEntrenadorPrecio').textContent = txt;
                        document.getElementById('modalEntrenadorPrecioContainer').style.display = 'block';
                    }
                    const desc = (info.descripcion || '').trim();
                    if (desc) {
                        document.getElementById('modalEntrenadorDescripcion').textContent = desc;
                        document.getElementById('modalEntrenadorDescripcionContainer').style.display = 'block';
                    } else {
                        document.getElementById('modalSinDescripcion').style.display = 'block';
                    }
                    const certs = (info.certificaciones || '').trim();
                    if (certs) {
                        const cont = document.getElementById('modalEntrenadorCertificaciones');
                        cont.innerHTML = '';
                        certs.split(',').forEach(ruta => {
                            const nombre = ruta.split('/').pop();
                            const item = document.createElement('div');
                            item.className = 'cert-item d-flex align-items-center justify-content-between p-2 mb-2 bg-light rounded';
                            item.style.border = '1px solid #dee2e6';
                            const infoDiv = document.createElement('div');
                            infoDiv.className = 'flex-grow-1';
                            infoDiv.innerHTML = `<i class=\"fas fa-file-pdf text-danger me-2\"></i><span class=\"text-dark\">${nombre}</span>`;
                            const btnVer = document.createElement('button');
                            btnVer.className = 'btn btn-sm btn-primary';
                            btnVer.innerHTML = '<i class="fas fa-eye me-1"></i> Ver';
                            btnVer.onclick = (ev) => {
                                ev.preventDefault();
                                abrirVisualizadorPDF('/' + ruta, nombre);
                            };
                            item.appendChild(infoDiv);
                            item.appendChild(btnVer);
                            cont.appendChild(item);
                        });
                        document.getElementById('modalEntrenadorCertificacionesContainer').style.display = 'block';
                    }
                    document.getElementById('modalFormSolicitar').action = `/entrenadores/solicitar/${info.id || entrenadorId}`;
                    // Comentarios
                    cargarComentariosEntrenador(info.id || entrenadorId);
                    mostrarModal();
                } catch (err) {
                    console.error(err);
                    alert('Error al cargar la informaci贸n del entrenador');
                }
            });
        });
    </script>
</section>
</body>

</html>