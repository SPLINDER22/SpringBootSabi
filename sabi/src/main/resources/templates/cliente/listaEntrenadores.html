<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Lista De Entrenadores</title>
</head>

<body th:replace="layout/layout :: layout('Lista de entrenadores', ~{::section})">
    <section th:fragment="section">
    <h1 class="h3 mb-4 text-dark text-center">Lista de Entrenadores</h1>

    <!-- Modal Info del Entrenador -->
    <div class="modal fade" id="modalInfoEntrenador" tabindex="-1" aria-labelledby="modalInfoEntrenadorLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="modalInfoEntrenadorLabel">
                        <i class="fas fa-user-tie me-2"></i>Información del Entrenador
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 text-center mb-3">
                            <img id="modalEntrenadorFoto" src="/img/entrenador.jpg" alt="Foto del entrenador"
                                 class="rounded-circle img-fluid" style="width: 150px; height: 150px; object-fit: cover; border: 4px solid #28a745;">
                            <h4 id="modalEntrenadorNombre" class="mt-3 mb-0">Nombre</h4>
                            <div class="rating-stars mt-2" id="modalEntrenadorEstrellas">
                                <span class="text-muted me-2" id="modalEntrenadorCalificacion">0.0</span>
                                <div id="modalEstrellas"></div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="mb-3">
                                <h6 class="text-success"><i class="fas fa-envelope me-2"></i>Email</h6>
                                <p id="modalEntrenadorEmail" class="text-muted"></p>
                            </div>
                            <div class="mb-3" id="modalEntrenadorTelefonoContainer" style="display: none;">
                                <h6 class="text-success"><i class="fas fa-phone me-2"></i>Teléfono</h6>
                                <p id="modalEntrenadorTelefono" class="text-muted"></p>
                            </div>
                            <div class="mb-3">
                                <h6 class="text-success"><i class="fas fa-dumbbell me-2"></i>Especialidades</h6>
                                <p id="modalEntrenadorEspecialidades" class="text-muted"></p>
                            </div>
                            <div class="mb-3">
                                <h6 class="text-success"><i class="fas fa-trophy me-2"></i>Experiencia</h6>
                                <p id="modalEntrenadorExperiencia" class="text-muted"></p>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div id="modalEntrenadorDescripcionContainer" style="display: none;">
                        <h6 class="text-success"><i class="fas fa-comment-dots me-2"></i>Sobre el Entrenador</h6>
                        <p id="modalEntrenadorDescripcion" class="bg-light p-3 rounded"></p>
                    </div>
                    <div id="modalSinDescripcion" style="display: none;" class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>El entrenador aún no ha agregado una descripción personal.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <form id="modalFormSolicitar" method="post" style="display: inline;">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-paper-plane me-1"></i>Solicitar Entrenador
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

        <div class="container">
            <div class="row justify-content-center">
                <div th:if="${#lists.isEmpty(entrenadores)}" class="col-12 d-flex justify-content-center">
                    <div class="alert alert-info text-center w-50 mt-5" role="alert">
                        <strong>Aún no hay entrenadores disponibles</strong><br>
                        Cuando haya entrenadores, aquí se mostrarán.
                    </div>
                </div>
                <div th:each="entrenador, iterStat : ${entrenadores}" th:if="${!#lists.isEmpty(entrenadores)}" class="col-12 col-md-6 d-flex align-items-stretch mb-4">
                    <div class="card w-100 shadow-lg border-primary rounded-4 p-3 text-dark">
                        <div class="row g-3 align-items-center">
                            <div class="col-12 col-md-5">
                                <div class="rounded-start rounded-top overflow-hidden"
                                    style="position: relative; width: 100%; padding-top: 100%;">
                                    <img th:src="@{/img/entrenador.jpg}" alt="Foto de entrenador"
                                        th:alt="'Foto de ' + ${entrenador.nombre}"
                                        style="position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover;">
                                </div>
                            </div>
                            <div class="col-12 col-md-7">
                                <div class="card-body py-2 px-1">
                                    <h5 class="card-title mb-2" th:text="${entrenador.nombre}">Nombre</h5>

                                    <div class="row">
                                        <div class="col-12 col-sm-6">
                                            <p class="card-text mb-2"><strong>Especialidades:</strong> <span
                                                    th:text="${entrenador.especialidades}"></span></p>
                                        </div>
                                        <div class="col-12 col-sm-6">
                                            <p class="card-text mb-2"><strong>Años de Experiencia:</strong> <span
                                                    th:text="${entrenador.experiencia}"></span></p>
                                            <div class="d-flex align-items-center mb-1"
                                                th:with="full=${T(java.lang.Math).floor(entrenador.calificacionPromedio)},
                                                                                                    frac=${entrenador.calificacionPromedio - T(java.lang.Math).floor(entrenador.calificacionPromedio)}">
                                                <span class="me-2 small text-muted"
                                                    th:text="${#numbers.formatDecimal(entrenador.calificacionPromedio,1,1)}">0.0</span>
                                                <span th:each="i : ${#numbers.sequence(1,5)}" class="me-1">
                                                    <i class="fas fa-star text-warning" th:if="${i >= full}"></i>
                                                    <i class="fas fa-star-half-alt text-warning"
                                                        th:if="${i == full + 1 and frac >= 0.5}"></i>
                                                    <i class="far fa-star text-warning"
                                                        th:if="${!(i >= full) and !(i == full + 1 and frac >= 0.5)}"></i>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-grid gap-2 mt-2">
                                        <button type="button"
                                                class="btn btn-outline-success btn-ver-info-entrenador"
                                                data-bs-toggle="modal"
                                                data-bs-target="#modalInfoEntrenador"
                                                th:attr="data-entrenador-id=${entrenador.id}">
                                            <i class="fas fa-info-circle me-1"></i>Ver Información
                                        </button>
                                        <form
                                            th:action="@{/entrenadores/solicitar/{idEntrenador}(idEntrenador=${entrenador.id})}"
                                            method="post">
                                            <input type="hidden" th:name="${_csrf.parameterName}"
                                                th:value="${_csrf.token}" />
                                            <button type="submit" class="btn btn-success w-100">
                                                <i class="fas fa-paper-plane me-1"></i>Solicitar
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Script para cargar info del entrenador en modal
            document.querySelectorAll('.btn-ver-info-entrenador').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const entrenadorId = this.getAttribute('data-entrenador-id');
                    if (!entrenadorId) return;

                    try {
                        const response = await fetch(`/api/cliente/entrenador/${entrenadorId}/info`);
                        if (!response.ok) throw new Error('Error al cargar información');

                        const info = await response.json();

                        // Actualizar modal
                        document.getElementById('modalEntrenadorFoto').src = info.fotoPerfilUrl || '/img/entrenador.jpg';
                        document.getElementById('modalEntrenadorNombre').textContent = info.nombre;
                        document.getElementById('modalEntrenadorEmail').textContent = info.email;
                        document.getElementById('modalEntrenadorEspecialidades').textContent = info.especialidades || 'No especificado';
                        document.getElementById('modalEntrenadorExperiencia').textContent = info.experiencia ? info.experiencia + ' años' : 'No especificado';

                        // Calificación
                        document.getElementById('modalEntrenadorCalificacion').textContent = info.calificacionPromedio ? info.calificacionPromedio.toFixed(1) : '0.0';

                        // Estrellas
                        const estrellasContainer = document.getElementById('modalEstrellas');
                        const full = Math.floor(info.calificacionPromedio || 0);
                        const frac = (info.calificacionPromedio || 0) - full;
                        let estrellasHTML = '';
                        for (let i = 1; i <= 5; i++) {
                            if (i <= full) {
                                estrellasHTML += '<i class="fas fa-star text-warning"></i>';
                            } else if (i == full + 1 && frac >= 0.5) {
                                estrellasHTML += '<i class="fas fa-star-half-alt text-warning"></i>';
                            } else {
                                estrellasHTML += '<i class="far fa-star text-warning"></i>';
                            }
                        }
                        estrellasContainer.innerHTML = estrellasHTML;

                        // Teléfono (opcional)
                        const telefonoContainer = document.getElementById('modalEntrenadorTelefonoContainer');
                        if (info.telefono && info.telefono.trim() !== '') {
                            document.getElementById('modalEntrenadorTelefono').textContent = info.telefono;
                            telefonoContainer.style.display = 'block';
                        } else {
                            telefonoContainer.style.display = 'none';
                        }

                        // Descripción
                        const descripcionContainer = document.getElementById('modalEntrenadorDescripcionContainer');
                        const sinDescripcion = document.getElementById('modalSinDescripcion');

                        if (info.descripcion && info.descripcion.trim() !== '') {
                            document.getElementById('modalEntrenadorDescripcion').textContent = info.descripcion;
                            descripcionContainer.style.display = 'block';
                            sinDescripcion.style.display = 'none';
                        } else {
                            descripcionContainer.style.display = 'none';
                            sinDescripcion.style.display = 'block';
                        }

                        // Actualizar formulario de solicitud
                        document.getElementById('modalFormSolicitar').action = `/entrenadores/solicitar/${info.id}`;

                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error al cargar la información del entrenador');
                    }
                });
            });
        </script>
    </section>
</body>

</html>