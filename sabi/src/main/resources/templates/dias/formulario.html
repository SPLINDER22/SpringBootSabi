<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="layout/layout :: layout('Registro de dia',~{::section})">
<body>
<section th:fragment="section">
    <link rel="stylesheet" th:href="@{/css/form-common.css}">
    <link rel="stylesheet" th:href="@{/css/form-dias.css}">

    <div class="form-container-dia">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-list-ol"></i>
                <span th:text="${dia.idDia == null ? 'Crear día' : 'Editar día'}"></span>
            </h2>
            <a th:href="@{'/dias/detallar/' + ${dia.idSemana}}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left-circle me-1"></i>Volver a la lista
            </a>
        </div>

        <div class="mb-3 info-badge-dia" th:if="${semana != null}">
            <strong>Semana:</strong> <span th:text="${semana.numeroSemana}"></span>
        </div>

        <form th:action="@{/dias/guardar}" th:object="${dia}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <input type="hidden" th:field="*{idDia}"/>
            <input type="hidden" th:field="*{idSemana}"/>

            <div class="mb-3" th:if="${dia.idDia == null}">
                <label for="numeroDia" class="form-label">Orden de dias</label>
                <input type="number" id="numeroDia" th:field="*{numeroDia}" class="form-control" readonly min="1"/>
                <div class="form-text">
                    Total dias existentes: <strong th:text="${totalDias}">0</strong>. Este será el número <strong th:text="${dia.numeroDia}"></strong>.
                </div>
            </div>
            <div class="mb-3" th:if="${dia.idDia != null}">
                <label for="numeroDia" class="form-label">Orden de dia</label>
                <input type="number" id="numeroDia" th:field="*{numeroDia}" class="form-control" min="1" th:attr="
                max=${semana != null && semana.numeroDias != null ? semana.numeroDias : totalDias}" required/>
                <div class="form-text">
                    Máximo permitido: <span th:text="${semana != null && semana.numeroDias != null ? semana.numeroDias : totalDias}"></span>
                </div>
                <div id="numeroDiaError" class="text-danger mt-1" style="display:none"></div>
            </div>

            <div class="mb-3">
                <label for="descripcion" class="form-label">Descripción</label>
                <textarea id="descripcion" th:field="*{descripcion}" class="form-control" rows="3" placeholder="Ej: Dia de pecho, dia de espalda..." required></textarea>
                <div class="text-danger mt-1" th:if="${#fields.hasErrors('descripcion')}" th:errors="*{descripcion}"></div>
            </div>

            <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-dia-primary me-2">
                    <i class="bi bi-save me-1"></i>
                    <span th:text="${dia.idDia == null ? 'Guardar y continuar' : 'Guardar'}"></span>
                </button>
                <a th:href="@{'/dias/detallar/' + ${dia.idSemana}}" class="btn btn-outline-secondary">Cancelar</a>
            </div>
        </form>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        (function(){
            var input = document.getElementById('numeroDia');
            if(!input || input.readOnly) return; // sólo edición
            var max = parseInt(input.getAttribute('max'),10) || 1;
            var errorSpan = document.getElementById('numeroDiaError');
            function showError(msg){ if(errorSpan){ errorSpan.textContent = msg; errorSpan.style.display='block'; } }
            function hideError(){ if(errorSpan){ errorSpan.textContent=''; errorSpan.style.display='none'; } }
            input.addEventListener('input', function(e){
                var v = parseInt(e.target.value,10);
                if(isNaN(v) || v < 1){ e.target.value = 1; hideError(); return; }
                if(v > max){ e.target.value = max; showError('El número de dia no puede ser mayor a ' + max); }
                else { hideError(); }
            });
        })();
        /*]]>*/
    </script>
</section>
</body>
</html>