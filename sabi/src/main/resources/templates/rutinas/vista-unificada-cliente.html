<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Rutina</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body th:replace="layout/layout :: layout('Mi Rutina', ~{::section})">
<section th:fragment="section">
    <style>
        body {
            background: #f8f9fa;
        }

        .container-fluid {
            padding: 0 10px 10px 10px; /* Eliminar padding superior */
        }

        .main-layout {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
            height: calc(100vh - 140px);
        }

        /* Panel izquierdo - Acorde√≥n */
        .left-panel {
            background: white;
            border-radius: 12px;
            padding: 15px;
            overflow-y: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Semanas */
        .semana-header {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 10px;
            font-weight: 700;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            box-shadow: 0 2px 6px rgba(6, 182, 212, 0.3);
        }

        .semana-header:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.4);
        }

        .semana-header i {
            transition: transform 0.3s;
        }

        /* Rotar s√≥lo el icono chevron para evitar rotar todos los iconos del header */
        .semana-header i.fa-chevron-down { transition: transform 0.3s; }
        .semana-header.collapsed i.fa-chevron-down { transform: rotate(-90deg); }

        .semana-content {
            padding-left: 10px;
            margin-bottom: 15px;
        }

        /* D√≠as */
        .dia-header {
            background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%);
            color: white;
            padding: 12px 18px;
            border-radius: 25px;
            cursor: pointer;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(132, 204, 22, 0.3);
        }

        .dia-header:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 8px rgba(132, 204, 22, 0.4);
        }

        .dia-header i {
            transition: transform 0.3s;
        }

        /* Rotar s√≥lo el icono chevron para los d√≠as */
        .dia-header i.fa-chevron-down { transition: transform 0.3s; }
        .dia-header.collapsed i.fa-chevron-down { transform: rotate(-90deg); }

        .dia-content {
            padding-left: 15px;
            margin-bottom: 10px;
        }

        /* Ejercicios */
        .ejercicio-btn {
            background: transparent;
            color: #3b82f6;
            padding: 10px 16px;
            border-radius: 20px;
            border: 4px solid #3b82f6;
            cursor: pointer;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 0.95rem;
            display: block;
            width: 100%;
            text-align: left;
            transition: all 0.3s;
            box-shadow: none;
        }

        .ejercicio-btn:hover {
            transform: translateX(5px);
            background: rgba(59, 130, 246, 0.1);
            border-color: #2563eb;
        }

        .ejercicio-btn.selected {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.6);
            font-weight: 700;
            transform: translateX(8px) scale(1.02);
        }

        /* Panel derecho - Formulario de series */
        .right-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            overflow-y: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .series-container {
            display: none;
        }

        .series-container.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .serie-card {
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #0284c7;
            box-shadow: 0 2px 6px rgba(2, 132, 199, 0.2);
        }

        .serie-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #0c4a6e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .serie-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 10px;
        }

        .info-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .info-label {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #0f172a;
        }

        .ejercicio-info {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #0284c7;
        }

        .ejercicio-nombre {
            font-size: 1.5rem;
            font-weight: 800;
            color: #0c4a6e;
            margin-bottom: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .header-title {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }

        .btn-finalizar {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white !important;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 6px rgba(220, 38, 38, 0.3);
        }

        .btn-finalizar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
            color: white !important;
        }

        .comentarios-section {
            background: #fefce8;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 4px solid #eab308;
        }

        .comentarios-label {
            font-weight: 600;
            color: #854d0e;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .comentarios-text {
            color: #713f12;
            font-style: italic;
            margin: 0;
        }

        .planeado-box {
            background: #eef2f3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #0c4a6e;
        }

        .planeado-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #0c4a6e;
        }

        /* ==================== NAVEGACI√ìN HORIZONTAL FIJA M√ìVIL ==================== */

        /* Contenedor de navegaci√≥n horizontal (oculto en desktop) */
        .mobile-nav-fixed {
            display: none;
        }

        @media (max-width: 768px) {
            /* Ajustar el contenedor principal para que tenga padding superior */
            .container-fluid {
                padding: 0 0 10px 0; /* Sin padding horizontal ni superior */
            }

            /* Contenedor unificado que incluye header y navegaci√≥n - FIJO */
            .header-nav-container {
                position: fixed;
                top: 56px; /* üëà AQU√ç AJUSTAS LA SEPARACI√ìN DEL NAVBAR - Aumenta o disminuye este valor */
                left: 0;
                right: 0;
                z-index: 1030;
                background: white;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                padding: 10px 10px 10px 10px;
            }

            /* OCULTAR COMPLETAMENTE el header-title en m√≥vil */
            .header-title {
                display: none !important;
            }

            /* Mostrar navegaci√≥n fija solo en m√≥vil */
            .mobile-nav-fixed {
                display: block;
            }

            /* IMPORTANTE: Agregar padding-top al contenido para compensar el header fijo */
            /* üëá AQU√ç AJUSTAS EL ESPACIO DEL CONTENIDO - Mucho m√°s peque√±o ahora */
            .main-layout {
                padding-top: 150px !important; /* Reducido considerablemente porque no hay header-title */
            }

            /* Contenedor scrolleable horizontal */
            .nav-row {
                overflow-x: auto;
                overflow-y: hidden;
                white-space: nowrap;
                padding: 4px 0; /* Reducido de 8px a 4px */
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
                scrollbar-color: #cbd5e1 #f1f5f9;
            }

            .nav-row::-webkit-scrollbar {
                height: 6px;
            }

            .nav-row::-webkit-scrollbar-track {
                background: #f1f5f9;
                border-radius: 10px;
            }

            .nav-row::-webkit-scrollbar-thumb {
                background: #cbd5e1;
                border-radius: 10px;
            }

            .nav-row::-webkit-scrollbar-thumb:hover {
                background: #94a3b8;
            }

            /* Botones de navegaci√≥n horizontal - Semanas */
            .nav-row.semanas-row .mobile-nav-btn {
                display: inline-block;
                background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
                color: white;
                padding: 8px 16px; /* Reducido de 10px 20px a 8px 16px */
                border-radius: 20px;
                margin-right: 6px; /* Reducido de 8px a 6px */
                font-weight: 600;
                font-size: 0.85rem;
                border: none;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.3s;
                box-shadow: 0 2px 5px rgba(6, 182, 212, 0.3);
            }

            .nav-row.semanas-row .mobile-nav-btn:hover,
            .nav-row.semanas-row .mobile-nav-btn.active {
                background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
                transform: scale(1.05);
                box-shadow: 0 4px 10px rgba(6, 182, 212, 0.5);
            }

            /* Botones de navegaci√≥n horizontal - D√≠as */
            .nav-row.dias-row .mobile-nav-btn {
                display: inline-block;
                background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%);
                color: white;
                padding: 6px 14px; /* Reducido de 8px 16px a 6px 14px */
                border-radius: 18px;
                margin-right: 5px; /* Reducido de 6px a 5px */
                font-weight: 600;
                font-size: 0.8rem;
                border: none;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.3s;
                box-shadow: 0 2px 4px rgba(132, 204, 22, 0.3);
            }

            .nav-row.dias-row .mobile-nav-btn:hover,
            .nav-row.dias-row .mobile-nav-btn.active {
                background: linear-gradient(135deg, #65a30d 0%, #4d7c0f 100%);
                transform: scale(1.05);
                box-shadow: 0 4px 8px rgba(132, 204, 22, 0.5);
            }

            /* Botones de navegaci√≥n horizontal - Ejercicios */
            .nav-row.ejercicios-row .mobile-nav-btn {
                display: inline-block;
                background: white;
                color: #3b82f6;
                padding: 6px 12px; /* Reducido de 8px 14px a 6px 12px */
                border-radius: 16px;
                margin-right: 5px; /* Reducido de 6px a 5px */
                font-weight: 500;
                font-size: 0.75rem;
                border: 2px solid #3b82f6;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.3s;
            }

            .nav-row.ejercicios-row .mobile-nav-btn:hover,
            .nav-row.ejercicios-row .mobile-nav-btn.active {
                background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                color: white;
                border-color: transparent;
                transform: scale(1.05);
                box-shadow: 0 4px 10px rgba(59, 130, 246, 0.5);
            }

            /* Badge de completado en botones */
            .mobile-nav-btn .badge {
                font-size: 0.6rem;
                padding: 0.15rem 0.35rem;
                margin-left: 4px;
            }

            /* Ocultar el acorde√≥n en m√≥vil */
            .left-panel {
                display: none;
            }
        }

        /* ==================== RESPONSIVE DESIGN CONTIN√öA ==================== */

        /* Tablet */
        @media (max-width: 992px) {
            .main-layout {
                grid-template-columns: 350px 1fr;
                gap: 15px;
            }

            .header-title h2 {
                font-size: 1.5rem;
            }

            .semana-header {
                font-size: 1rem;
                padding: 12px 15px;
            }

            .dia-header {
                font-size: 0.95rem;
                padding: 10px 15px;
            }

            .ejercicio-btn {
                font-size: 0.9rem;
                padding: 8px 14px;
            }
        }

        /* Mobile */
        @media (max-width: 768px) {
            .container-fluid {
                padding: 0 10px 10px 10px; /* Eliminar padding superior */
            }

            /* Convertir layout de 2 columnas a 1 columna */
            .main-layout {
                grid-template-columns: 1fr;
                gap: 15px;
                height: auto;
                min-height: auto;
            }

            /* Panel derecho ocupa todo el ancho */
            .right-panel {
                max-height: none;
                overflow-y: visible;
                padding: 15px;
            }

            /* Header responsive */
            .header-title .d-flex {
                flex-direction: column;
                gap: 10px;
            }

            .header-title h2 {
                font-size: 1.2rem;
                text-align: center;
            }

            .header-title p {
                text-align: center;
                font-size: 0.85rem;
            }

            .btn-finalizar {
                width: 100%;
                padding: 10px 16px;
                font-size: 0.9rem;
            }

            /* Serie cards m√°s compactas */
            .serie-card {
                padding: 15px;
                margin-bottom: 12px;
            }

            .serie-title {
                font-size: 1.1rem;
                flex-wrap: wrap;
            }

            .ejercicio-info {
                padding: 15px;
            }

            .ejercicio-nombre {
                font-size: 1.2rem;
                word-break: break-word;
            }

            /* Grid de informaci√≥n planeada en columna */
            .planeado-box {
                padding: 12px;
                margin-bottom: 8px;
            }

            .planeado-value {
                font-size: 1rem;
            }

            /* Formulario de registro responsive */
            .registro-section h6 {
                font-size: 0.95rem;
            }

            .form-label {
                font-size: 0.85rem;
                margin-bottom: 0.3rem;
            }

            .form-control,
            .form-select {
                font-size: 0.9rem;
                padding: 0.5rem 0.75rem;
            }

            /* Botones de formulario */
            .registro-serie-form button[type="submit"] {
                font-size: 0.9rem;
                padding: 10px 16px;
            }

            /* Comentarios m√°s compactos */
            .comentarios-section {
                padding: 12px;
            }

            .comentarios-label {
                font-size: 0.85rem;
            }

            .comentarios-text {
                font-size: 0.85rem;
            }

            /* Empty state m√°s peque√±o */
            .empty-state {
                padding: 40px 15px;
            }

            .empty-state i {
                font-size: 3rem;
            }

            .empty-state h4 {
                font-size: 1.1rem;
            }

            .empty-state p {
                font-size: 0.9rem;
            }

            /* Alertas m√°s compactas */
            .alert {
                padding: 10px 12px;
                font-size: 0.85rem;
            }

            /* Badges m√°s peque√±os */
            .badge {
                font-size: 0.7rem;
                padding: 0.3rem 0.5rem;
            }

            /* Modal responsive */
            .modal-body {
                padding: 15px;
            }

            .modal-title {
                font-size: 1.1rem;
            }
        }

        /* Small mobile */
        @media (max-width: 480px) {
            .header-title {
                padding: 10px 8px;
            }

            .mobile-nav-fixed {
                padding: 8px 0;
            }

            .header-title h2 {
                font-size: 1rem;
            }

            .header-title p {
                font-size: 0.75rem;
            }

            .btn-finalizar {
                font-size: 0.8rem;
                padding: 8px 12px;
            }
        }

        /* Mejoras generales de scrolling en m√≥vil */
        @media (max-width: 768px) {
            body {
                overflow-x: hidden;
            }

            .main-layout {
                overflow: visible;
            }

            /* Evitar zoom en inputs en iOS */
            input[type="text"],
            input[type="number"],
            select,
            textarea {
                font-size: 16px !important;
            }
        }
    </style>

    <div class="header-nav-container">
        <div class="header-title">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-0" style="font-weight: 800;">
                    <i class="fas fa-dumbbell me-2"></i>
                    <span th:text="${rutina.nombre}">Mi Rutina</span>
                </h2>
                <button type="button" class="btn btn-finalizar" onclick="validarFinalizarRutina()"
                        th:attr="data-tiene-entrenador=${rutina.idEntrenador != null}, data-rutina-nombre=${rutina.nombre}, data-rutina-id=${rutina.idRutina}">
                    <i class="fas fa-flag-checkered me-1"></i>Finalizar
                </button>
            </div>
            <p class="mb-0 mt-1" style="opacity: 0.9; font-size: 0.75rem;">
                <i class="fas fa-target me-1"></i>
                <span th:text="${rutina.objetivo}">Objetivo</span>
            </p>
        </div>

        <!-- ==================== NAVEGACI√ìN HORIZONTAL FIJA M√ìVIL ==================== -->
        <div class="mobile-nav-fixed">
            <!-- Fila de Semanas -->
            <div class="nav-row semanas-row" id="mobile-semanas-row">
                <!-- Se llenar√° din√°micamente con JavaScript -->
            </div>

            <!-- Fila de D√≠as -->
            <div class="nav-row dias-row" id="mobile-dias-row" style="display: none;">
                <!-- Se llenar√° din√°micamente con JavaScript -->
            </div>

            <!-- Fila de Ejercicios -->
            <div class="nav-row ejercicios-row" id="mobile-ejercicios-row" style="display: none;">
                <!-- Se llenar√° din√°micamente con JavaScript -->
            </div>
        </div>
    </div>

    <div class="main-layout">
        <!-- Panel Izquierdo: Acorde√≥n de Semanas > D√≠as > Ejercicios (Desktop) -->
        <div class="left-panel">
            <!-- Mensaje si no hay semanas -->
            <div th:if="${semanasCompletas == null || semanasCompletas.isEmpty()}" class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Esta rutina a√∫n no tiene semanas configuradas. Contacta a tu entrenador.
            </div>

            <div th:each="semanaData, semanaIter : ${semanasCompletas}"
                 th:with="semana=${semanaData.semana},
                          semanaId=${semana != null ? semana.id : 0},
                          semanaNum=${semana != null ? semana.numeroSemana : 0}">

                <!-- Header de Semana -->
                <div class="semana-header collapsed"
                     th:id="'semana-header-' + ${semanaId}"
                     th:attr="data-bs-toggle='collapse', data-bs-target='#semana-content-' + ${semanaId}">
                    <span>
                        <i class="fas fa-calendar-week me-2"></i>
                        SEMANA <span th:text="${semanaNum}">1</span>
                    </span>
                    <i class="fas fa-chevron-down"></i>
                </div>

                <!-- Contenido de Semana (D√≠as) -->
                <div class="collapse semana-content"
                     th:id="'semana-content-' + ${semanaId}">

                    <!-- Mensaje si no hay d√≠as -->
                    <div th:if="${semanaData.dias == null || semanaData.dias.isEmpty()}" class="alert alert-info mx-2 my-2">
                        <i class="fas fa-info-circle me-2"></i>
                        Esta semana a√∫n no tiene d√≠as configurados.
                    </div>

                    <div th:each="diaData : ${semanaData.dias}"
                         th:with="dia=${diaData.dia},
                                  diaId=${dia != null ? dia.id : 0},
                                  diaNum=${dia != null ? dia.numeroDia : 0}">

                        <!-- Header de D√≠a -->
                        <div class="dia-header collapsed"
                             th:id="'dia-header-' + ${diaId}"
                             th:attr="data-bs-toggle='collapse', data-bs-target='#dia-content-' + ${diaId}">
                            <span>
                                <i class="fas fa-calendar-day me-2"></i>
                                D√≠a <span th:text="${diaNum}">1</span>
                                <!-- Icono de completado si todas las series del d√≠a est√°n registradas -->
                                <span th:if="${diaData.todasSeriesCompletadas}" class="badge bg-success ms-2" style="font-size: 0.7rem;">
                                    <i class="fas fa-check-circle"></i>
                                </span>
                            </span>
                            <i class="fas fa-chevron-down"></i>
                        </div>

                        <!-- Contenido de D√≠a (Ejercicios) -->
                        <div class="collapse dia-content"
                             th:id="'dia-content-' + ${diaId}">

                            <!-- Mensaje si no hay ejercicios -->
                            <div th:if="${diaData.ejercicios == null || diaData.ejercicios.isEmpty()}" class="alert alert-info mx-2 my-2">
                                <i class="fas fa-info-circle me-2"></i>
                                Este d√≠a a√∫n no tiene ejercicios configurados.
                            </div>

                            <div th:each="ejeData : ${diaData.ejercicios}"
                                 th:with="eje=${ejeData.ejercicio},
                                          ejeId=${eje != null ? eje.idEjercicioAsignado : 0},
                                          nombreEjercicio=${eje != null ? eje.nombreEjercicio : 'Ejercicio'}">

                                <!-- Bot√≥n de Ejercicio -->
                                <button class="ejercicio-btn"
                                        th:id="'ejercicio-btn-' + ${ejeId}"
                                        th:attr="data-ejercicio-id=${ejeId},
                                                 data-completado=${ejeData.todasSeriesCompletadas ? 'true' : 'false'}"
                                        onclick="seleccionarEjercicio(this)">
                                    <i class="fas fa-running me-2"></i>
                                    <span th:text="${nombreEjercicio}">Ejercicio</span>
                                    <!-- Icono de completado si todas las series est√°n registradas -->
                                    <i th:if="${ejeData.todasSeriesCompletadas}" class="fas fa-check-circle ms-2 text-success" style="font-size: 1.1rem;"></i>
                                </button>

                                <!-- Container de Series (oculto, se muestra en panel derecho) -->
                                <div class="series-data"
                                     th:id="'series-data-' + ${ejeId}"
                                     style="display: none;"
                                     th:attr="data-ejercicio-nombre=${nombreEjercicio},
                                              data-ejercicio-id-base=${eje != null ? eje.idEjercicio : 0},
                                              data-ejercicio-comentarios=${eje != null ? eje.comentarios : ''}">
                                    <div th:each="serieMap : ${ejeData.series}"
                                         th:with="serie=${serieMap.serie},
                                                  registro=${serieMap.registro}"
                                         class="serie-data-item"
                                         th:attr="data-serie-id=${serie != null ? serie.id : 0},
                                                  data-serie-num=${serie != null ? serie.orden : 0},
                                                  data-repeticiones=${serie != null ? serie.repeticiones : 0},
                                                  data-peso=${serie != null ? serie.peso : 0},
                                                  data-descanso=${serie != null ? serie.descanso : 0},
                                                  data-intensidad=${serie != null ? serie.intensidad : ''},
                                                  data-comentarios=${serie != null ? serie.comentarios : ''},
                                                  data-registro-reps=${registro != null ? registro.repeticionesReales : ''},
                                                  data-registro-peso=${registro != null ? registro.pesoReal : ''},
                                                  data-registro-descanso=${registro != null ? registro.descansoReal : ''},
                                                  data-registro-intensidad=${registro != null ? registro.intensidadReal : ''},
                                                  data-registro-notas=${registro != null ? registro.comentariosCliente : ''}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel Derecho: Formulario de Series -->
        <div class="right-panel">
            <div id="series-display">
                <div class="empty-state">
                    <i class="fas fa-hand-pointer"></i>
                    <h4>Selecciona un ejercicio</h4>
                    <p>Haz clic en cualquier ejercicio del panel izquierdo para ver sus series</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Finalizar Rutina -->
    <div class="modal fade" id="modalFinalizarRutina" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-flag-checkered me-2"></i>Finalizar Rutina
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form th:action="@{'/rutinas/finalizar-comentario/' + ${rutina.idRutina}}" method="post" id="formFinalizarRutina">
                    <div class="modal-body">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <input type="hidden" id="tieneEntrenador" th:value="${rutina.idEntrenador != null}"/>
                        <input type="hidden" id="idEntrenador" th:value="${rutina.idEntrenador != null ? rutina.idEntrenador : ''}"/>
                        <input type="hidden" id="idCliente" th:value="${rutina.idCliente != null ? rutina.idCliente : ''}"/>

                        <p class="mb-3" id="textoSinEntrenador" th:if="${rutina.idEntrenador == null}">
                            Est√°s por finalizar la rutina <strong th:text="${rutina.nombre}"></strong>.
                            Despu√©s podr√°s adoptar otra.
                        </p>
                        <p class="mb-3" id="textoConEntrenador" th:if="${rutina.idEntrenador != null}">
                            Est√°s por finalizar la rutina <strong th:text="${rutina.nombre}"></strong>.
                            Puedes dejar un comentario y calificaci√≥n para tu entrenador.
                            <br><strong class="text-warning">Nota:</strong> Al finalizar esta rutina, tu suscripci√≥n con el entrenador ser√° cancelada.
                        </p>

                        <div class="mb-3">
                            <label for="textoComentario" class="form-label">
                                Comentario <span th:if="${rutina.idEntrenador != null}" class="text-danger">*</span>
                                <span th:if="${rutina.idEntrenador == null}" class="text-muted">(opcional)</span>
                            </label>
                            <textarea class="form-control" id="textoComentario" name="texto" rows="4"
                                      placeholder="¬øC√≥mo fue tu experiencia con esta rutina?" maxlength="500"
                                      th:required="${rutina.idEntrenador != null}"></textarea>
                            <div class="invalid-feedback">
                                El comentario es obligatorio cuando la rutina fue asignada por un entrenador.
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="calificacion" class="form-label">Calificaci√≥n (0 - 5, opcional)</label>
                            <input type="number" class="form-control" id="calificacion" name="calificacion"
                                   min="0" max="5" step="0.5" placeholder="Ej: 4.5"/>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-check me-2"></i>Confirmar Finalizaci√≥n
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        // Par√°metros de navegaci√≥n autom√°tica desde el servidor
        const autoSemanaId = /*[[${autoSemanaId}]]*/ null;
        const autoDiaId = /*[[${autoDiaId}]]*/ null;
        const autoEjercicioId = /*[[${autoEjercicioId}]]*/ null;

        // Variables globales para navegaci√≥n m√≥vil
        let currentSemanaId = null;
        let currentDiaId = null;
        let currentEjercicioId = null;

        // ==================== FUNCIONES PARA NAVEGACI√ìN M√ìVIL ==================== //

        function construirNavegacionMovil() {
            // Solo construir en m√≥vil
            if (window.innerWidth > 768) return;

            const semanasRow = document.getElementById('mobile-semanas-row');
            const diasRow = document.getElementById('mobile-dias-row');
            const ejerciciosRow = document.getElementById('mobile-ejercicios-row');

            // Limpiar filas
            semanasRow.innerHTML = '';
            diasRow.innerHTML = '';
            ejerciciosRow.innerHTML = '';

            // Construir botones de semanas
            const semanasHeaders = document.querySelectorAll('.semana-header');
            semanasHeaders.forEach(header => {
                const semanaId = header.id.replace('semana-header-', '');
                const semanaText = header.querySelector('span').textContent.trim();

                const btn = document.createElement('button');
                btn.className = 'mobile-nav-btn';
                btn.setAttribute('data-semana-id', semanaId);
                btn.innerHTML = `<i class="fas fa-calendar-week me-1"></i>${semanaText}`;
                btn.onclick = () => seleccionarSemanaMobile(semanaId);

                semanasRow.appendChild(btn);
            });
        }

        function seleccionarSemanaMobile(semanaId) {
            currentSemanaId = semanaId;
            currentDiaId = null;
            currentEjercicioId = null;

            // Actualizar botones activos de semanas
            document.querySelectorAll('.semanas-row .mobile-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-semana-id="${semanaId}"]`)?.classList.add('active');

            // Construir botones de d√≠as
            const semanaContent = document.getElementById(`semana-content-${semanaId}`);
            const diasHeaders = semanaContent?.querySelectorAll('.dia-header') || [];

            const diasRow = document.getElementById('mobile-dias-row');
            diasRow.innerHTML = '';

            if (diasHeaders.length > 0) {
                diasHeaders.forEach(header => {
                    const diaId = header.id.replace('dia-header-', '');
                    const diaText = header.querySelector('span').textContent.trim();
                    const badge = header.querySelector('.badge');

                    const btn = document.createElement('button');
                    btn.className = 'mobile-nav-btn';
                    btn.setAttribute('data-dia-id', diaId);
                    btn.innerHTML = `<i class="fas fa-calendar-day me-1"></i>${diaText}`;
                    if (badge) {
                        btn.innerHTML += '<span class="badge bg-success ms-1"><i class="fas fa-check-circle"></i></span>';
                    }
                    btn.onclick = () => seleccionarDiaMobile(diaId);

                    diasRow.appendChild(btn);
                });
                diasRow.style.display = 'block';
            } else {
                diasRow.style.display = 'none';
            }

            // Ocultar fila de ejercicios
            document.getElementById('mobile-ejercicios-row').style.display = 'none';
            document.getElementById('mobile-ejercicios-row').innerHTML = '';

            // Limpiar panel de series
            document.getElementById('series-display').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-hand-pointer"></i>
                    <h4>Selecciona un d√≠a</h4>
                    <p>Elige un d√≠a de la navegaci√≥n superior</p>
                </div>
            `;
        }

        function seleccionarDiaMobile(diaId) {
            currentDiaId = diaId;
            currentEjercicioId = null;

            // Actualizar botones activos de d√≠as
            document.querySelectorAll('.dias-row .mobile-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-dia-id="${diaId}"]`)?.classList.add('active');

            // Construir botones de ejercicios
            const diaContent = document.getElementById(`dia-content-${diaId}`);
            const ejerciciosBtns = diaContent?.querySelectorAll('.ejercicio-btn') || [];

            const ejerciciosRow = document.getElementById('mobile-ejercicios-row');
            ejerciciosRow.innerHTML = '';

            if (ejerciciosBtns.length > 0) {
                ejerciciosBtns.forEach(ejeBtn => {
                    const ejeId = ejeBtn.getAttribute('data-ejercicio-id');
                    const ejeText = ejeBtn.querySelector('span')?.textContent || ejeBtn.textContent;
                    const checkIcon = ejeBtn.querySelector('.fa-check-circle');

                    const btn = document.createElement('button');
                    btn.className = 'mobile-nav-btn';
                    btn.setAttribute('data-ejercicio-id', ejeId);
                    btn.innerHTML = `<i class="fas fa-running me-1"></i>${ejeText.replace(/‚úì/g, '').trim()}`;
                    if (checkIcon) {
                        btn.innerHTML += '<span class="badge bg-success ms-1"><i class="fas fa-check-circle"></i></span>';
                    }
                    btn.onclick = () => seleccionarEjercicioMobile(ejeId);

                    ejerciciosRow.appendChild(btn);
                });
                ejerciciosRow.style.display = 'block';
            } else {
                ejerciciosRow.style.display = 'none';
            }

            // Limpiar panel de series
            document.getElementById('series-display').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-hand-pointer"></i>
                    <h4>Selecciona un ejercicio</h4>
                    <p>Elige un ejercicio de la navegaci√≥n superior</p>
                </div>
            `;
        }

        function seleccionarEjercicioMobile(ejercicioId) {
            currentEjercicioId = ejercicioId;

            // Actualizar botones activos de ejercicios
            document.querySelectorAll('.ejercicios-row .mobile-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-ejercicio-id="${ejercicioId}"]`)?.classList.add('active');

            // Buscar el bot√≥n original del ejercicio y llamar a la funci√≥n original
            const originalBtn = document.getElementById(`ejercicio-btn-${ejercicioId}`);
            if (originalBtn) {
                seleccionarEjercicio(originalBtn, true);

                // Hacer scroll al top del panel de series
                setTimeout(() => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }, 100);
            }
        }

        // ==================== FUNCI√ìN ORIGINAL CON ADAPTACI√ìN ==================== //

        function navegacionAutomatica() {
            if (autoSemanaId) {
                console.log('Navegaci√≥n autom√°tica activada:');
                console.log('- Semana ID:', autoSemanaId);
                console.log('- D√≠a ID:', autoDiaId);
                console.log('- Ejercicio ID:', autoEjercicioId);

                // Verificar si estamos en m√≥vil
                const isMobile = window.innerWidth <= 768;

                if (isMobile) {
                    // ==================== NAVEGACI√ìN AUTOM√ÅTICA EN M√ìVIL ==================== //
                    console.log('Modo m√≥vil detectado - usando navegaci√≥n adaptada');

                    // Primero construir la navegaci√≥n m√≥vil si no est√° construida
                    construirNavegacionMovil();

                    // Seleccionar la semana
                    if (autoSemanaId) {
                        seleccionarSemanaMobile(autoSemanaId);

                        // Despu√©s de un peque√±o delay, seleccionar el d√≠a
                        setTimeout(() => {
                            if (autoDiaId) {
                                seleccionarDiaMobile(autoDiaId);

                                // Despu√©s de otro delay, seleccionar el ejercicio
                                setTimeout(() => {
                                    if (autoEjercicioId) {
                                        seleccionarEjercicioMobile(autoEjercicioId);
                                    }
                                }, 200);
                            }
                        }, 200);
                    }
                } else {
                    // ==================== NAVEGACI√ìN AUTOM√ÅTICA EN DESKTOP (ORIGINAL) ==================== //
                    // Abrir semana
                    const semanaCollapse = document.getElementById('semana-content-' + autoSemanaId);
                    const semanaHeader = document.getElementById('semana-header-' + autoSemanaId);
                    if (semanaCollapse && semanaHeader) {
                        // Remover clase collapsed del header
                        semanaHeader.classList.remove('collapsed');

                        // Abrir el collapse
                        const bsCollapse = new bootstrap.Collapse(semanaCollapse, { toggle: false });
                        bsCollapse.show();

                        // Despu√©s de abrir la semana, abrir el d√≠a
                        setTimeout(() => {
                            if (autoDiaId) {
                                const diaCollapse = document.getElementById('dia-content-' + autoDiaId);
                                const diaHeader = document.getElementById('dia-header-' + autoDiaId);
                                if (diaCollapse && diaHeader) {
                                    // Remover clase collapsed del header
                                    diaHeader.classList.remove('collapsed');

                                    // Abrir el collapse
                                    const bsDiaCollapse = new bootstrap.Collapse(diaCollapse, { toggle: false });
                                    bsDiaCollapse.show();

                                    // Despu√©s de abrir el d√≠a, seleccionar el ejercicio
                                    setTimeout(() => {
                                        if (autoEjercicioId) {
                                            const ejercicioBtn = document.getElementById('ejercicio-btn-' + autoEjercicioId);
                                            if (ejercicioBtn) {
                                                // Hacer scroll al ejercicio
                                                ejercicioBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                                // Seleccionar y mostrar el ejercicio
                                                setTimeout(() => {
                                                    ejercicioBtn.click();
                                                }, 500);
                                            } else {
                                                console.error('No se encontr√≥ el bot√≥n del ejercicio con ID:', autoEjercicioId);
                                            }
                                        }
                                    }, 400);
                                } else {
                                    console.error('No se encontr√≥ el d√≠a con ID:', autoDiaId);
                                }
                            }
                        }, 400);
                    } else {
                        console.error('No se encontr√≥ la semana con ID:', autoSemanaId);
                    }
                }
            }
        }

        function seleccionarEjercicio(btnElement, shouldScroll = true) {
            const ejercicioId = btnElement.getAttribute('data-ejercicio-id');

            // Remover selecci√≥n previa
            document.querySelectorAll('.ejercicio-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            // Marcar como seleccionado
            btnElement.classList.add('selected');

            // Obtener datos de las series
            const seriesData = document.getElementById('series-data-' + ejercicioId);
            const ejercicioNombre = seriesData.getAttribute('data-ejercicio-nombre');
            const ejercicioIdBase = seriesData.getAttribute('data-ejercicio-id-base');
            const ejercicioComentarios = seriesData.getAttribute('data-ejercicio-comentarios');
            const seriesItems = seriesData.querySelectorAll('.serie-data-item');

            // Construir HTML del panel derecho
            let html = `
                <div class="ejercicio-info">
                    <div class="ejercicio-nombre">
                        <i class="fas fa-running me-2"></i>
                        <a href="/ejercicios/detalle/${ejercicioIdBase}"
                           style="color: #0c4a6e; text-decoration: none; border-bottom: 2px solid transparent; transition: all 0.2s;"
                           onmouseover="this.style.borderBottom='2px solid #0284c7'; this.style.color='#0284c7';"
                           onmouseout="this.style.borderBottom='2px solid transparent'; this.style.color='#0c4a6e';">
                            ${ejercicioNombre}
                        </a>
                        <a href="/ejercicios/detalle/${ejercicioIdBase}"
                           class="btn btn-sm btn-outline-primary ms-2"
                           style="font-size: 0.85rem; padding: 0.4rem 0.8rem; border-radius: 20px;"
                           title="Ver descripci√≥n y tutorial del ejercicio">
                            <i class="fas fa-book-open me-1"></i>Ver Tutorial
                        </a>
                    </div>
                    ${ejercicioComentarios && ejercicioComentarios !== 'null' && ejercicioComentarios !== '' ? `
                        <div class="comentarios-section">
                            <div class="comentarios-label">
                                <i class="fas fa-comment-dots me-1"></i>Comentarios del entrenador:
                            </div>
                            <p class="comentarios-text">${ejercicioComentarios}</p>
                        </div>
                    ` : ''}
                </div>
            `;

            if (seriesItems.length === 0) {
                html += `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Este ejercicio a√∫n no tiene series asignadas.
                    </div>
                `;
            } else {
                seriesItems.forEach((item, index) => {
                    const serieId = item.getAttribute('data-serie-id');
                    const serieNum = item.getAttribute('data-serie-num');
                    const repsPlaneadas = item.getAttribute('data-repeticiones');
                    const pesoPlaneado = item.getAttribute('data-peso');
                    const descanso = item.getAttribute('data-descanso');
                    const intensidad = item.getAttribute('data-intensidad');
                    const comentarios = item.getAttribute('data-comentarios');

                    // Obtener datos del registro guardado (si existe)
                    const registroReps = item.getAttribute('data-registro-reps');
                    const registroPeso = item.getAttribute('data-registro-peso');
                    const registroDescanso = item.getAttribute('data-registro-descanso');
                    const registroIntensidad = item.getAttribute('data-registro-intensidad');
                    const registroNotas = item.getAttribute('data-registro-notas');

                    const tieneRegistro = registroReps && registroReps !== '' && registroReps !== 'null';

                    html += `
                        <div class="serie-card">
                            <div class="serie-title">
                                <i class="fas fa-hashtag"></i>
                                Serie ${serieNum || (index + 1)}
                                ${tieneRegistro ? '<span class="badge bg-success ms-2"><i class="fas fa-check me-1"></i>Completado</span>' : ''}
                            </div>

                            <!-- Informaci√≥n planeada por el entrenador -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="planeado-box">
                                        <label class="form-label mb-1">
                                            <i class="fas fa-clipboard-list me-1"></i>
                                            <strong>Repeticiones planeadas:</strong>
                                        </label>
                                        <div class="planeado-value">${repsPlaneadas || 'No especificado'}</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="planeado-box">
                                        <label class="form-label mb-1">
                                            <i class="fas fa-weight-hanging me-1"></i>
                                            <strong>Peso planeado:</strong>
                                        </label>
                                        <div class="planeado-value">${pesoPlaneado ? pesoPlaneado + ' kg' : 'No especificado'}</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="planeado-box">
                                        <label class="form-label mb-1">
                                            <i class="fas fa-fire me-1"></i>
                                            <strong>Intensidad sugerida:</strong>
                                        </label>
                                        <div class="planeado-value">${intensidad || 'No especificado'}</div>
                                    </div>
                                </div>
                            </div>

                            ${comentarios && comentarios !== 'null' && comentarios !== '' ? `
                                <div class="comentarios-section mb-3">
                                    <div class="comentarios-label">
                                        <i class="fas fa-comment me-1"></i>Notas de la serie:
                                    </div>
                                    <p class="comentarios-text">${comentarios}</p>
                                </div>
                            ` : ''}

                            ${descanso && descanso !== 'null' && descanso !== '' && descanso !== '0' ? `
                                <div class="alert alert-info py-2 mb-3">
                                    <i class="fas fa-clock me-1"></i>
                                    <strong>Descanso sugerido:</strong> ${descanso} seg
                                </div>
                            ` : ''}

                            <!-- Formulario de registro -->
                            <form class="registro-serie-form" data-serie-id="${serieId}" onsubmit="return registrarSerie(event, ${serieId})">
                                <div class="registro-section">
                                    <h6 class="mb-3" style="color: #0c4a6e; font-weight: 700;">
                                        <i class="fas fa-pencil-alt me-2"></i>${tieneRegistro ? 'Tu registro:' : 'Registra lo que hiciste:'}
                                    </h6>
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label class="form-label">Repeticiones realizadas</label>
                                            <input type="number" class="form-control ${tieneRegistro ? 'form-guardado' : ''}" name="repeticionesRealizadas"
                                                   value="${registroReps || ''}" placeholder="${repsPlaneadas || '10'}" min="0" required
                                                   style="${tieneRegistro ? 'background-color: #e8f5e9; border-color: #4caf50;' : ''}">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Peso usado (kg)</label>
                                            <input type="number" step="0.25" class="form-control ${tieneRegistro ? 'form-guardado' : ''}" name="pesoRealizado"
                                                   value="${registroPeso || ''}" placeholder="${pesoPlaneado || '20'}" min="0" required
                                                   style="${tieneRegistro ? 'background-color: #e8f5e9; border-color: #4caf50;' : ''}">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Intensidad</label>
                                            <select class="form-select ${tieneRegistro ? 'form-guardado' : ''}" name="intensidadRealizada" required
                                                    style="${tieneRegistro ? 'background-color: #e8f5e9; border-color: #4caf50;' : ''}">
                                                <option value="">Selecciona...</option>
                                                <option value="BAJA" ${registroIntensidad === 'BAJA' ? 'selected' : ''}>Baja</option>
                                                <option value="MEDIA" ${registroIntensidad === 'MEDIA' ? 'selected' : ''}>Media</option>
                                                <option value="ALTA" ${registroIntensidad === 'ALTA' ? 'selected' : ''}>Alta</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Descanso (segundos)</label>
                                            <input type="number" class="form-control ${tieneRegistro ? 'form-guardado' : ''}" name="descansoRealizado"
                                                   value="${registroDescanso || ''}" placeholder="${descanso || '60'}" min="0"
                                                   style="${tieneRegistro ? 'background-color: #e8f5e9; border-color: #4caf50;' : ''}">
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">Notas adicionales (opcional)</label>
                                            <textarea class="form-control ${tieneRegistro ? 'form-guardado' : ''}" name="notasCliente" rows="2"
                                                      placeholder="¬øC√≥mo te sentiste? ¬øAlguna observaci√≥n?"
                                                      style="${tieneRegistro ? 'background-color: #e8f5e9; border-color: #4caf50;' : ''}">${registroNotas && registroNotas !== 'null' ? registroNotas : ''}</textarea>
                                        </div>
                                        <div class="col-12">
                                            <button type="submit" class="btn ${tieneRegistro ? 'btn-warning' : 'btn-primary'} w-100">
                                                <i class="fas ${tieneRegistro ? 'fa-edit' : 'fa-check'} me-2"></i>${tieneRegistro ? 'Actualizar Registro' : 'Registrar Serie'}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    `;
                });
            }

            // Actualizar panel derecho
            document.getElementById('series-display').innerHTML = html;

            // Hacer scroll al inicio del panel derecho solo si se indica
            if (shouldScroll) {
                const rightPanel = document.querySelector('.right-panel');
                if (rightPanel) {
                    rightPanel.scrollTop = 0;
                }
            }
        }

        function registrarSerie(event, serieId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            // Preparar el objeto para enviar al backend
            const registroData = {
                idSerie: serieId,
                repeticionesReales: parseInt(formData.get('repeticionesRealizadas')),
                pesoReal: parseFloat(formData.get('pesoRealizado')),
                intensidadReal: formData.get('intensidadRealizada'),
                descansoReal: formData.get('descansoRealizado') ? parseInt(formData.get('descansoRealizado')) : null,
                comentariosCliente: formData.get('notasCliente') || null
            };

            // Obtener el token CSRF
            const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content') ||
                             document.querySelector('input[name="_csrf"]')?.value;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content') || 'X-CSRF-TOKEN';

            // Mostrar indicador de carga
            const btn = form.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
            btn.disabled = true;

            // Enviar al backend con AJAX
            fetch('/api/registros-series/guardar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify(registroData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostrar mensaje de √©xito
                    btn.innerHTML = '<i class="fas fa-check-circle me-2"></i>¬°Guardado!';
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-success');

                    // ====== ACTUALIZAR LOS ATRIBUTOS DATA EN EL HTML ORIGINAL ======
                    // Buscar el elemento serie-data-item correspondiente en el DOM original
                    const serieDataItem = document.querySelector(`.serie-data-item[data-serie-id="${serieId}"]`);
                    if (serieDataItem) {
                        // Actualizar los atributos data-registro-* con los nuevos valores
                        serieDataItem.setAttribute('data-registro-reps', registroData.repeticionesReales);
                        serieDataItem.setAttribute('data-registro-peso', registroData.pesoReal);
                        serieDataItem.setAttribute('data-registro-descanso', registroData.descansoReal || '');
                        serieDataItem.setAttribute('data-registro-intensidad', registroData.intensidadReal || '');
                        serieDataItem.setAttribute('data-registro-notas', registroData.comentariosCliente || '');
                        console.log('Atributos data actualizados para serie ' + serieId);

                        // Verificar si todas las series del ejercicio est√°n completadas
                        const ejercicioActualId = document.querySelector('.ejercicio-btn.selected')?.getAttribute('data-ejercicio-id');
                        if (ejercicioActualId) {
                            const seriesData = document.getElementById('series-data-' + ejercicioActualId);
                            const todasSeriesItems = seriesData.querySelectorAll('.serie-data-item');
                            let todasCompletas = true;

                            todasSeriesItems.forEach(item => {
                                const reps = item.getAttribute('data-registro-reps');
                                if (!reps || reps === '' || reps === 'null') {
                                    todasCompletas = false;
                                }
                            });

                            // Actualizar el bot√≥n del ejercicio si est√° completo
                            const ejercicioBtn = document.getElementById('ejercicio-btn-' + ejercicioActualId);
                            if (ejercicioBtn && todasCompletas) {
                                ejercicioBtn.setAttribute('data-completado', 'true');
                                // Agregar icono de completado si no existe
                                if (!ejercicioBtn.querySelector('.fa-check-circle')) {
                                    const checkIcon = document.createElement('i');
                                    checkIcon.className = 'fas fa-check-circle ms-2 text-success';
                                    checkIcon.style.fontSize = '1.1rem';
                                    ejercicioBtn.appendChild(checkIcon);
                                }

                                // --- ACTUALIZAR BADGE EN NAVEGACI√ìN M√ìVIL DEL EJERCICIO ---
                                if (window.innerWidth <= 768) {
                                    const mobileEjercicioBtn = document.querySelector(`.ejercicios-row .mobile-nav-btn[data-ejercicio-id="${ejercicioActualId}"]`);
                                    if (mobileEjercicioBtn && !mobileEjercicioBtn.querySelector('.badge')) {
                                        mobileEjercicioBtn.innerHTML += '<span class="badge bg-success ms-1"><i class="fas fa-check-circle"></i></span>';
                                    }
                                }

                                // --- ACTUALIZAR BADGE DEL D√çA SI TODOS LOS EJERCICIOS DEL D√çA EST√ÅN COMPLETOS ---
                                try {
                                    const diaContent = ejercicioBtn.closest('.dia-content');
                                    if (diaContent) {
                                        // Buscar todos los botones de ejercicio dentro de este d√≠a
                                        const ejerciciosInDia = diaContent.querySelectorAll('.ejercicio-btn');
                                        let allEjCompleted = true;
                                        ejerciciosInDia.forEach(b => {
                                            if (b.getAttribute('data-completado') !== 'true') {
                                                allEjCompleted = false;
                                            }
                                        });

                                        const diaId = (diaContent.id || '').replace('dia-content-', '');
                                        const diaHeader = document.getElementById('dia-header-' + diaId);
                                        if (diaHeader) {
                                            const existingBadge = diaHeader.querySelector('.badge-dia-completado');
                                            if (allEjCompleted && !existingBadge) {
                                                const span = document.createElement('span');
                                                span.className = 'badge bg-success ms-2 badge-dia-completado';
                                                span.style.fontSize = '0.7rem';
                                                span.innerHTML = '<i class="fas fa-check-circle"></i>';
                                                // Insertar dentro del primer span del header para mantener estructura
                                                const primarySpan = diaHeader.querySelector('span');
                                                if (primarySpan) {
                                                    primarySpan.appendChild(span);
                                                } else {
                                                    diaHeader.insertBefore(span, diaHeader.firstChild);
                                                }

                                                // --- ACTUALIZAR BADGE EN NAVEGACI√ìN M√ìVIL DEL D√çA ---
                                                if (window.innerWidth <= 768) {
                                                    const mobileDiaBtn = document.querySelector(`.dias-row .mobile-nav-btn[data-dia-id="${diaId}"]`);
                                                    if (mobileDiaBtn && !mobileDiaBtn.querySelector('.badge')) {
                                                        mobileDiaBtn.innerHTML += '<span class="badge bg-success ms-1"><i class="fas fa-check-circle"></i></span>';
                                                    }
                                                }
                                            } else if (!allEjCompleted && existingBadge) {
                                                existingBadge.remove();

                                                // --- REMOVER BADGE EN NAVEGACI√ìN M√ìVIL DEL D√çA ---
                                                if (window.innerWidth <= 768) {
                                                    const mobileDiaBtn = document.querySelector(`.dias-row .mobile-nav-btn[data-dia-id="${diaId}"]`);
                                                    if (mobileDiaBtn) {
                                                        const mobileBadge = mobileDiaBtn.querySelector('.badge');
                                                        if (mobileBadge) mobileBadge.remove();
                                                    }
                                                }
                                            }
                                        }
                                    }
                                } catch (e) {
                                    console.error('Error actualizando badge de d√≠a:', e);
                                }
                                // --- fin actualizaci√≥n badge d√≠a ---
                            }

                            // Recargar la vista del ejercicio despu√©s de 1 segundo para mostrar el nuevo estado
                            setTimeout(() => {
                                // Buscar el bot√≥n del ejercicio actual y hacer clic para recargar SIN hacer scroll
                                const ejercicioBtnReload = document.getElementById('ejercicio-btn-' + ejercicioActualId);
                                if (ejercicioBtnReload) {
                                    seleccionarEjercicio(ejercicioBtnReload, false);
                                }
                            }, 1000);
                        }
                    }
                } else {
                    // Mostrar error si el servidor responde con success: false
                    alert('Error: ' + (data.message || 'No se pudo guardar el registro'));
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            })
            .catch(err => {
                console.error('Error guardando registro (fetch):', err);
                alert('Ocurri√≥ un error al guardar el registro. Intenta nuevamente.');
                // Restaurar bot√≥n en caso de error
                btn.innerHTML = originalText;
                btn.disabled = false;
            });

            return false;
        }

        // Asegurar que los headers tengan la clase `collapsed` correcta cuando los Collapses de Bootstrap cambien
        document.addEventListener('DOMContentLoaded', () => {
            // Construir navegaci√≥n m√≥vil al cargar
            construirNavegacionMovil();

            // Reconstruir al cambiar tama√±o de ventana
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    construirNavegacionMovil();
                }, 250);
            });

            // Adjuntar listeners a todos los collapse para sincronizar la clase collapsed en los headers
            document.querySelectorAll('.collapse').forEach(col => {
                col.addEventListener('show.bs.collapse', () => {
                    if (col.id && col.id.startsWith('semana-content-')) {
                        const semanaId = col.id.replace('semana-content-', '');
                        const header = document.getElementById('semana-header-' + semanaId);
                        if (header) header.classList.remove('collapsed');
                    } else if (col.id && col.id.startsWith('dia-content-')) {
                        const diaId = col.id.replace('dia-content-', '');
                        const header = document.getElementById('dia-header-' + diaId);
                        if (header) header.classList.remove('collapsed');
                    }
                });

                col.addEventListener('hide.bs.collapse', () => {
                    if (col.id && col.id.startsWith('semana-content-')) {
                        const semanaId = col.id.replace('semana-content-', '');
                        const header = document.getElementById('semana-header-' + semanaId);
                        if (header) header.classList.add('collapsed');
                    } else if (col.id && col.id.startsWith('dia-content-')) {
                        const diaId = col.id.replace('dia-content-', '');
                        const header = document.getElementById('dia-header-' + diaId);
                        if (header) header.classList.add('collapsed');
                    }
                });
            });

            // Llamar a la navegaci√≥n autom√°tica (si el servidor pas√≥ par√°metros)
            try {
                if (typeof navegacionAutomatica === 'function') {
                    navegacionAutomatica();
                }
            } catch (e) {
                console.error('Error ejecutando navegacionAutomatica:', e);
            }

            // ========== CONFIGURAR VALIDACI√ìN DEL FORMULARIO DE FINALIZACI√ìN ========== //
            const formFinalizar = document.getElementById('formFinalizarRutina');
            const textoComentarioInput = document.getElementById('textoComentario');

            if (formFinalizar) {
                formFinalizar.addEventListener('submit', function(e) {
                    const tieneEntrenador = document.getElementById('tieneEntrenador').value === 'true';
                    const textoComentario = textoComentarioInput.value.trim();

                    if (tieneEntrenador && !textoComentario) {
                        e.preventDefault();
                        e.stopPropagation();

                        // Mostrar feedback visual
                        textoComentarioInput.classList.add('is-invalid');

                        Swal.fire({
                            title: 'Comentario requerido',
                            text: 'Debes dejar un comentario cuando finalizas una rutina asignada por un entrenador.',
                            icon: 'error',
                            confirmButtonColor: '#dc3545'
                        });

                        return false;
                    }

                    // Si todo est√° bien, mostrar confirmaci√≥n final
                    if (tieneEntrenador) {
                        e.preventDefault();

                        Swal.fire({
                            title: '¬øConfirmar finalizaci√≥n?',
                            html: 'Al confirmar:<br>‚úì La rutina ser√° finalizada<br>‚úì Tu comentario ser√° enviado<br>‚úì <strong>Tu suscripci√≥n ser√° cancelada</strong>',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#dc3545',
                            cancelButtonColor: '#6c757d',
                            confirmButtonText: 'S√≠, confirmar',
                            cancelButtonText: 'Revisar'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // Enviar formulario
                                e.target.submit();
                            }
                        });
                    }
                });
            }

            // Remover feedback de error al escribir en el comentario
            if (textoComentarioInput) {
                textoComentarioInput.addEventListener('input', function() {
                    this.classList.remove('is-invalid');
                });
            }
        });

        // ========== VALIDACI√ìN PARA FINALIZAR RUTINA (funci√≥n global) ========== //
        function validarFinalizarRutina() {
            const btnFinalizar = document.querySelector('.btn-finalizar');
            if (!btnFinalizar) return;

            const tieneEntrenador = btnFinalizar.getAttribute('data-tiene-entrenador') === 'true';
            const rutinaNombre = btnFinalizar.getAttribute('data-rutina-nombre');

            if (!tieneEntrenador) {
                // Si NO tiene entrenador, mostrar alerta de confirmaci√≥n simple
                Swal.fire({
                    title: '¬øFinalizar rutina?',
                    html: `Est√°s por finalizar la rutina <strong>${rutinaNombre}</strong>.<br>Despu√©s podr√°s adoptar otra.`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'S√≠, finalizar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Enviar formulario directamente sin comentario
                        const form = document.getElementById('formFinalizarRutina');
                        if (form) form.submit();
                    }
                });
            } else {
                // Si tiene entrenador, mostrar alerta de advertencia sobre cancelaci√≥n de suscripci√≥n
                Swal.fire({
                    title: '‚ö†Ô∏è Advertencia',
                    html: `Al finalizar la rutina <strong>${rutinaNombre}</strong>, tu suscripci√≥n con el entrenador ser√° <strong>cancelada</strong>.<br><br>¬øDeseas continuar y dejar tu calificaci√≥n?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'S√≠, continuar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Abrir modal para dejar comentario y calificaci√≥n
                        const modalEl = document.getElementById('modalFinalizarRutina');
                        if (modalEl) {
                            const modal = new bootstrap.Modal(modalEl);
                            modal.show();
                        }
                    }
                });
            }
        }

        /*]]>*/
    </script>
</section>
</body>
</html>
