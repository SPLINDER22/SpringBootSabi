<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Mi Rutina</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: #f8f9fa;
        }

        .container-fluid {
            padding: 20px;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
            height: calc(100vh - 140px);
        }

        /* Panel izquierdo - Acordeón */
        .left-panel {
            background: white;
            border-radius: 12px;
            padding: 15px;
            overflow-y: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Semanas */
        .semana-header {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 10px;
            font-weight: 700;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            box-shadow: 0 2px 6px rgba(6, 182, 212, 0.3);
        }

        .semana-header:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.4);
        }

        .semana-header i {
            transition: transform 0.3s;
        }

        .semana-header.collapsed i {
            transform: rotate(-90deg);
        }

        .semana-content {
            padding-left: 10px;
            margin-bottom: 15px;
        }

        /* Días */
        .dia-header {
            background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%);
            color: white;
            padding: 12px 18px;
            border-radius: 25px;
            cursor: pointer;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(132, 204, 22, 0.3);
        }

        .dia-header:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 8px rgba(132, 204, 22, 0.4);
        }

        .dia-header i {
            transition: transform 0.3s;
        }

        .dia-header.collapsed i {
            transform: rotate(-90deg);
        }

        .dia-content {
            padding-left: 15px;
            margin-bottom: 10px;
        }

        /* Ejercicios */
        .ejercicio-btn {
            background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
            color: white;
            padding: 10px 16px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 0.95rem;
            display: block;
            width: 100%;
            text-align: left;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(168, 85, 247, 0.3);
        }

        .ejercicio-btn:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 8px rgba(168, 85, 247, 0.4);
        }

        .ejercicio-btn.selected {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.6);
            font-weight: 700;
            transform: translateX(8px) scale(1.02);
        }

        /* Panel derecho - Formulario de series */
        .right-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            overflow-y: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .series-container {
            display: none;
        }

        .series-container.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .serie-card {
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #0284c7;
            box-shadow: 0 2px 6px rgba(2, 132, 199, 0.2);
        }

        .serie-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #0c4a6e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .serie-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 10px;
        }

        .info-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .info-label {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #0f172a;
        }

        .ejercicio-info {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #0284c7;
        }

        .ejercicio-nombre {
            font-size: 1.5rem;
            font-weight: 800;
            color: #0c4a6e;
            margin-bottom: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .header-title {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }

        .btn-finalizar {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white !important;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 6px rgba(220, 38, 38, 0.3);
        }

        .btn-finalizar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
            color: white !important;
        }

        .comentarios-section {
            background: #fefce8;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 4px solid #eab308;
        }

        .comentarios-label {
            font-weight: 600;
            color: #854d0e;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .comentarios-text {
            color: #713f12;
            font-style: italic;
            margin: 0;
        }

        .planeado-box {
            background: #eef2f3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #0c4a6e;
        }

        .planeado-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #0c4a6e;
        }
    </style>
</head>
<body th:replace="layout/layout :: layout('Mi Rutina', ~{::section})">
<section th:fragment="section">
    <div class="header-title">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-1" style="font-weight: 800;">
                    <i class="fas fa-dumbbell me-2"></i>
                    <span th:text="${rutina.nombre}">Mi Rutina</span>
                </h2>
                <p class="mb-0" style="opacity: 0.9;">
                    <i class="fas fa-target me-1"></i>
                    <span th:text="${rutina.objetivo}">Objetivo</span>
                </p>
            </div>
            <button type="button" class="btn btn-finalizar" data-bs-toggle="modal" data-bs-target="#modalFinalizarRutina">
                <i class="fas fa-flag-checkered me-2"></i>Finalizar Rutina
            </button>
        </div>
    </div>

    <div class="main-layout">
        <!-- Panel Izquierdo: Acordeón de Semanas > Días > Ejercicios -->
        <div class="left-panel">
            <!-- Mensaje si no hay semanas -->
            <div th:if="${semanasCompletas == null || semanasCompletas.isEmpty()}" class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Esta rutina aún no tiene semanas configuradas. Contacta a tu entrenador.
            </div>

            <div th:each="semanaData, semanaIter : ${semanasCompletas}"
                 th:with="semana=${semanaData.semana},
                          semanaId=${semana != null ? semana.id : 0},
                          semanaNum=${semana != null ? semana.numeroSemana : 0}">

                <!-- Header de Semana -->
                <div class="semana-header collapsed"
                     th:id="'semana-header-' + ${semanaId}"
                     th:attr="data-bs-toggle='collapse', data-bs-target='#semana-content-' + ${semanaId}">
                    <span>
                        <i class="fas fa-calendar-week me-2"></i>
                        SEMANA <span th:text="${semanaNum}">1</span>
                    </span>
                    <i class="fas fa-chevron-down"></i>
                </div>

                <!-- Contenido de Semana (Días) -->
                <div class="collapse semana-content"
                     th:id="'semana-content-' + ${semanaId}">

                    <!-- Mensaje si no hay días -->
                    <div th:if="${semanaData.dias == null || semanaData.dias.isEmpty()}" class="alert alert-info mx-2 my-2">
                        <i class="fas fa-info-circle me-2"></i>
                        Esta semana aún no tiene días configurados.
                    </div>

                    <div th:each="diaData : ${semanaData.dias}"
                         th:with="dia=${diaData.dia},
                                  diaId=${dia != null ? dia.id : 0},
                                  diaNum=${dia != null ? dia.numeroDia : 0}">

                        <!-- Header de Día -->
                        <div class="dia-header collapsed"
                             th:id="'dia-header-' + ${diaId}"
                             th:attr="data-bs-toggle='collapse', data-bs-target='#dia-content-' + ${diaId}">
                            <span>
                                <i class="fas fa-calendar-day me-2"></i>
                                Día <span th:text="${diaNum}">1</span>
                            </span>
                            <i class="fas fa-chevron-down"></i>
                        </div>

                        <!-- Contenido de Día (Ejercicios) -->
                        <div class="collapse dia-content"
                             th:id="'dia-content-' + ${diaId}">

                            <!-- Mensaje si no hay ejercicios -->
                            <div th:if="${diaData.ejercicios == null || diaData.ejercicios.isEmpty()}" class="alert alert-info mx-2 my-2">
                                <i class="fas fa-info-circle me-2"></i>
                                Este día aún no tiene ejercicios configurados.
                            </div>

                            <div th:each="ejeData : ${diaData.ejercicios}"
                                 th:with="eje=${ejeData.ejercicio},
                                          ejeId=${eje != null ? eje.idEjercicioAsignado : 0},
                                          nombreEjercicio=${eje != null ? eje.nombreEjercicio : 'Ejercicio'}">

                                <!-- Botón de Ejercicio -->
                                <button class="ejercicio-btn"
                                        th:id="'ejercicio-btn-' + ${ejeId}"
                                        th:attr="data-ejercicio-id=${ejeId}"
                                        onclick="seleccionarEjercicio(this)">
                                    <i class="fas fa-running me-2"></i>
                                    <span th:text="${nombreEjercicio}">Ejercicio</span>
                                </button>

                                <!-- Container de Series (oculto, se muestra en panel derecho) -->
                                <div class="series-data"
                                     th:id="'series-data-' + ${ejeId}"
                                     style="display: none;"
                                     th:attr="data-ejercicio-nombre=${nombreEjercicio},
                                              data-ejercicio-comentarios=${eje != null ? eje.comentarios : ''}">
                                    <div th:each="serieMap : ${ejeData.series}"
                                         th:with="serie=${serieMap.serie},
                                                  registro=${serieMap.registro}"
                                         class="serie-data-item"
                                         th:attr="data-serie-id=${serie != null ? serie.id : 0},
                                                  data-serie-num=${serie != null ? serie.orden : 0},
                                                  data-repeticiones=${serie != null ? serie.repeticiones : 0},
                                                  data-peso=${serie != null ? serie.peso : 0},
                                                  data-descanso=${serie != null ? serie.descanso : 0},
                                                  data-intensidad=${serie != null ? serie.intensidad : ''},
                                                  data-comentarios=${serie != null ? serie.comentarios : ''},
                                                  data-registro-reps=${registro != null ? registro.repeticionesReales : ''},
                                                  data-registro-peso=${registro != null ? registro.pesoReal : ''},
                                                  data-registro-descanso=${registro != null ? registro.descansoReal : ''},
                                                  data-registro-intensidad=${registro != null ? registro.intensidadReal : ''},
                                                  data-registro-notas=${registro != null ? registro.comentariosCliente : ''}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel Derecho: Formulario de Series -->
        <div class="right-panel">
            <div id="series-display">
                <div class="empty-state">
                    <i class="fas fa-hand-pointer"></i>
                    <h4>Selecciona un ejercicio</h4>
                    <p>Haz clic en cualquier ejercicio del panel izquierdo para ver sus series</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Finalizar Rutina -->
    <div class="modal fade" id="modalFinalizarRutina" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-flag-checkered me-2"></i>Finalizar Rutina
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form th:action="@{'/rutinas/finalizar-comentario/' + ${rutina.idRutina}}" method="post">
                    <div class="modal-body">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <p class="mb-3">
                            Estás por finalizar la rutina <strong th:text="${rutina.nombre}"></strong>.
                            Después podrás adoptar otra. Puedes dejar un comentario y calificación para tu entrenador.
                        </p>
                        <div class="mb-3">
                            <label for="textoComentario" class="form-label">Comentario (opcional)</label>
                            <textarea class="form-control" id="textoComentario" name="texto" rows="4"
                                      placeholder="¿Cómo fue tu experiencia con esta rutina?" maxlength="500"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="calificacion" class="form-label">Calificación (0 - 5, opcional)</label>
                            <input type="number" class="form-control" id="calificacion" name="calificacion"
                                   min="0" max="5" step="0.5" placeholder="Ej: 4.5"/>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-check me-2"></i>Confirmar Finalización
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        // Parámetros de navegación automática desde el servidor
        const autoSemanaId = /*[[${autoSemanaId}]]*/ null;
        const autoDiaId = /*[[${autoDiaId}]]*/ null;
        const autoEjercicioId = /*[[${autoEjercicioId}]]*/ null;

        // Función para abrir automáticamente elementos al cargar
        function navegacionAutomatica() {
            if (autoSemanaId) {
                console.log('Navegación automática activada:');
                console.log('- Semana ID:', autoSemanaId);
                console.log('- Día ID:', autoDiaId);
                console.log('- Ejercicio ID:', autoEjercicioId);

                // Abrir semana
                const semanaCollapse = document.getElementById('semana-content-' + autoSemanaId);
                const semanaHeader = document.getElementById('semana-header-' + autoSemanaId);
                if (semanaCollapse && semanaHeader) {
                    // Remover clase collapsed del header
                    semanaHeader.classList.remove('collapsed');

                    // Abrir el collapse
                    const bsCollapse = new bootstrap.Collapse(semanaCollapse, { toggle: false });
                    bsCollapse.show();

                    // Después de abrir la semana, abrir el día
                    setTimeout(() => {
                        if (autoDiaId) {
                            const diaCollapse = document.getElementById('dia-content-' + autoDiaId);
                            const diaHeader = document.getElementById('dia-header-' + autoDiaId);
                            if (diaCollapse && diaHeader) {
                                // Remover clase collapsed del header
                                diaHeader.classList.remove('collapsed');

                                // Abrir el collapse
                                const bsDiaCollapse = new bootstrap.Collapse(diaCollapse, { toggle: false });
                                bsDiaCollapse.show();

                                // Después de abrir el día, seleccionar el ejercicio
                                setTimeout(() => {
                                    if (autoEjercicioId) {
                                        const ejercicioBtn = document.getElementById('ejercicio-btn-' + autoEjercicioId);
                                        if (ejercicioBtn) {
                                            // Hacer scroll al ejercicio
                                            ejercicioBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                            // Seleccionar y mostrar el ejercicio
                                            setTimeout(() => {
                                                ejercicioBtn.click();
                                            }, 500);
                                        } else {
                                            console.error('No se encontró el botón del ejercicio con ID:', autoEjercicioId);
                                        }
                                    }
                                }, 400);
                            } else {
                                console.error('No se encontró el día con ID:', autoDiaId);
                            }
                        }
                    }, 400);
                } else {
                    console.error('No se encontró la semana con ID:', autoSemanaId);
                }
            }
        }

        function seleccionarEjercicio(btnElement) {
            const ejercicioId = btnElement.getAttribute('data-ejercicio-id');

            // Remover selección previa
            document.querySelectorAll('.ejercicio-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            // Marcar como seleccionado
            btnElement.classList.add('selected');

            // Obtener datos de las series
            const seriesData = document.getElementById('series-data-' + ejercicioId);
            const ejercicioNombre = seriesData.getAttribute('data-ejercicio-nombre');
            const ejercicioComentarios = seriesData.getAttribute('data-ejercicio-comentarios');
            const seriesItems = seriesData.querySelectorAll('.serie-data-item');

            // Construir HTML del panel derecho
            let html = `
                <div class="ejercicio-info">
                    <div class="ejercicio-nombre">
                        <i class="fas fa-running me-2"></i>${ejercicioNombre}
                    </div>
                    ${ejercicioComentarios && ejercicioComentarios !== 'null' && ejercicioComentarios !== '' ? `
                        <div class="comentarios-section">
                            <div class="comentarios-label">
                                <i class="fas fa-comment-dots me-1"></i>Comentarios del entrenador:
                            </div>
                            <p class="comentarios-text">${ejercicioComentarios}</p>
                        </div>
                    ` : ''}
                </div>
            `;

            if (seriesItems.length === 0) {
                html += `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Este ejercicio aún no tiene series asignadas.
                    </div>
                `;
            } else {
                seriesItems.forEach((item, index) => {
                    const serieId = item.getAttribute('data-serie-id');
                    const serieNum = item.getAttribute('data-serie-num');
                    const repsPlaneadas = item.getAttribute('data-repeticiones');
                    const pesoPlaneado = item.getAttribute('data-peso');
                    const descanso = item.getAttribute('data-descanso');
                    const intensidad = item.getAttribute('data-intensidad');
                    const comentarios = item.getAttribute('data-comentarios');

                    // Obtener datos del registro guardado (si existe)
                    const registroReps = item.getAttribute('data-registro-reps');
                    const registroPeso = item.getAttribute('data-registro-peso');
                    const registroDescanso = item.getAttribute('data-registro-descanso');
                    const registroIntensidad = item.getAttribute('data-registro-intensidad');
                    const registroNotas = item.getAttribute('data-registro-notas');

                    const tieneRegistro = registroReps && registroReps !== '' && registroReps !== 'null';

                    html += `
                        <div class="serie-card">
                            <div class="serie-title">
                                <i class="fas fa-hashtag"></i>
                                Serie ${serieNum || (index + 1)}
                                ${tieneRegistro ? '<span class="badge bg-success ms-2"><i class="fas fa-check me-1"></i>Completado</span>' : ''}
                            </div>

                            <!-- Información planeada por el entrenador -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="planeado-box">
                                        <label class="form-label mb-1">
                                            <i class="fas fa-clipboard-list me-1"></i>
                                            <strong>Repeticiones planeadas:</strong>
                                        </label>
                                        <div class="planeado-value">${repsPlaneadas || 'No especificado'}</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="planeado-box">
                                        <label class="form-label mb-1">
                                            <i class="fas fa-weight-hanging me-1"></i>
                                            <strong>Peso planeado:</strong>
                                        </label>
                                        <div class="planeado-value">${pesoPlaneado ? pesoPlaneado + ' kg' : 'No especificado'}</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="planeado-box">
                                        <label class="form-label mb-1">
                                            <i class="fas fa-fire me-1"></i>
                                            <strong>Intensidad sugerida:</strong>
                                        </label>
                                        <div class="planeado-value">${intensidad || 'No especificado'}</div>
                                    </div>
                                </div>
                            </div>

                            ${comentarios && comentarios !== 'null' && comentarios !== '' ? `
                                <div class="comentarios-section mb-3">
                                    <div class="comentarios-label">
                                        <i class="fas fa-comment me-1"></i>Notas de la serie:
                                    </div>
                                    <p class="comentarios-text">${comentarios}</p>
                                </div>
                            ` : ''}

                            ${descanso && descanso !== 'null' && descanso !== '' && descanso !== '0' ? `
                                <div class="alert alert-info py-2 mb-3">
                                    <i class="fas fa-clock me-1"></i>
                                    <strong>Descanso sugerido:</strong> ${descanso} seg
                                </div>
                            ` : ''}

                            <!-- Formulario de registro -->
                            <form class="registro-serie-form" data-serie-id="${serieId}" onsubmit="return registrarSerie(event, ${serieId})">
                                <div class="registro-section">
                                    <h6 class="mb-3" style="color: #0c4a6e; font-weight: 700;">
                                        <i class="fas fa-pencil-alt me-2"></i>${tieneRegistro ? 'Tu registro:' : 'Registra lo que hiciste:'}
                                    </h6>
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label class="form-label">Repeticiones realizadas</label>
                                            <input type="number" class="form-control ${tieneRegistro ? 'form-guardado' : ''}" name="repeticionesRealizadas"
                                                   value="${registroReps || ''}" placeholder="${repsPlaneadas || '10'}" min="0" required
                                                   style="${tieneRegistro ? 'background-color: #e8f5e9; border-color: #4caf50;' : ''}">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Peso usado (kg)</label>
                                            <input type="number" step="0.25" class="form-control ${tieneRegistro ? 'form-guardado' : ''}" name="pesoRealizado"
                                                   value="${registroPeso || ''}" placeholder="${pesoPlaneado || '20'}" min="0" required
                                                   style="${tieneRegistro ? 'background-color: #e8f5e9; border-color: #4caf50;' : ''}">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Intensidad</label>
                                            <select class="form-select ${tieneRegistro ? 'form-guardado' : ''}" name="intensidadRealizada" required
                                                    style="${tieneRegistro ? 'background-color: #e8f5e9; border-color: #4caf50;' : ''}">
                                                <option value="">Selecciona...</option>
                                                <option value="BAJA" ${registroIntensidad === 'BAJA' ? 'selected' : ''}>Baja</option>
                                                <option value="MEDIA" ${registroIntensidad === 'MEDIA' ? 'selected' : ''}>Media</option>
                                                <option value="ALTA" ${registroIntensidad === 'ALTA' ? 'selected' : ''}>Alta</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Descanso (segundos)</label>
                                            <input type="number" class="form-control ${tieneRegistro ? 'form-guardado' : ''}" name="descansoRealizado"
                                                   value="${registroDescanso || ''}" placeholder="${descanso || '60'}" min="0"
                                                   style="${tieneRegistro ? 'background-color: #e8f5e9; border-color: #4caf50;' : ''}">
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">Notas adicionales (opcional)</label>
                                            <textarea class="form-control ${tieneRegistro ? 'form-guardado' : ''}" name="notasCliente" rows="2"
                                                      placeholder="¿Cómo te sentiste? ¿Alguna observación?"
                                                      style="${tieneRegistro ? 'background-color: #e8f5e9; border-color: #4caf50;' : ''}">${registroNotas && registroNotas !== 'null' ? registroNotas : ''}</textarea>
                                        </div>
                                        <div class="col-12">
                                            <button type="submit" class="btn ${tieneRegistro ? 'btn-warning' : 'btn-primary'} w-100">
                                                <i class="fas ${tieneRegistro ? 'fa-edit' : 'fa-check'} me-2"></i>${tieneRegistro ? 'Actualizar Registro' : 'Registrar Serie'}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    `;
                });
            }

            // Actualizar panel derecho
            document.getElementById('series-display').innerHTML = html;
        }

        function registrarSerie(event, serieId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            // Preparar el objeto para enviar al backend
            const registroData = {
                idSerie: serieId,
                repeticionesReales: parseInt(formData.get('repeticionesRealizadas')),
                pesoReal: parseFloat(formData.get('pesoRealizado')),
                intensidadReal: formData.get('intensidadRealizada'),
                descansoReal: formData.get('descansoRealizado') ? parseInt(formData.get('descansoRealizado')) : null,
                comentariosCliente: formData.get('notasCliente') || null
            };

            // Obtener el token CSRF
            const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content') ||
                             document.querySelector('input[name="_csrf"]')?.value;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content') || 'X-CSRF-TOKEN';

            // Mostrar indicador de carga
            const btn = form.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
            btn.disabled = true;

            // Enviar al backend con AJAX
            fetch('/api/registros-series/guardar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify(registroData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ====== ACTUALIZAR LOS ATRIBUTOS DATA EN EL HTML ORIGINAL ======
                    // Buscar el elemento serie-data-item correspondiente en el DOM original
                    const serieDataItem = document.querySelector(`.serie-data-item[data-serie-id="${serieId}"]`);
                    if (serieDataItem) {
                        // Actualizar los atributos data-registro-* con los nuevos valores
                        serieDataItem.setAttribute('data-registro-reps', registroData.repeticionesReales);
                        serieDataItem.setAttribute('data-registro-peso', registroData.pesoReal);
                        serieDataItem.setAttribute('data-registro-descanso', registroData.descansoReal || '');
                        serieDataItem.setAttribute('data-registro-intensidad', registroData.intensidadReal || '');
                        serieDataItem.setAttribute('data-registro-notas', registroData.comentariosCliente || '');
                        console.log('Atributos data actualizados para serie ' + serieId);
                    }
                    // ================================================================

                    // Éxito: mostrar mensaje y cambiar botón a verde
                    btn.innerHTML = '<i class="fas fa-check-circle me-2"></i>¡Guardado!';
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-success');

                    // Deshabilitar los campos del formulario para mostrar que ya está guardado
                    const inputs = form.querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        input.style.backgroundColor = '#e8f5e9';
                        input.style.borderColor = '#4caf50';
                    });

                    // Agregar badge de "Completado"
                    const serieCard = form.closest('.serie-card');
                    if (serieCard && !serieCard.querySelector('.badge-completado')) {
                        const serieTitle = serieCard.querySelector('.serie-title');
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-success badge-completado ms-2';
                        badge.innerHTML = '<i class="fas fa-check me-1"></i>Completado';
                        serieTitle.appendChild(badge);
                    }

                    // Cambiar texto del botón permanentemente
                    setTimeout(() => {
                        btn.innerHTML = '<i class="fas fa-edit me-2"></i>Actualizar Registro';
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-warning');
                        btn.disabled = false;
                    }, 1500);
                } else {
                    // Error: mostrar mensaje
                    btn.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i>Error';
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-danger');
                    alert('Error al guardar: ' + (data.message || 'Error desconocido'));

                    // Resetear después de 2 segundos
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.classList.remove('btn-danger');
                        btn.classList.add('btn-primary');
                        btn.disabled = false;
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                btn.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i>Error';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-danger');
                alert('Error de conexión. Por favor, intenta nuevamente.');

                // Resetear después de 2 segundos
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-primary');
                    btn.disabled = false;
                }, 2000);
            });

            return false;
        }

        // Manejar colapso de acordeones
        document.addEventListener('DOMContentLoaded', function() {
            // Manejar iconos de chevron en semanas
            document.querySelectorAll('.semana-header').forEach(header => {
                const target = header.getAttribute('data-bs-target');
                const collapseElement = document.querySelector(target);

                collapseElement.addEventListener('show.bs.collapse', () => {
                    header.classList.remove('collapsed');
                });

                collapseElement.addEventListener('hide.bs.collapse', () => {
                    header.classList.add('collapsed');
                });
            });

            // Manejar iconos de chevron en días
            document.querySelectorAll('.dia-header').forEach(header => {
                const target = header.getAttribute('data-bs-target');
                const collapseElement = document.querySelector(target);

                collapseElement.addEventListener('show.bs.collapse', () => {
                    header.classList.remove('collapsed');
                });

                collapseElement.addEventListener('hide.bs.collapse', () => {
                    header.classList.add('collapsed');
                });
            });

            // Ejecutar navegación automática si hay parámetros
            navegacionAutomatica();
        });
        /*]]>*/
    </script>
</section>
</body>
</html>
