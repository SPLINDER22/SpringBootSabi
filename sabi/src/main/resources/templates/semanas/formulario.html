<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="layout/layout :: layout('Registro de semana',~{::section})">
<body>
<section th:fragment="section">
    <div class="shadow-sm bg-white rounded p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 th:text="${semana.idSemana == null ? 'Crear semana' : 'Editar semana'}"></h2>
            <a th:href="@{'/semanas/detallar/' + ${semana.idRutina}}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left-circle me-1"></i>Volver a la lista
            </a>
        </div>

        <!-- Mostrar datos básicos de la rutina -->
        <div class="mb-3" th:if="${rutina != null}">
            <strong>Rutina:</strong> <span th:text="${rutina.nombre}"></span>
            <span class="text-muted">(ID: <span th:text="${rutina.idRutina}"></span>)</span>
        </div>

        <form th:action="@{/semanas/guardar}" th:object="${semana}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <input type="hidden" th:field="*{idSemana}"/>
            <input type="hidden" th:field="*{idRutina}"/>

            <!-- Campo Orden (numeroSemana) -->
            <!-- En creación viene ya preasignado desde el controlador y es readonly -->
            <div class="mb-3" th:if="${semana.idSemana == null}">
                <label for="numeroSemana" class="form-label">Orden de semana</label>
                <input type="number" id="numeroSemana" th:field="*{numeroSemana}" class="form-control" readonly min="1"/>
                <div class="form-text">
                    Total semanas existentes: <strong th:text="${totalSemanas}">0</strong>. Esta será la número <strong th:text="${semana.numeroSemana}"></strong>.
                </div>
            </div>
            <!-- En edición editable con límite -->
            <div class="mb-3" th:if="${semana.idSemana != null}">
                <label for="numeroSemana" class="form-label">Orden de semana</label>
                <input type="number" id="numeroSemana" th:field="*{numeroSemana}" class="form-control" min="1" th:attr="max=${rutina != null && rutina.numeroSemanas != null ? rutina.numeroSemanas : totalSemanas}" required/>
                <div class="form-text">
                    Máximo permitido: <span th:text="${rutina != null && rutina.numeroSemanas != null ? rutina.numeroSemanas : totalSemanas}"></span>
                </div>
                <div id="numeroSemanaError" class="text-danger mt-1" style="display:none"></div>
            </div>

            <!-- Descripción (campo real en SemanaDTO) -->
            <div class="mb-3">
                <label for="descripcion" class="form-label">Descripción</label>
                <textarea id="descripcion" th:field="*{descripcion}" class="form-control" rows="3" placeholder="Ej: Semana de carga, Semana de adaptación" required></textarea>
                <div class="text-danger mt-1" th:if="${#fields.hasErrors('descripcion')}" th:errors="*{descripcion}"></div>
            </div>

            <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-success me-2">
                    <i class="bi bi-save me-1"></i>
                    <span th:text="${semana.idSemana == null ? 'Guardar y continuar' : 'Guardar'}"></span>
                </button>
                <a th:href="@{'/semanas/detallar/' + ${semana.idRutina}}" class="btn btn-outline-secondary">Cancelar</a>
            </div>
        </form>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        (function(){
            var input = document.getElementById('numeroSemana');
            if(!input || input.readOnly) return; // sólo edición
            var max = parseInt(input.getAttribute('max'),10) || 1;
            var errorSpan = document.getElementById('numeroSemanaError');
            function showError(msg){ if(errorSpan){ errorSpan.textContent = msg; errorSpan.style.display='block'; } }
            function hideError(){ if(errorSpan){ errorSpan.textContent=''; errorSpan.style.display='none'; } }
            input.addEventListener('input', function(e){
                var v = parseInt(e.target.value,10);
                if(isNaN(v) || v < 1){ e.target.value = 1; hideError(); return; }
                if(v > max){ e.target.value = max; showError('El número de semana no puede ser mayor a ' + max); }
                else { hideError(); }
            });
        })();
        /*]]>*/
    </script>
</section>
</body>
</html>