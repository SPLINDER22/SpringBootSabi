<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="layout/layout :: layout('Registro de semana',~{::section})">
<body>
<section th:fragment="section">
    <div class="shadow-sm bg-white rounded p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 th:text="${semana.idSemana == null ? 'Crear semana' : 'Editar semana'}"></h2>
            <!-- Enlace correcto de retorno -->
            <a th:href="@{'/semanas/detallar/' + ${semana.idRutina}}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left-circle me-1"></i>Volver a la lista
            </a>
        </div>

        <form th:action="@{/semanas/guardar}"
              th:object="${semana}"
              th:method="post">
            <!-- CSRF -->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <input type="hidden" th:field="*{idSemana}"/>
            <!-- Aseguramos enviar idRutina -->
            <input type="hidden" th:field="*{idRutina}"/>

            <!-- Campo orden de semana (numeroSemana) -->
            <!-- Modo CREAR: autocalculado (#semanas existentes + 1) -->
            <div class="mb-3" th:if="${semana.idSemana == null}" th:with="totalSemanas=${semanas != null ? #lists.size(semanas) : 0}">
                <label for="numeroSemana" class="form-label">Orden de semana</label>
                <input type="number"
                       id="numeroSemana"
                       th:field="*{numeroSemana}"
                       th:value="${totalSemanas + 1}"
                       class="form-control"
                       readonly
                       min="1"/>
                <div class="form-text">
                    Total semanas actuales: <span th:text="${totalSemanas}"></span>. Esta nueva semana será la número <strong th:text="${totalSemanas + 1}"></strong>.
                </div>
            </div>

            <!-- Modo EDITAR: editable dentro de 1..rutina.numeroSemanas -->
            <div class="mb-3" th:if="${semana.idSemana != null}">
                <label for="numeroSemana" class="form-label">Orden de semana</label>
                <input type="number"
                       id="numeroSemana"
                       th:field="*{numeroSemana}"
                       class="form-control"
                       min="1"
                       th:attr="max=${rutina != null ? rutina.numeroSemanas : (semanas != null ? #lists.size(semanas) : 1)}"
                       required/>
                <div class="form-text">
                    Máximo permitido: <span th:text="${rutina != null ? rutina.numeroSemanas : (semanas != null ? #lists.size(semanas) : 1)}"></span>.
                </div>
                <div id="numeroSemanaError" class="text-danger mt-1" style="display:none"></div>
            </div>

            <div class="mb-3">
                <label for="descripcion" class="form-label">Nombre de la semana</label>
                <input type="text"
                       id="descripcion"
                       th:field="*{nombre}"
                       class="form-control"
                       placeholder="Semana de carga, Semana de descarga, etc."
                       required/>
                <div class="text-danger mt-1"
                     th:if="${#fields.hasErrors('descripcion')}" th:errors="*{descripcion}"></div>
            </div>

            <div class="mb-3">
                <label for="numeroDias" class="form-label">Numero de dias</label>
                <input type="text"
                       id="numeroDias"
                       th:field="*{numeroDias}"
                       class="form-control"
                       placeholder="Cuantos dias de entrenamiento tendrá esta semana"
                       required/>
            </div>
            
            <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-success me-2">
                    <i class="bi bi-save me-1"></i>
                    <span th:text="${semana.idSemana == null ? 'Guardar y continuar' : 'Guardar'}"></span>
                </button>
                <a th:href="@{/rutinas}" class="btn btn-outline-secondary">Cancelar</a>
            </div>
        </form>
    </div>

    <!-- Validación JS solo aplica en modo edición -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        (function(){
            var input = document.getElementById('numeroSemana');
            if(!input || input.readOnly) return; // solo edición
            var max = parseInt(input.getAttribute('max'),10) || 1;
            var errorSpan = document.getElementById('numeroSemanaError');
            function showError(msg){ if(errorSpan){ errorSpan.textContent = msg; errorSpan.style.display='block'; } }
            function hideError(){ if(errorSpan){ errorSpan.textContent=''; errorSpan.style.display='none'; } }
            input.addEventListener('input', function(e){
                var v = parseInt(e.target.value,10);
                if(isNaN(v) || v < 1){ e.target.value = 1; hideError(); return; }
                if(v > max){ e.target.value = max; showError('El número de semana no puede ser mayor a ' + max); }
                else { hideError(); }
            });
        })();
        /*]]>*/
    </script>
</section>
</body>
</html>