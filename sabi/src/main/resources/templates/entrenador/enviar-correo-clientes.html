<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Enviar Correo a Clientes</title>
    <style>
        #mensajesHeader {
            transition: all 0.3s ease;
        }
        #mensajesHeader:hover {
            background: #0056b3 !important;
            transform: translateY(-2px);
        }
        #toggleIcon {
            transition: transform 0.3s ease;
            font-size: 1.2rem;
        }
        #mensajesContent {
            transition: all 0.3s ease;
        }
        
        .mensaje-pregrabado-item {
            cursor: pointer;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            margin-bottom: 8px;
            transition: all 0.3s;
            background: white;
        }
        .mensaje-pregrabado-item:hover {
            background: #e7f1ff;
            border-color: #0d6efd;
            transform: translateX(5px);
        }
        .mensaje-pregrabado-item.selected {
            background: #cfe2ff;
            border-color: #0d6efd;
            border-width: 2px;
        }
        .mensaje-titulo {
            font-weight: 600;
            color: #0d6efd;
            margin-bottom: 4px;
        }
        .mensaje-preview {
            font-size: 0.9rem;
            color: #6c757d;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .mensajes-container {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .badge-new {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body th:replace="~{layout/layout :: layout('Enviar Correo a Clientes', ~{::section})}">
<section th:fragment="section">
    <div class="container d-flex justify-content-center align-items-center" style="min-height: 80vh;">
        <div class="card shadow-lg border-primary w-100" style="max-width: 800px;">
            <div class="card-header bg-primary text-white text-center">
                <h2 class="h4 mb-0"><i class="fas fa-envelope me-2"></i>Enviar Correo a Clientes</h2>
            </div>
            <div class="card-body p-4">
                <div th:if="${success}" class="alert alert-success" role="alert" th:text="${success}"></div>
                <div th:if="${error}" class="alert alert-danger" role="alert" th:text="${error}"></div>
                
                <!-- Mensajes Pregrabados - Sección Colapsable -->
                <div class="mb-4" th:if="${mensajesPregrabados != null && !mensajesPregrabados.isEmpty()}">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center" 
                             style="cursor: pointer;" 
                             onclick="toggleMensajes()"
                             id="mensajesHeader">
                            <div>
                                <i class="fas fa-bookmark me-2"></i>
                                <strong>Mensajes Pregrabados</strong>
                                <span class="badge badge-light ml-2" th:text="${#lists.size(mensajesPregrabados)}"></span>
                            </div>
                            <div>
                                <a th:href="@{/mensajes-pregrabados/nuevo}" 
                                   class="btn btn-sm btn-light mr-2"
                                   onclick="event.stopPropagation()">
                                    <i class="fas fa-plus"></i> Crear Nuevo
                                </a>
                                <i class="fas fa-chevron-down" id="toggleIcon"></i>
                            </div>
                        </div>
                        <div class="card-body p-3" id="mensajesContent" style="display: none;">
                            <div class="mensajes-container">
                                <div class="mensaje-pregrabado-item" 
                                     th:each="msg : ${mensajesPregrabados}"
                                     th:attr="data-titulo=${msg.titulo}, data-contenido=${msg.contenido}"
                                     onclick="cargarMensaje(this)">
                                    <div class="mensaje-titulo">
                                        <i class="fas fa-file-alt me-1"></i>
                                        <span th:text="${msg.titulo}"></span>
                                    </div>
                                    <div class="mensaje-preview" th:text="${msg.contenido}"></div>
                                </div>
                            </div>
                            <small class="text-muted mt-2 d-block">
                                <i class="fas fa-info-circle"></i> Haz clic en un mensaje para cargarlo automáticamente
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- Botón para crear primer mensaje si no hay -->
                <div class="alert alert-info mb-4" th:if="${mensajesPregrabados == null || mensajesPregrabados.isEmpty()}">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>Tip:</strong> Crea mensajes pregrabados para enviar correos más rápido.
                    <a th:href="@{/mensajes-pregrabados/nuevo}" class="alert-link">Crear mi primer mensaje</a>
                </div>
                
                <form th:action="@{/entrenador/enviar-correo-clientes}" method="post">
                    <div class="mb-3">
                        <label for="asunto" class="form-label"><i class="fas fa-heading me-1"></i> Asunto</label>
                        <input type="text" class="form-control" id="asunto" name="asunto" required placeholder="Motivo del correo">
                    </div>
                    <div class="mb-3">
                        <label for="mensaje" class="form-label"><i class="fas fa-align-left me-1"></i> Mensaje</label>
                        <textarea class="form-control" id="mensaje" name="mensaje" rows="6" required placeholder="Escribe el mensaje aquí..."></textarea>
                        <small class="form-text text-muted">
                            <span id="charCount">0</span> caracteres
                        </small>
                    </div>
                    <div class="mb-3">
                        <label for="idsClientes" class="form-label"><i class="fas fa-users me-1"></i> Selecciona los clientes</label>
                        <select class="form-select" id="idsClientes" name="idsClientes" multiple required size="6">
                            <option th:each="cliente : ${clientes}" th:value="${cliente.id}" th:text="${cliente.nombre + ' (' + cliente.email + ')'}"></option>
                        </select>
                        <small class="form-text text-muted">Puedes seleccionar uno o varios clientes manteniendo presionada la tecla Ctrl o Shift.</small>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-paper-plane me-1"></i> Enviar Correo</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        // Función para expandir/colapsar mensajes pregrabados
        function toggleMensajes() {
            const content = document.getElementById('mensajesContent');
            const icon = document.getElementById('toggleIcon');
            const header = document.getElementById('mensajesHeader');
            
            if (content.style.display === 'none') {
                // Expandir
                content.style.display = 'block';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
                header.classList.add('shadow-sm');
            } else {
                // Colapsar
                content.style.display = 'none';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
                header.classList.remove('shadow-sm');
            }
        }
        
        function cargarMensaje(element) {
            // Remover selección previa
            document.querySelectorAll('.mensaje-pregrabado-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Marcar como seleccionado
            element.classList.add('selected');
            
            // Obtener datos
            const titulo = element.getAttribute('data-titulo');
            const contenido = element.getAttribute('data-contenido');
            
            // Cargar en el formulario
            document.getElementById('asunto').value = titulo;
            document.getElementById('mensaje').value = contenido;
            
            // Actualizar contador
            actualizarContador();
            
            // Efecto visual
            element.style.animation = 'pulse 0.3s';
            setTimeout(() => {
                element.style.animation = '';
            }, 300);
            
            // Colapsar mensajes después de seleccionar
            setTimeout(() => {
                toggleMensajes();
            }, 400);
        }
        
        // Contador de caracteres
        const mensajeTextarea = document.getElementById('mensaje');
        const charCount = document.getElementById('charCount');
        
        function actualizarContador() {
            charCount.textContent = mensajeTextarea.value.length;
        }
        
        mensajeTextarea.addEventListener('input', actualizarContador);
    </script>
    
    <style>
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
    </style>
</section>
</body>
</html>
