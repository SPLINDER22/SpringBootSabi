<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Lista De Suscripciones</title>
</head>

<body th:replace="layout/layout :: layout('Lista de suscripciones', ~{::section})">
    <section th:fragment="section">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 text-dark mb-0">Lista de Suscripciones</h1>
            <div class="d-flex align-items-center">
                <a th:href="@{/entrenador/suscripciones/historial}" class="btn btn-outline-secondary btn-lg">
                    <i class="fas fa-history me-1"></i> Ver Historial
                </a>
                <a th:href="@{/entrenador/suscripciones/reporte.pdf}" class="btn btn-danger btn-lg ml-2">
                    <i class="bi bi-filetype-pdf me-1"></i> Generar reporte
                </a>
            </div>
        </div>
        <!-- Modal Ver Diagnóstico -->
        <div class="modal fade" id="modalDiagnostico" tabindex="-1" aria-labelledby="modalDiagnosticoLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalDiagnosticoLabel">Último Diagnóstico</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Fecha:</strong> <span id="diagnosticoFecha"></span></p>
                        <p><strong>Peso:</strong> <span id="diagnosticoPeso"></span> kg</p>
                        <p><strong>Estatura:</strong> <span id="diagnosticoEstatura"></span> cm</p>
                        <p><strong>Nivel de Experiencia:</strong> <span id="diagnosticoNivelExperiencia"></span></p>
                        <p><strong>Disponibilidad de Tiempo:</strong> <span id="diagnosticoDisponibilidad"></span></p>
                        <p><strong>Acceso a Recursos:</strong> <span id="diagnosticoRecursos"></span></p>
                        <p><strong>Lesiones:</strong> <span id="diagnosticoLesiones"></span></p>
                        <p><strong>Condiciones Médicas:</strong> <span id="diagnosticoCondiciones"></span></p>
                        <p><strong>Porcentaje de Grasa Corporal:</strong> <span id="diagnosticoGrasa"></span>%</p>
                        <p><strong>Circunferencia Cintura:</strong> <span id="diagnosticoCintura"></span> cm</p>
                        <p><strong>Circunferencia Cadera:</strong> <span id="diagnosticoCadera"></span> cm</p>
                        <p><strong>Frecuencia Cardiaca en Reposo:</strong> <span id="diagnosticoFrecuencia"></span> bpm</p>
                        <p><strong>Presión Arterial:</strong> <span id="diagnosticoPresion"></span></p>
                        <p><strong>Hábitos Alimenticios:</strong> <span id="diagnosticoHabitos"></span></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="row g-4">
                <div th:if="${#lists.isEmpty(suscripciones)}" class="col-12 d-flex justify-content-center">
                    <div class="alert alert-info text-center w-50 mt-5" role="alert">
                        <strong>Aún no hay suscripciones</strong><br>
                        Cuando tengas alguna, aquí se mostrarán.
                    </div>
                </div>
                <div th:each="suscripcion : ${suscripciones}" class="col-12 col-md-6 mb-4">
                    <div class="card w-100 shadow-lg border-primary rounded-4 text-center">
                        <div class="card-header text-dark bg-primary">
                            <h5 class="fw-semibold mb-0">Detalles de la Suscripción</h5>
                        </div>
                        <div class="card-body py-4">
                            <div class="d-flex flex-column align-items-center mb-3">
                                <h4 class="card-title fw-semibold mb-1">Cliente: <strong
                                        th:text="${nombresClientes[suscripcion.idCliente]} ?: 'Cliente'">Cliente</strong>
                                </h4>
                                <span class="text-dark mb-1">Estado de la suscripción</span>
                                <span class="badge rounded-pill px-3 py-2 text-uppercase fs-6"
                                    th:text="${suscripcion.estadoSuscripcion}"
                                    th:classappend="${suscripcion.estadoSuscripcion == 'ACEPTADA' ? ' bg-success' : (suscripcion.estadoSuscripcion == 'COTIZADA' ? ' bg-info text-dark' : (suscripcion.estadoSuscripcion == 'RECHAZADA' ? ' bg-danger' : (suscripcion.estadoSuscripcion == 'PENDIENTE' ? ' bg-warning text-dark' : (suscripcion.estadoSuscripcion == 'CANCELADA' ? ' bg-secondary' : ' bg-light text-dark'))))}">
                                    Estado
                                </span>
                            </div>

                            <div class="row g-3 g-md-3 justify-content-center">
                                <div class="col-12 col-md-4">
                                    <div class="d-flex flex-column align-items-center p-2">
                                        <div class="fs-6 text-dark mb-1"><i class="fas fa-dollar-sign text-primary me-2"></i> Precio</div>
                                        <div class="fw-semibold fs-6" th:text="${suscripcion.precio != null ? #numbers.formatDecimal(suscripcion.precio, 1, 'COMMA', 2, 'POINT') : 'Por Definirse'}">Por Definirse</div>
                                    </div>
                                </div>
                                <div class="col-12 col-md-4">
                                    <div class="d-flex flex-column align-items-center p-2">
                                        <div class="fs-6 text-dark mb-1">
                                            <i class="fas fa-play text-primary me-2"></i> Fecha de Inicio
                                        </div>
                                        <div class="fw-semibold fs-6"
                                            th:text="${suscripcion.fechaInicio != null ? #temporals.format(suscripcion.fechaInicio, 'yyyy-MM-dd') : 'Por Definirse'}">
                                            Por Definirse</div>
                                    </div>
                                </div>
                                <div class="col-12 col-md-4">
                                    <div class="d-flex flex-column align-items-center p-2">
                                        <div class="fs-6 text-dark mb-1">
                                            <i class="fas fa-flag-checkered text-primary me-2"></i> Fecha de Fin
                                        </div>
                                        <div class="fw-semibold fs-6"
                                            th:text="${suscripcion.fechaFin != null ? #temporals.format(suscripcion.fechaFin, 'yyyy-MM-dd') : 'Por Definirse'}">
                                            Por Definirse</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-primary pt-3 pb-3">
                            <div class="d-flex flex-wrap gap-2 w-100 justify-content-center">
                                <div class="d-flex gap-2 w-100">
                                    <!-- Botón editar -->
                                    <button type="button" class="btn btn-light flex-fill btn-editar-suscripcion"
                                        data-toggle="modal" data-target="#modalEditarSuscripcion"
                                        th:disabled="${suscripcion.estadoSuscripcion == T(com.sabi.sabi.entity.enums.EstadoSuscripcion).ACEPTADA}"
                                        th:attr="data-id=${suscripcion.idSuscripcion},
                                                 data-cliente=${suscripcion.idCliente},
                                                 data-entrenador=${suscripcion.idEntrenador},
                                                 data-precio=${suscripcion.precio},
                                                 data-fechainicio=${suscripcion.fechaInicio},
                                                 data-fechafin=${suscripcion.fechaFin},
                                                 data-estado=${suscripcion.estadoSuscripcion}">
                                        <i class="fas fa-edit me-1"></i> Editar
                                    </button>
                                    <!-- Botón rutina (Asignar o Ver progreso) -->
                                    <div th:if="${suscripcion.estadoSuscripcion == T(com.sabi.sabi.entity.enums.EstadoSuscripcion).ACEPTADA}" class="flex-fill">
                                        <a th:if="${rutinasActivasClientes != null and rutinasActivasClientes.containsKey(suscripcion.idCliente)}"
                                           th:href="@{'/semanas/detallar/' + ${rutinasActivasClientes[suscripcion.idCliente]} + '?readonly=true'}"
                                           class="btn btn-primary w-100">
                                            <i class="fas fa-chart-line me-1"></i> Ver progreso
                                        </a>
                                        <a th:if="${rutinasActivasClientes == null || !rutinasActivasClientes.containsKey(suscripcion.idCliente)}"
                                           th:href="@{/rutinas(asignar=true, idCliente=${suscripcion.idCliente})}"
                                           class="btn btn-success w-100">
                                            <i class="fas fa-dumbbell me-1"></i> Asignar rutina
                                        </a>
                                    </div>
                                    <!-- Botón diagnóstico: abre modal con último diagnóstico -->
                                    <a th:if="${suscripcion.idCliente != null && (suscripcion.estadoSuscripcion == T(com.sabi.sabi.entity.enums.EstadoSuscripcion).ACEPTADA
                                                   or suscripcion.estadoSuscripcion == T(com.sabi.sabi.entity.enums.EstadoSuscripcion).COTIZADA
                                                   or suscripcion.estadoSuscripcion == T(com.sabi.sabi.entity.enums.EstadoSuscripcion).PENDIENTE)}"
                                        th:href="@{/entrenador/diagnostico/vista/{clienteId}(clienteId=${suscripcion.idCliente})}"
                                        class="btn btn-info text-white flex-fill">
                                        <i class="fas fa-notes-medical me-1"></i> Ver diagnóstico
                                    </a>
                                    <!-- Botón rechazar (pendiente) -->
                                    <form th:if="${suscripcion.estadoSuscripcion == T(com.sabi.sabi.entity.enums.EstadoSuscripcion).PENDIENTE}"
                                          th:action="@{/suscripciones/rechazar/{id}(id=${suscripcion.idSuscripcion})}"
                                          method="post" class="flex-fill mb-0">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                        <input type="hidden" name="redirectTo" value="/entrenador/suscripciones" />
                                        <button type="submit" class="btn btn-danger w-100"><i class="fas fa-times-circle me-1"></i> Rechazar</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal Editar Suscripción -->
        <div class="modal fade" id="modalEditarSuscripcion" tabindex="-1" aria-labelledby="modalEditarSuscripcionLabel"
            aria-hidden="true" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form th:action="@{/suscripciones/guardar}" method="post">
                        <div class="modal-header">
                            <h5 class="modal-title" id="modalEditarSuscripcionLabel">Editar Suscripción</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar"><span
                                    aria-hidden="true">&times;</span></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" name="idSuscripcion" id="modal-idSuscripcion">

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="modal-precio" class="form-label">Precio</label>
                                    <input type="number" step="0.01" min="0" class="form-control" id="modal-precio"
                                        name="precio">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="modal-fechainicio" class="form-label">Fecha Inicio</label>
                                    <input type="date" class="form-control" id="modal-fechainicio" name="fechaInicio">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="modal-fechafin" class="form-label">Fecha Fin</label>
                                    <input type="date" class="form-control" id="modal-fechafin" name="fechaFin">
                                </div>
                            </div>

                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <input type="hidden" name="redirectTo" value="/entrenador/suscripciones" />
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                            <button type="submit" class="btn btn-primary">Guardar cambios</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <script>
            window.addEventListener('load', function () {
                console.log('Script de edición de suscripción listo.');
                $(document).on('click', '.btn-editar-suscripcion', function (e) {
                    e.preventDefault();
                    var button = $(this);
                    if (!$('#modalEditarSuscripcion').length) {
                        console.error('Modal element not found: #modalEditarSuscripcion');
                        return;
                    }
                    console.log('Abrir modal editar suscripción:', button.data());
                    $('#modal-idSuscripcion').val(button.data('id'));
                    // Se eliminan cliente y entrenador del formulario; no se editan aquí
                    $('#modal-precio').val(button.data('precio') || '');
                    $('#modal-fechainicio').val(button.data('fechainicio') || '');
                    $('#modal-fechafin').val(button.data('fechafin') || '');
                    if (typeof $('#modalEditarSuscripcion').modal === 'function') {
                        // Mueve el modal al <body> para evitar problemas de stacking/overflow
                        $('#modalEditarSuscripcion').appendTo('body').modal('show');
                    } else {
                        console.error('Bootstrap modal plugin not available. Verify bootstrap JS is loaded.');
                    }
                });
            });
        </script>
        <script>
            document.querySelectorAll('.btn-ver-diagnostico').forEach(button => {
                button.addEventListener('click', async () => {
                    const clienteId = button.getAttribute('data-cliente-id');
                    try {
                        const response = await fetch(`/api/entrenador/diagnostico/${clienteId}`);
                        if (!response.ok) {
                            throw new Error('Error al obtener el diagnóstico');
                        }
                        const diagnostico = await response.json();

                        // Rellenar el modal con los datos del diagnóstico
                        document.getElementById('diagnosticoFecha').textContent = diagnostico.fecha || 'N/A';
                        document.getElementById('diagnosticoPeso').textContent = diagnostico.peso || 'N/A';
                        document.getElementById('diagnosticoEstatura').textContent = diagnostico.estatura || 'N/A';
                        document.getElementById('diagnosticoNivelExperiencia').textContent = diagnostico.nivelExperiencia || 'N/A';
                        document.getElementById('diagnosticoDisponibilidad').textContent = diagnostico.disponibilidadTiempo || 'N/A';
                        document.getElementById('diagnosticoRecursos').textContent = diagnostico.accesoRecursos || 'N/A';
                        document.getElementById('diagnosticoLesiones').textContent = diagnostico.lesiones || 'N/A';
                        document.getElementById('diagnosticoCondiciones').textContent = diagnostico.condicionesMedicas || 'N/A';
                        document.getElementById('diagnosticoGrasa').textContent = diagnostico.porcentajeGrasaCorporal || 'N/A';
                        document.getElementById('diagnosticoCintura').textContent = diagnostico.circunferenciaCintura || 'N/A';
                        document.getElementById('diagnosticoCadera').textContent = diagnostico.circunferenciaCadera || 'N/A';
                        document.getElementById('diagnosticoFrecuencia').textContent = diagnostico.frecuenciaCardiacaReposo || 'N/A';
                        document.getElementById('diagnosticoPresion').textContent = diagnostico.presionArterial || 'N/A';
                        document.getElementById('diagnosticoHabitos').textContent = diagnostico.habitosAlimenticios || 'N/A';

                        // Mostrar el modal
                        const modal = new bootstrap.Modal(document.getElementById('modalDiagnostico'));
                        modal.show();
                    } catch (error) {
                        console.error(error);
                        alert('Hubo un error al cargar el diagnóstico.');
                    }
                });
            });
        </script>
    </section>
</body>

</html>