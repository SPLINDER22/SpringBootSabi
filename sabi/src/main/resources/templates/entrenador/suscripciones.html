<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Suscripciones con tus clientes</title>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" th:href="@{/css/suscripciones.css}"/>
    <style>
        /* Estilos para botones de filtro */
        .btn-filter {
            transition: all 0.3s ease;
            border-radius: 0;
            padding: 0.5rem 1rem;
            font-weight: 500;
        }

        .btn-filter:first-child {
            border-top-left-radius: 0.25rem;
            border-bottom-left-radius: 0.25rem;
        }

        .btn-filter:last-child {
            border-top-right-radius: 0.25rem;
            border-bottom-right-radius: 0.25rem;
        }

        .btn-filter.active {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn-filter:hover:not(.active) {
            transform: translateY(-1px);
        }

        .btn-filter .badge {
            font-size: 0.75rem;
            padding: 0.25em 0.5em;
        }

        /* Animación suave para mostrar/ocultar bloques */
        [data-bloque] {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        [data-bloque][style*="display: none"] {
            opacity: 0;
            transform: scale(0.95);
        }

        /* Colores específicos para cada botón cuando está activo */
        .btn-filter.active.btn-outline-secondary {
            background-color: #6c757d;
            color: white;
            border-color: #6c757d;
        }

        .btn-filter.active.btn-outline-warning {
            background-color: #ffc107;
            color: #000;
            border-color: #ffc107;
        }

        .btn-filter.active.btn-outline-info {
            background-color: #17a2b8;
            color: white;
            border-color: #17a2b8;
        }

        .btn-filter.active.btn-outline-primary {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        .btn-filter.active.btn-outline-success {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }

        /* Estilos para títulos de categorías */
        h2.text-warning {
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(255, 193, 7, 0.2);
            padding: 0.5rem 1rem;
            background: linear-gradient(90deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0) 100%);
            border-left: 4px solid #ffc107;
            border-radius: 0.25rem;
        }

        h2.text-info {
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(23, 162, 184, 0.2);
            padding: 0.5rem 1rem;
            background: linear-gradient(90deg, rgba(23, 162, 184, 0.1) 0%, rgba(23, 162, 184, 0) 100%);
            border-left: 4px solid #17a2b8;
            border-radius: 0.25rem;
        }

        h2.text-primary {
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0, 123, 255, 0.2);
            padding: 0.5rem 1rem;
            background: linear-gradient(90deg, rgba(0, 123, 255, 0.1) 0%, rgba(0, 123, 255, 0) 100%);
            border-left: 4px solid #007bff;
            border-radius: 0.25rem;
        }

        h2.text-success {
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(40, 167, 69, 0.2);
            padding: 0.5rem 1rem;
            background: linear-gradient(90deg, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0) 100%);
            border-left: 4px solid #28a745;
            border-radius: 0.25rem;
        }

        /* Animación para los iconos de los títulos */
        h2 i {
            animation: pulse-icon 2s ease-in-out infinite;
        }

        @keyframes pulse-icon {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        /* Estilos personalizados para las tarjetas de suscripción */
        /* Más espacio entre la foto de perfil y los datos */
        .tarjeta-suscripcion .rounded-circle {
            margin-right: 1.25rem !important; /* Aumentado de me-3 (1rem) a 1.25rem */
        }

        /* Nombre del cliente un poco más grande */
        .tarjeta-suscripcion h5.fw-bold {
            font-size: 1.1rem !important; /* Ligeramente más grande */
        }

        /* Más espacio entre edad y sexo */
        .tarjeta-suscripcion .d-flex.flex-wrap.gap-2 {
            gap: 0.875rem !important; /* Aumentado de gap-2 (0.5rem) a 0.875rem */
        }

        /* Centrar contenido de botones con iconos */
        .btn-sm.w-100 {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        /* Aumentar separación entre email y teléfono */
        .tarjeta-suscripcion .card-body .d-flex.gap-3 {
            gap: 1.5rem !important; /* Aumentado de gap-3 (1rem) a 1.5rem */
        }

        /* Aumentar separación entre iconos y datos de contacto */
        .tarjeta-suscripcion .fas.fa-envelope,
        .tarjeta-suscripcion .fas.fa-phone {
            margin-right: 0.75rem !important; /* Aumentado de me-2 (0.5rem) a 0.75rem */
        }

        /* Aumentar espacio entre objetivo y cuadros de precio/duración */
        .tarjeta-suscripcion .card-body .row.g-2.mt-auto {
            margin-top: 1.5rem !important; /* Más espacio superior para los cuadros de precio y duración */
        }

        /* Aumentar espacio entre TODOS los iconos y sus textos en TODA la interfaz */
        i.fas, i.bi, i.fa {
            margin-right: 0.5rem !important; /* Espacio base entre iconos y texto */
        }

        /* Iconos en alertas y mensajes */
        .alert i.fas {
            margin-right: 0.6rem !important;
        }

        /* Iconos en botones de navegación y filtros */
        .btn i.fas,
        .btn i.bi {
            margin-right: 0.5rem !important;
        }

        /* Iconos en títulos de sección */
        h2 i.fas {
            margin-right: 0.65rem !important;
        }

        /* Iconos en las tarjetas de suscripción */
        .tarjeta-suscripcion i.fas,
        .tarjeta-suscripcion i.bi {
            margin-right: 0.65rem !important;
        }

        /* Iconos en la cabecera de las tarjetas (edad, sexo) */
        .tarjeta-suscripcion .opacity-90 i.fas {
            margin-right: 0.5rem !important;
        }

        /* Iconos en cuadros de precio y duración */
        .tarjeta-suscripcion .border.rounded-3 i.fas {
            margin-right: 0.5rem !important;
        }

        /* Bordes más redondeados para los cuadros de precio y duración */
        .tarjeta-suscripcion .border.rounded-3 {
            border-radius: 0.75rem !important;
            border-width: 1.5px !important;
        }

        /* ===== ESTILOS PARA VISTA DE LISTA ===== */

        /* Iconos en la tabla de vista lista */
        #vistaLista table i.fas,
        #vistaLista table i.bi {
            margin-right: 0 !important; /* Los iconos en botones de acción no tienen texto al lado */
        }

        /* Iconos en badges de estado en vista lista */
        #vistaLista .badge i.fas {
            margin-right: 0.5rem !important;
        }

        /* Espaciado en descripción de estado en vista lista */
        #vistaLista .estado-descripcion {
            margin-top: 0.5rem !important;
        }

        /* Botones de acción en vista lista centrados */
        #vistaLista .btn-action {
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            width: 38px;
            height: 38px;
            padding: 0.5rem;
        }

        /* Espaciado entre botones de acción en vista lista */
        #vistaLista .acciones-cell .d-inline-flex {
            gap: 0.5rem !important;
        }

        /* Transición suave para filas de tabla al filtrar */
        #vistaLista tbody tr {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        #vistaLista tbody tr[style*="display: none"] {
            opacity: 0;
            transform: scale(0.98);
        }
    </style>
</head>

<body th:replace="~{layout/layout :: layout('Lista de suscripciones', ~{::section})}">
<section th:fragment="section" class="suscripciones-page">
    <!-- Alertas de éxito y error -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        <strong>¡Éxito!</strong> <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-dismiss="alert" aria-label="Close"></button>
    </div>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>¡Error!</strong> <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-dismiss="alert" aria-label="Close"></button>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 text-dark mb-0">Lista de Suscripciones</h1>
        <div class="d-flex align-items-center gap-2">
            <div class="btn-group shadow-sm rounded" role="group" aria-label="Alternar vista y reporte">
                <button id="btnVistaGrid" type="button"
                        class="btn btn-outline-primary btn-lg text-nowrap active btn-toggle"
                        title="Vista de tarjetas">
                    <i class="fas fa-th-large me-1"></i> Cuadrícula
                </button>
                <button id="btnVistaLista" type="button" class="btn btn-outline-primary btn-lg text-nowrap btn-toggle"
                        title="Vista de lista">
                    <i class="fas fa-list me-1"></i> Lista
                </button>
                <a th:href="@{/entrenador/suscripciones/reporte.pdf}"
                   class="btn btn-danger btn-lg text-nowrap btn-toggle btn-report"
                   title="Generar reporte">
                    <i class="bi bi-filetype-pdf me-1"></i> Generar reporte
                </a>
            </div>
        </div>
    </div>

    <!-- Contenedor principal -->
    <div class="container">
        <div th:if="${#lists.isEmpty(suscripciones)}" class="col-12 d-flex justify-content-center">
            <div class="alert alert-info text-center w-50 mt-5 empty-message" role="alert">
                <strong>Aún no hay suscripciones</strong><br>
                Cuando tengas alguna, aquí se mostrarán.
            </div>
        </div>

        <!-- Navegación por pestañas para filtrar bloques -->
        <div th:if="${!#lists.isEmpty(suscripciones)}" class="mb-4">
            <div class="d-flex justify-content-center">
                <div class="btn-group shadow-sm" role="group" aria-label="Filtrar suscripciones">
                    <button type="button" class="btn btn-outline-secondary btn-filter active" data-filter="todos">
                        <i class="fas fa-border-all me-1"></i> Todas
                        <span class="badge bg-secondary text-white ms-1" th:text="${#lists.size(suscripciones)}">0</span>
                    </button>
                    <button type="button" class="btn btn-outline-warning btn-filter" data-filter="pendientes"
                            th:if="${!#lists.isEmpty(suscripcionesPendientes)}">
                        <i class="fas fa-clock me-1"></i> Pendientes
                        <span class="badge bg-warning text-white ms-1"
                              th:text="${#lists.size(suscripcionesPendientes)}">0</span>
                    </button>
                    <button type="button" class="btn btn-outline-info btn-filter" data-filter="cotizadas"
                            th:if="${!#lists.isEmpty(suscripcionesCotizadas)}">
                        <i class="fas fa-hand-holding-usd me-1"></i> Cotizadas
                        <span class="badge bg-info text-white ms-1"
                              th:text="${#lists.size(suscripcionesCotizadas)}">0</span>
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-filter" data-filter="aceptadas"
                            th:if="${!#lists.isEmpty(suscripcionesAceptadas)}">
                        <i class="fas fa-check-circle me-1"></i> Aceptadas
                        <span class="badge bg-primary text-white ms-1" th:text="${#lists.size(suscripcionesAceptadas)}">0</span>
                    </button>
                    <button type="button" class="btn btn-outline-success btn-filter" data-filter="activas"
                            th:if="${rutinasActivasClientes != null and !rutinasActivasClientes.isEmpty()}">
                        <i class="fas fa-dumbbell me-1"></i> Activas
                        <span class="badge bg-success text-white ms-1"
                              th:text="${#maps.size(rutinasActivasClientes)}">0</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Vista cuadrícula -->
        <div id="vistaGrid" class="row g-5 suscripciones-grid" th:if="${!#lists.isEmpty(suscripciones)}">
            <!-- Bloque PENDIENTES -->
            <div class="col-12 bloque-pendientes" data-bloque="pendientes">
                <h2 class="h5 mb-3 text-uppercase text-warning">
                    <i class="fas fa-clock me-2"></i>Pendientes
                </h2>
            </div>
            <!-- Mensaje si no hay pendientes -->
            <div class="col-12" data-bloque="pendientes"
                 th:if="${#lists.isEmpty(suscripcionesPendientes)}">
                <div class="alert alert-light border text-muted small mb-0">
                    No hay suscripciones pendientes en este momento.
                </div>
            </div>
            <div th:if="${!#lists.isEmpty(suscripcionesPendientes)}"
                 th:each="suscripcion : ${suscripcionesPendientes}"
                 class="col-12 col-md-6 col-lg-4 tarjeta-suscripcion" data-bloque="pendientes">
                <div class="card card-suscripcion shadow-sm h-100 border-0 overflow-hidden"
                     th:with="estado=${suscripcion.estadoSuscripcion != null ? #strings.toString(suscripcion.estadoSuscripcion) : ''}">

                    <!-- Layout principal de la tarjeta: cabecera compacta + contenido -->
                    <div class="d-flex flex-column h-100">
                        <!-- Cabecera amarilla con datos del cliente y estado resumido -->
                        <div class="px-3 pt-3 pb-2 text-dark" style="background:#ffc107;">
                            <div class="d-flex align-items-center">
                                <img th:src="${fotosClientes[suscripcion.idCliente]} ?: @{/img/fotoPerfil.png}"
                                     alt="Foto del cliente"
                                     class="rounded-circle me-3"
                                     style="width: 56px; height: 56px; object-fit: cover; border: 2px solid rgba(0,0,0,.2);">
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h5 class="fw-bold mb-1 small"
                                                th:text="${nombresClientes[suscripcion.idCliente]} + ' ' + ${apellidosClientes[suscripcion.idCliente] ?: ''}">
                                                Cliente</h5>
                                            <div class="d-flex flex-wrap gap-2 small opacity-90">
                                                <span th:if="${edadesClientes[suscripcion.idCliente] != null}">
                                                    <i class="fas fa-birthday-cake me-1"></i>
                                                    <span th:text="${edadesClientes[suscripcion.idCliente]} + ' años'">25 años</span>
                                                </span>
                                                <span th:if="${generosClientes[suscripcion.idCliente] != null}">
                                                    <i class="fas fa-venus-mars me-1"></i>
                                                    <span th:text="${generosClientes[suscripcion.idCliente]}">M</span>
                                                </span>
                                            </div>
                                        </div>
                                        <span class="badge estado-badge ms-2"
                                              th:text="${estado}"
                                              th:classappend="${estado == 'ACEPTADA' ? ' estado-aceptada' : (estado == 'COTIZADA' ? ' estado-cotizada' : (estado == 'RECHAZADA' ? ' estado-rechazada' : (estado == 'PENDIENTE' ? ' estado-pendiente' : ' estado-desconocida')))}">
                                            PENDIENTE
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Cuerpo: info contacto + objetivo + precio/duración en layout compacto -->
                        <div class="card-body p-3 d-flex flex-column gap-3 flex-grow-1 bg-white">
                            <!-- Contacto -->
                            <div class="small">
                                <div class="d-flex align-items-center flex-wrap gap-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-envelope text-danger me-2"></i>
                                        <span class="text-muted"
                                              th:text="${emailsClientes[suscripcion.idCliente]} ?: 'Sin email'">email@cliente.com</span>
                                    </div>
                                    <div class="d-flex align-items-center"
                                         th:if="${telefonosClientes[suscripcion.idCliente] != null}">
                                        <i class="fas fa-phone text-success me-2"></i>
                                        <span class="text-muted" th:text="${telefonosClientes[suscripcion.idCliente]}">+57 300 123 4567</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Objetivo (compactado) -->
                            <div th:if="${objetivosClientes[suscripcion.idCliente] != null}" class="small">
                                <div class="d-flex align-items-center mb-1 text-primary">
                                    <i class="fas fa-bullseye me-2"></i>
                                    <span class="fw-semibold">Objetivo</span>
                                </div>
                                <p class="mb-0 text-muted" style="font-size:0.8rem;"
                                   th:text="${objetivosClientes[suscripcion.idCliente]}">Objetivo del cliente</p>
                            </div>

                            <!-- Precio y Duración en línea -->
                            <div class="row g-2 mt-auto">
                                <div class="col-6">
                                    <div class="border rounded-3 p-2 text-center h-100">
                                        <div class="small text-muted mb-1"><i
                                                class="fas fa-dollar-sign text-success me-1"></i> Precio
                                        </div>
                                        <div class="fw-bold text-success" style="font-size:0.95rem;"
                                             th:text="${suscripcion.precio != null ? '$' + #numbers.formatDecimal(suscripcion.precio, 1, 'COMMA', 2, 'POINT') : 'Por Definir'}">
                                            Por Definir
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="border rounded-3 p-2 text-center h-100">
                                        <div class="small text-muted mb-1"><i
                                                class="fas fa-calendar text-info me-1"></i> Duración
                                        </div>
                                        <div class="fw-bold text-info" style="font-size:0.95rem;"
                                             th:text="${suscripcion.duracionSemanas != null ? suscripcion.duracionSemanas + ' sem.' : 'Por Definir'}">
                                            Por Definir
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Footer con acciones -->
                        <div class="card-footer bg-light border-0 pt-0 pb-3 px-3">
                            <div class="d-flex flex-column gap-2">
                                <button th:if="${estado == 'PENDIENTE' && suscripcion.vistaDiagnostico}" type="button"
                                        class="btn btn-success btn-sm btn-cotizar-diagnostico w-100"
                                        th:attr="data-id=${suscripcion.idSuscripcion},data-cliente=${suscripcion.idCliente},data-entrenador=${suscripcion.idEntrenador},data-precio=${suscripcion.precio},data-estado=${suscripcion.estadoSuscripcion}">
                                    <i class="fas fa-hand-holding-usd me-1"></i> Cotizar
                                </button>
                                <button th:if="${estado == 'PENDIENTE' && !suscripcion.vistaDiagnostico}" type="button"
                                        class="btn btn-secondary btn-sm w-100" disabled
                                        title="Debes ver el diagnóstico antes de cotizar">
                                    <i class="fas fa-lock me-1"></i> Cotizar (bloqueado)
                                </button>
                                <a th:if="${suscripcion.idCliente != null}"
                                   th:href="@{/entrenador/diagnostico/vista/{clienteId}(clienteId=${suscripcion.idCliente})}"
                                   class="btn btn-outline-info btn-sm w-100">
                                    <i class="fas fa-notes-medical me-1"></i> Ver diagnóstico
                                </a>
                                <form th:if="${estado == 'PENDIENTE'}"
                                      th:action="@{/suscripciones/rechazar/{id}(id=${suscripcion.idSuscripcion})}"
                                      method="post" class="mb-0 form-rechazar-suscripcion">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <input type="hidden" name="redirectTo" value="/entrenador/suscripciones"/>
                                    <button type="submit" class="btn btn-outline-danger btn-sm w-100">
                                        <i class="fas fa-times-circle me-1"></i> Rechazar
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bloque COTIZADAS -->
            <div class="col-12 mt-4 bloque-cotizadas" data-bloque="cotizadas">
                <h2 class="h5 mb-3 text-uppercase text-info">
                    <i class="fas fa-hand-holding-usd me-2"></i>Cotizadas
                </h2>
            </div>
            <!-- Mensaje si no hay cotizadas -->
            <div class="col-12" data-bloque="cotizadas"
                 th:if="${#lists.isEmpty(suscripcionesCotizadas)}">
                <div class="alert alert-light border text-muted small mb-0">
                    No hay suscripciones cotizadas para mostrar.
                </div>
            </div>
            <div th:if="${!#lists.isEmpty(suscripcionesCotizadas)}"
                 th:each="suscripcion : ${suscripcionesCotizadas}"
                 class="col-12 col-md-6 col-lg-4 tarjeta-suscripcion" data-bloque="cotizadas">
                <div class="card card-suscripcion shadow-sm h-100 border-0 overflow-hidden"
                     th:with="estado=${suscripcion.estadoSuscripcion != null ? #strings.toString(suscripcion.estadoSuscripcion) : ''}">

                    <div class="d-flex flex-column h-100">
                        <!-- Cabecera cyan -->
                        <div class="px-3 pt-3 pb-2 text-white" style="background:#17a2b8;">
                            <div class="d-flex align-items-center">
                                <img th:src="${fotosClientes[suscripcion.idCliente]} ?: @{/img/fotoPerfil.png}"
                                     alt="Foto del cliente"
                                     class="rounded-circle me-3"
                                     style="width: 56px; height: 56px; object-fit: cover; border: 2px solid rgba(255,255,255,.7);">
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h5 class="fw-bold mb-1 small"
                                                th:text="${nombresClientes[suscripcion.idCliente]} + ' ' + ${apellidosClientes[suscripcion.idCliente] ?: ''}">
                                                Cliente</h5>
                                            <div class="d-flex flex-wrap gap-2 small opacity-90">
                                                <span th:if="${edadesClientes[suscripcion.idCliente] != null}">
                                                    <i class="fas fa-birthday-cake me-1"></i>
                                                    <span th:text="${edadesClientes[suscripcion.idCliente]} + ' años'">25 años</span>
                                                </span>
                                                <span th:if="${generosClientes[suscripcion.idCliente] != null}">
                                                    <i class="fas fa-venus-mars me-1"></i>
                                                    <span th:text="${generosClientes[suscripcion.idCliente]}">M</span>
                                                </span>
                                            </div>
                                        </div>
                                        <span class="badge estado-badge estado-cotizada ms-2" th:text="${estado}">COTIZADA</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Cuerpo -->
                        <div class="card-body p-3 d-flex flex-column gap-3 flex-grow-1 bg-white">
                            <!-- Contacto -->
                            <div class="small">
                                <div class="d-flex align-items-center flex-wrap gap-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-envelope text-danger me-2"></i>
                                        <span class="text-muted"
                                              th:text="${emailsClientes[suscripcion.idCliente]} ?: 'Sin email'">email@cliente.com</span>
                                    </div>
                                    <div class="d-flex align-items-center"
                                         th:if="${telefonosClientes[suscripcion.idCliente] != null}">
                                        <i class="fas fa-phone text-success me-2"></i>
                                        <span class="text-muted" th:text="${telefonosClientes[suscripcion.idCliente]}">+57 300 123 4567</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Objetivo -->
                            <div th:if="${objetivosClientes[suscripcion.idCliente] != null}" class="small">
                                <div class="d-flex align-items-center mb-1 text-primary">
                                    <i class="fas fa-bullseye me-2"></i>
                                    <span class="fw-semibold">Objetivo</span>
                                </div>
                                <p class="mb-0 text-muted" style="font-size:0.8rem;"
                                   th:text="${objetivosClientes[suscripcion.idCliente]}">Objetivo del cliente</p>
                            </div>

                            <!-- Precio y duración -->
                            <div class="row g-2 mt-auto">
                                <div class="col-6">
                                    <div class="border rounded-3 p-2 text-center h-100">
                                        <div class="small text-muted mb-1"><i
                                                class="fas fa-dollar-sign text-success me-1"></i> Precio
                                        </div>
                                        <div class="fw-bold text-success" style="font-size:0.95rem;"
                                             th:text="${suscripcion.precio != null ? '$' + #numbers.formatDecimal(suscripcion.precio, 1, 'COMMA', 2, 'POINT') : 'Por Definir'}">
                                            Por Definir
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="border rounded-3 p-2 text-center h-100">
                                        <div class="small text-muted mb-1"><i
                                                class="fas fa-calendar text-info me-1"></i> uración
                                        </div>
                                        <div class="fw-bold text-info" style="font-size:0.95rem;"
                                             th:text="${suscripcion.duracionSemanas != null ? suscripcion.duracionSemanas + ' sem.' : 'Por Definir'}">
                                            Por Definir
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="card-footer bg-light border-0 pt-0 pb-3 px-3">
                            <div class="d-flex flex-column gap-2">
                                <a th:if="${suscripcion.idCliente != null}"
                                   th:href="@{/entrenador/diagnostico/vista/{clienteId}(clienteId=${suscripcion.idCliente})}"
                                   class="btn btn-outline-info btn-sm w-100">
                                    <i class="fas fa-notes-medical me-1"></i> Ver diagnóstico
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bloque ACEPTADAS -->
            <div class="col-12 mt-4 bloque-aceptadas" data-bloque="aceptadas">
                <h2 class="h5 mb-3 text-uppercase text-primary">
                    <i class="fas fa-check-circle me-2"></i>Aceptadas
                </h2>
            </div>
            <!-- Mensaje si no hay aceptadas (por ejemplo, todas están activas) -->
            <div class="col-12" data-bloque="aceptadas"
                 th:if="${#lists.isEmpty(suscripcionesAceptadas)}">
                <div class="alert alert-light border text-muted small mb-0">
                    No hay suscripciones aceptadas sin rutina activa.
                </div>
            </div>
            <div th:each="suscripcion : ${suscripcionesAceptadas}"
                 th:if="${!#lists.isEmpty(suscripcionesAceptadas) and (rutinasActivasClientes == null or !rutinasActivasClientes.containsKey(suscripcion.idCliente))}"
                 class="col-12 col-md-6 col-lg-4 tarjeta-suscripcion" data-bloque="aceptadas">
                <div class="card card-suscripcion shadow-sm h-100 border-0 overflow-hidden"
                     th:with="estado=${suscripcion.estadoSuscripcion != null ? #strings.toString(suscripcion.estadoSuscripcion) : ''},tieneRutina=${rutinasActivasClientes != null and rutinasActivasClientes.containsKey(suscripcion.idCliente)}">

                    <div class="d-flex flex-column h-100">
                        <!-- Cabecera: verde si tiene rutina, azul si solo aceptada -->
                        <div class="px-3 pt-3 pb-2 text-white"
                             th:style="${tieneRutina} ? 'background:#198754;' : 'background:#0d6efd;'">
                            <!-- success/primary -->
                            <div class="d-flex align-items-center">
                                <img th:src="${fotosClientes[suscripcion.idCliente]} ?: @{/img/fotoPerfil.png}"
                                     alt="Foto del cliente"
                                     class="rounded-circle me-3"
                                     style="width: 56px; height: 56px; object-fit: cover; border: 2px solid rgba(255,255,255,.7);">
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h5 class="fw-bold mb-1 small"
                                                th:text="${nombresClientes[suscripcion.idCliente]} + ' ' + ${apellidosClientes[suscripcion.idCliente] ?: ''}">
                                                Cliente</h5>
                                            <div class="d-flex flex-wrap gap-2 small opacity-90">
                                                <span th:if="${edadesClientes[suscripcion.idCliente] != null}">
                                                    <i class="fas fa-birthday-cake me-1"></i>
                                                    <span th:text="${edadesClientes[suscripcion.idCliente]} + ' años'">25 años</span>
                                                </span>
                                                <span th:if="${generosClientes[suscripcion.idCliente] != null}">
                                                    <i class="fas fa-venus-mars me-1"></i>
                                                    <span th:text="${generosClientes[suscripcion.idCliente]}">M</span>
                                                </span>
                                            </div>
                                        </div>
                                        <span class="badge estado-badge ms-2"
                                              th:text="${tieneRutina ? 'CON RUTINA' : estado}"
                                              th:classappend="${tieneRutina ? ' estado-aceptada' : (estado == 'ACEPTADA' ? ' estado-aceptada' : ' estado-desconocida')}">
                                            ACEPTADA
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Cuerpo: contacto + objetivo + precio/duración -->
                        <div class="card-body p-3 d-flex flex-column gap-3 flex-grow-1 bg-white">
                            <!-- Contacto -->
                            <div class="small">
                                <div class="d-flex align-items-center flex-wrap gap-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-envelope text-danger me-2"></i>
                                        <span class="text-muted"
                                              th:text="${emailsClientes[suscripcion.idCliente]} ?: 'Sin email'">email@cliente.com</span>
                                    </div>
                                    <div class="d-flex align-items-center"
                                         th:if="${telefonosClientes[suscripcion.idCliente] != null}">
                                        <i class="fas fa-phone text-success me-2"></i>
                                        <span class="text-muted" th:text="${telefonosClientes[suscripcion.idCliente]}">+57 300 123 4567</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Objetivo y descripción -->
                            <div class="small">
                                <div th:if="${objetivosClientes[suscripcion.idCliente] != null}" class="mb-1">
                                    <div class="d-flex align-items-center text-primary mb-1">
                                        <i class="fas fa-bullseye me-2"></i>
                                        <span class="fw-semibold">Objetivo</span>
                                    </div>
                                    <p class="mb-0 text-muted" style="font-size:0.8rem;"
                                       th:text="${objetivosClientes[suscripcion.idCliente]}">Objetivo del cliente</p>
                                </div>
                                <div th:if="${descripcionesClientes[suscripcion.idCliente] != null}" class="mt-2">
                                    <div class="d-flex align-items-center text-primary mb-1">
                                        <i class="fas fa-comment-dots me-2"></i>
                                        <span class="fw-semibold">Descripción</span>
                                    </div>
                                    <p class="mb-0 text-muted" style="font-size:0.8rem;"
                                       th:text="${descripcionesClientes[suscripcion.idCliente]}">Descripción del
                                        cliente</p>
                                </div>
                            </div>

                            <!-- Precio y duración -->
                            <div class="row g-2 mt-auto">
                                <div class="col-6">
                                    <div class="border rounded-3 p-2 text-center h-100">
                                        <div class="small text-muted mb-1"><i
                                                class="fas fa-dollar-sign text-success me-1"></i> Precio
                                        </div>
                                        <div class="fw-bold text-success" style="font-size:0.95rem;"
                                             th:text="${suscripcion.precio != null ? '$' + #numbers.formatDecimal(suscripcion.precio, 1, 'COMMA', 2, 'POINT') : 'Por Definir'}">
                                            Por Definir
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="border rounded-3 p-2 text-center h-100">
                                        <div class="small text-muted mb-1"><i
                                                class="fas fa-calendar text-info me-1"></i> Duración
                                        </div>
                                        <div class="fw-bold text-info" style="font-size:0.95rem;"
                                             th:text="${suscripcion.duracionSemanas != null ? suscripcion.duracionSemanas + ' sem.' : 'Por Definir'}">
                                            Por Definir
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Footer con botones de acción -->
                        <div class="card-footer bg-light border-0 pt-0 pb-3 px-3">
                            <div class="d-flex flex-column gap-2">
                                <!-- Ver progreso si tiene rutina asignada -->
                                <a th:if="${tieneRutina}"
                                   th:href="@{'/semanas/detallar/' + ${rutinasActivasClientes[suscripcion.idCliente]} + '?readonly=true'}"
                                   class="btn btn-success btn-sm w-100">
                                    <i class="fas fa-chart-line me-1"></i> Ver progreso
                                </a>
                                <!-- Asignar rutina si aún no la tiene -->
                                <a th:if="${!tieneRutina}"
                                   th:href="@{/rutinas(asignar=true, idCliente=${suscripcion.idCliente})}"
                                   class="btn btn-primary btn-sm w-100">
                                    <i class="fas fa-dumbbell me-1"></i> Asignar rutina
                                </a>
                                <!-- Ver diagnóstico -->
                                <a th:if="${suscripcion.idCliente != null}"
                                   th:href="@{/entrenador/diagnostico/vista/{clienteId}(clienteId=${suscripcion.idCliente})}"
                                   class="btn btn-outline-info btn-sm w-100">
                                    <i class="fas fa-notes-medical me-1"></i> Ver diagnóstico
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bloque ACTIVAS (suscripciones aceptadas con rutina asignada) -->
            <div class="col-12 mt-4 bloque-activas" data-bloque="activas">
                <h2 class="h5 mb-3 text-uppercase text-success">
                    <i class="fas fa-dumbbell me-2"></i>Activas
                </h2>
            </div>
            <!-- Mensaje cuando no hay activas -->
            <div class="col-12" data-bloque="activas"
                 th:if="${rutinasActivasClientes == null or #maps.isEmpty(rutinasActivasClientes)}">
                <div class="alert alert-light border text-muted small mb-0">
                    No hay suscripciones activas con rutina asignada en este momento.
                </div>
            </div>
            <!-- Tarjetas de activas (una por cliente con rutina activa) -->
            <div th:if="${rutinasActivasClientes != null and !#maps.isEmpty(rutinasActivasClientes)}"
                 th:each="entry : ${rutinasActivasClientes}"
                 class="col-12 col-md-6 col-lg-4 tarjeta-suscripcion" data-bloque="activas">
                <div class="card card-suscripcion shadow-sm h-100 border-0 overflow-hidden"
                     th:with="clienteId=${entry.key}, idRutina=${entry.value}">
                    <div class="d-flex flex-column h-100">
                        <!-- Cabecera verde ACTIVA -->
                        <div class="px-3 pt-3 pb-2 text-white" style="background:#198754;">
                            <div class="d-flex align-items-center">
                                <img th:src="${fotosClientes != null and fotosClientes.get(clienteId) != null ? fotosClientes.get(clienteId) : '/img/fotoPerfil.png'}"
                                     alt="Foto del cliente"
                                     class="rounded-circle me-3"
                                     style="width:56px;height:56px;object-fit:cover;border:2px solid rgba(255,255,255,.7);">
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h5 class="fw-bold mb-1 small"
                                                th:text="${(nombresClientes.get(clienteId) ?: 'Cliente') + ' ' + (apellidosClientes.get(clienteId) ?: '')}">Cliente</h5>
                                            <div class="d-flex flex-wrap gap-2 small opacity-90">
                                                <span th:if="${edadesClientes != null and edadesClientes.get(clienteId) != null}">
                                                    <i class="fas fa-birthday-cake me-1"></i>
                                                    <span th:text="${edadesClientes.get(clienteId)} + ' años'">25 años</span>
                                                </span>
                                                <span th:if="${generosClientes != null and generosClientes.get(clienteId) != null}">
                                                    <i class="fas fa-venus-mars me-1"></i>
                                                    <span th:text="${generosClientes.get(clienteId)}">M</span>
                                                </span>
                                            </div>
                                        </div>
                                        <span class="badge estado-badge estado-aceptada ms-2">ACTIVA</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Cuerpo: info contacto + objetivo + descripción -->
                        <div class="card-body p-3 d-flex flex-column gap-3 flex-grow-1 bg-white">
                            <div class="small">
                                <div class="d-flex align-items-center flex-wrap gap-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-envelope text-danger me-2"></i>
                                        <span class="text-muted" th:text="${emailsClientes != null and emailsClientes.get(clienteId) != null ? emailsClientes.get(clienteId) : 'Sin email'}">email@cliente.com</span>
                                    </div>
                                    <div class="d-flex align-items-center" th:if="${telefonosClientes != null and telefonosClientes.get(clienteId) != null}">
                                        <i class="fas fa-phone text-success me-2"></i>
                                        <span class="text-muted" th:text="${telefonosClientes.get(clienteId)}">+57 300 123 4567</span>
                                    </div>
                                </div>
                            </div>
                            <div class="small">
                                <div th:if="${objetivosClientes != null and objetivosClientes.get(clienteId) != null}" class="mb-1">
                                    <div class="d-flex align-items-center text-primary mb-1">
                                        <i class="fas fa-bullseye me-2"></i>
                                        <span class="fw-semibold">Objetivo</span>
                                    </div>
                                    <p class="mb-0 text-muted" style="font-size:0.8rem;"
                                       th:text="${objetivosClientes.get(clienteId)}">Objetivo del cliente</p>
                                </div>
                                <div th:if="${descripcionesClientes != null and descripcionesClientes.get(clienteId) != null}" class="mt-2">
                                    <div class="d-flex align-items-center text-primary mb-1">
                                        <i class="fas fa-comment-dots me-2"></i>
                                        <span class="fw-semibold">Descripción</span>
                                    </div>
                                    <p class="mb-0 text-muted" style="font-size:0.8rem;"
                                       th:text="${descripcionesClientes.get(clienteId)}">Descripción del cliente</p>
                                </div>
                            </div>
                        </div>

                        <!-- Footer con acciones para activas -->
                        <div class="card-footer bg-light border-0 pt-0 pb-3 px-3">
                            <div class="d-flex flex-column gap-2">
                                <a th:href="@{'/semanas/detallar/' + ${idRutina} + '?readonly=true'}"
                                   class="btn btn-success btn-sm w-100">
                                    <i class="fas fa-chart-line me-1"></i> Ver progreso
                                </a>
                                <a th:href="@{/entrenador/diagnostico/vista/{clienteId}(clienteId=${clienteId})}"
                                   class="btn btn-outline-info btn-sm w-100">
                                    <i class="fas fa-notes-medical me-1"></i> Ver diagnóstico
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista lista -->
        <div id="vistaLista" class="row" style="display:none" th:if="${!#lists.isEmpty(suscripciones)}">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table align-middle mb-0">
                                <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Estado</th>
                                    <th>Precio</th>
                                    <th>Duración</th>
                                    <th class="text-end">Acciones</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="suscripcion : ${suscripciones}"
                                    th:with="estado=${suscripcion.estadoSuscripcion != null ? #strings.toString(suscripcion.estadoSuscripcion) : ''},
                                             tieneRutinaActiva=${rutinasActivasClientes != null and rutinasActivasClientes.containsKey(suscripcion.idCliente)}"
                                    th:attr="data-estado=${#strings.toLowerCase(estado)}, data-tiene-rutina=${tieneRutinaActiva}">
                                    <td th:text="${nombresClientes[suscripcion.idCliente]} ?: 'Cliente'">Cliente</td>
                                    <td>
                                        <span class="badge rounded-pill px-3 py-2 estado-badge"
                                              th:text="${estado}"
                                              th:classappend="${estado == 'ACEPTADA' ? ' estado-aceptada' : (estado == 'COTIZADA' ? ' estado-cotizada' : (estado == 'RECHAZADA' ? ' estado-rechazada' : (estado == 'PENDIENTE' ? ' estado-pendiente' : ' estado-desconocida')))}">
                                            Estado
                                        </span>
                                        <div class="estado-descripcion small mt-1" th:switch="${estado}">
                                            <span th:case="'PENDIENTE'">Aún no se le ha cotizado la suscripción al cliente.</span>
                                            <span th:case="'COTIZADA'">El cliente ya recibió la cotización y se está a la espera de su aceptación y pago.</span>
                                            <span th:case="'ACEPTADA'">La suscripción ya está pagada y activa hasta la fecha de finalización.</span>
                                            <span th:case="*">Estado de la suscripción en proceso.</span>
                                        </div>
                                    </td>
                                    <td th:text="${suscripcion.precio != null ? #numbers.formatDecimal(suscripcion.precio, 1, 'COMMA', 2, 'POINT') : 'Por Definirse'}">
                                        Por Definirse
                                    </td>
                                    <td th:text="${suscripcion.duracionSemanas != null ? suscripcion.duracionSemanas + ' semana(s)' : 'Por Definirse'}">
                                        Por Definirse
                                    </td>
                                    <td class="text-end acciones-cell">
                                        <div class="d-inline-flex flex-wrap justify-content-end gap-2">
                                            <!-- Botón Cotizar Diagnóstico (cambiado a verde) -->
                                            <button th:if="${estado == 'PENDIENTE' && suscripcion.vistaDiagnostico}"
                                                    type="button"
                                                    class="btn btn-success btn-action btn-cotizar-diagnostico"
                                                    th:attr="data-id=${suscripcion.idSuscripcion},data-cliente=${suscripcion.idCliente},data-entrenador=${suscripcion.idEntrenador},data-precio=${suscripcion.precio},data-estado=${suscripcion.estadoSuscripcion}">
                                                <i class="fas fa-hand-holding-usd"></i>
                                            </button>
                                            <button th:if="${estado == 'PENDIENTE' && !suscripcion.vistaDiagnostico}"
                                                    type="button"
                                                    class="btn btn-secondary btn-action" disabled
                                                    title="Ver el diagnóstico para habilitar">
                                                <i class="fas fa-lock"></i>
                                            </button>
                                            <a th:if="${suscripcion.idCliente != null}"
                                               th:href="@{/entrenador/diagnostico/vista/{clienteId}(clienteId=${suscripcion.idCliente})}"
                                               class="btn btn-info btn-action text-white" title="Diagnóstico"><i
                                                    class="fas fa-notes-medical"></i></a>
                                            <form th:if="${estado == 'PENDIENTE'}"
                                                  th:action="@{/suscripciones/rechazar/{id}(id=${suscripcion.idSuscripcion})}"
                                                  method="post" class="mb-0 form-rechazar-suscripcion">
                                                <input type="hidden" th:name="${_csrf.parameterName}"
                                                       th:value="${_csrf.token}"/>
                                                <input type="hidden" name="redirectTo"
                                                       value="/entrenador/suscripciones"/>
                                                <button type="submit" class="btn btn-danger btn-action"
                                                        title="Rechazar"><i
                                                        class="fas fa-times-circle"></i></button>
                                            </form>
                                            <a th:if="${estado == 'ACEPTADA' && rutinasActivasClientes != null and rutinasActivasClientes.containsKey(suscripcion.idCliente)}"
                                               th:href="@{'/semanas/detallar/' + ${rutinasActivasClientes[suscripcion.idCliente]} + '?readonly=true'}"
                                               class="btn btn-primary btn-action" title="Progreso"><i
                                                    class="fas fa-chart-line"></i></a>
                                            <a th:if="${estado == 'ACEPTADA' && (rutinasActivasClientes == null || !rutinasActivasClientes.containsKey(suscripcion.idCliente))}"
                                               th:href="@{/rutinas(asignar=true, idCliente=${suscripcion.idCliente})}"
                                               class="btn btn-success btn-action" title="Asignar"><i
                                                    class="fas fa-dumbbell"></i></a>
                                        </div>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Modal Cotizar Suscripcion -->
        <div class="modal fade" id="modalEditarSuscripcion" tabindex="-1" aria-labelledby="modalEditarSuscripcionLabel"
             aria-hidden="true" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form th:action="@{/suscripciones/guardar}" method="post" id="form-editar-suscripcion" novalidate>
                        <div class="modal-header bg-warning">
                            <h5 class="modal-title text-dark" id="modalEditarSuscripcionLabel">
                                <i class="fas fa-hand-holding-usd me-2"></i>Cotizar Diagnóstico del Cliente
                            </h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar"><span
                                    aria-hidden="true">&times;</span></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info" role="alert">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Importante:</strong> Revisa el diagnóstico completo del cliente antes de enviar
                                una cotización.
                                Ahora las fechas se calculan automáticamente según la duración en semanas que elijas.
                            </div>
                            <input type="hidden" name="idSuscripcion" id="modal-idSuscripcion">

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="modal-precio" class="form-label">Precio</label>
                                    <input type="number" step="0.01" min="0" class="form-control" id="modal-precio"
                                           name="precio" required>
                                    <div class="form-text" id="precio-rango-text" style="display:none;">
                                        Rango permitido: <span id="precio-min"></span> - <span id="precio-max"></span>
                                    </div>
                                    <div class="invalid-feedback">El precio es obligatorio.</div>
                                    <div class="valid-feedback">Precio válido.</div>
                                    <div id="modal-precio-msg" class="invalid-feedback" style="display:none;"></div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="modal-duracion" class="form-label">Duración</label>
                                    <select id="modal-duracion" name="duracionSemanas" class="form-select" required>
                                        <option value="" disabled selected>Selecciona...</option>
                                        <option value="1">1 semana</option>
                                        <option value="2">2 semanas</option>
                                        <option value="3">3 semanas</option>
                                        <option value="4">4 semanas</option>
                                        <option value="5">5 semanas</option>
                                        <option value="6">6 semanas</option>
                                        <option value="7">7 semanas</option>
                                        <option value="8">8 semanas</option>
                                    </select>
                                    <div class="invalid-feedback">Selecciona la duración en semanas.</div>
                                </div>
                            </div>

                            <!-- Inputs ocultos reales para backend -->
                            <input type="hidden" id="modal-fechainicio" name="fechaInicio" th:if="${false}">
                            <input type="hidden" id="modal-fechafin" name="fechaFin" th:if="${false}">

                            <div id="modal-rango-preview" class="mt-2 small text-muted" style="display:none;"></div>

                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <input type="hidden" name="redirectTo" value="/entrenador/suscripciones"/>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                            <button type="submit" class="btn btn-primary">Guardar cambios</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.addEventListener('load', function () {
            console.log('Script de cotización de diagnóstico listo.');
            $(document).on('click', '.btn-cotizar-diagnostico', function (e) {
                e.preventDefault();
                var button = $(this);
                var clienteId = button.data('cliente');

                if (!$('#modalEditarSuscripcion').length) {
                    console.error('Modal element not found: #modalEditarSuscripcion');
                    return;
                }

                // Verificar si el cliente tiene diagnóstico usando AJAX
                $.ajax({
                    url: '/api/entrenador/diagnostico/cliente/' + clienteId,
                    method: 'GET',
                    success: function(response) {
                        if (response.message && response.message === "No hay diagnostico") {
                            // Cliente no tiene diagnóstico
                            Swal.fire({
                                icon: 'warning',
                                title: '⚠️ Diagnóstico Requerido',
                                html: `
                                    <p style="font-size:1.1rem;line-height:1.6;">
                                        <strong>Debes revisar el diagnóstico del cliente antes de poder enviar una cotización.</strong>
                                    </p>
                                    <p style="color:#64748b;margin-top:1rem;">
                                        Haz clic en el botón <strong>"Ver Diagnóstico"</strong> para revisar la información del cliente primero.
                                    </p>
                                `,
                                confirmButtonText: 'Entendido',
                                confirmButtonColor: '#3b82f6',
                                allowOutsideClick: false
                            });
                            return;
                        }

                        // Cliente tiene diagnóstico, abrir modal normalmente
                        console.log('Abrir modal cotizar diagnóstico:', button.data());
                        $('#modal-idSuscripcion').val(button.data('id'));
                        $('#modal-precio').val(button.data('precio') || '');
                        // Fechas ahora se calculan por duración al abrir el modal

                        if (typeof $('#modalEditarSuscripcion').modal === 'function') {
                            $('#modalEditarSuscripcion').appendTo('body').modal('show');
                        } else {
                            console.error('Bootstrap modal plugin not available. Verify bootstrap JS is loaded.');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error al verificar diagnóstico:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'No se pudo verificar el diagnóstico del cliente. Intenta nuevamente.',
                            confirmButtonColor: '#dc2626'
                        });
                    }
                });
            });

            // Ajuste de límites y estados cuando se muestre el modal
            $('#modalEditarSuscripcion').on('shown.bs.modal', function () {
                try {
                    // Inicialización nueva por semanas
                    ['#modal-precio', '#modal-fechainicio', '#modal-fechafin'].forEach(sel => {
                        const el = document.querySelector(sel);
                        if (!el) return;
                        el.classList.remove('is-valid', 'is-invalid');
                    });
                    const sel = document.getElementById('modal-duracion');
                    if (sel && !sel.value) { sel.value = '4'; }
                    actualizarPreviewRango();
                    validarTodo(false);
                } catch (err) {
                    console.error('Error inicializando validaciones:', err);
                }
            });
        });
    </script>
    <script>
        // ======= Utilidades de fechas (actualizadas para rango semanas) =======
        function toYMD(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        function todayLocal() {
            const now = new Date();
            return new Date(now.getFullYear(), now.getMonth(), now.getDate());
        }
        function computeFin(inicio, semanas) {
            const d = new Date(inicio.getFullYear(), inicio.getMonth(), inicio.getDate());
            d.setDate(d.getDate() + semanas * 7); // fin al cumplir semanas*7 días
            return d;
        }
        function actualizarPreviewRango() {
            const select = document.getElementById('modal-duracion');
            const inicioInput = document.getElementById('modal-fechainicio');
            const finInput = document.getElementById('modal-fechafin');
            const preview = document.getElementById('modal-rango-preview');
            if (!select || !inicioInput || !finInput || !preview) return;
            const val = parseInt(select.value, 10);
            if (!val) {
                preview.style.display = 'none';
                inicioInput.value = '';
                finInput.value = '';
                return;
            }
            const inicio = todayLocal();
            const fin = computeFin(inicio, val);
            inicioInput.value = toYMD(inicio);
            finInput.value = toYMD(fin);
            preview.innerHTML = `<strong>Rango:</strong> Inicio ${inicioInput.value} &rarr; Fin ${finInput.value} (Duración ${val} semana(s))`;
            preview.style.display = 'block';
        }

        function validarPrecio() {
            const precio = document.getElementById('modal-precio');
            if (!precio) return true;
            const val = precio.value;
            const isValid = val !== '' && !isNaN(val) && Number(val) >= 0;
            precio.classList.remove('is-valid', 'is-invalid');
            precio.classList.add(isValid ? 'is-valid' : 'is-invalid');
            return isValid;
        }
        function validarDuracion() {
            const sel = document.getElementById('modal-duracion');
            if (!sel) return true;
            const ok = !!sel.value;
            sel.classList.remove('is-valid', 'is-invalid');
            sel.classList.add(ok ? 'is-valid' : 'is-invalid');
            return ok;
        }
        function validarRangoFechas() {
            const inicio = document.getElementById('modal-fechainicio').value;
            const fin = document.getElementById('modal-fechafin').value;
            return inicio !== '' && fin !== '';
        }
        function validarTodo(showAlerts) {
            const okPrecio = validarPrecio();
            const okDuracion = validarDuracion();
            const okRango = validarRangoFechas();
            const ok = okPrecio && okDuracion && okRango;
            if (!ok && showAlerts) {
                // Podríamos mostrar alerta, pero basta con feedback visual.
            }
            return ok;
        }
        document.addEventListener('change', function(e){
            if (e.target && e.target.id === 'modal-duracion') {
                actualizarPreviewRango();
                validarDuracion();
            }
        });
        document.addEventListener('input', function(e){
            if (e.target && e.target.id === 'modal-precio') {
                validarPrecio();
            }
        });
        document.addEventListener('submit', function(e){
            const form = e.target;
            if (form && form.id === 'form-editar-suscripcion') {
                if (!validarTodo(true)) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            }
        });
        // Al abrir modal inicializar
        $('#modalEditarSuscripcion').on('shown.bs.modal', function(){
            const sel = document.getElementById('modal-duracion');
            if (sel && !sel.value) { sel.value = '4'; } // default 4 semanas
            actualizarPreviewRango();
            validarPrecio();
            validarDuracion();
        });
    </script>
    <script>
        document.querySelectorAll('.btn-ver-diagnostico').forEach(button => {
            button.addEventListener('click', async () => {
                const clienteId = button.getAttribute('data-cliente-id');
                try {
                    const response = await fetch(`/api/entrenador/diagnostico/${clienteId}`);
                    if (!response.ok) {
                        throw new Error('Error al obtener el diagnóstico');
                    }
                    const diagnostico = await response.json();

                    // Rellenar el modal con los datos del diagnóstico
                    document.getElementById('diagnosticoFecha').textContent = diagnostico.fecha || 'N/A';
                    document.getElementById('diagnosticoPeso').textContent = diagnostico.peso || 'N/A';
                    document.getElementById('diagnosticoEstatura').textContent = diagnostico.estatura || 'N/A';
                    document.getElementById('diagnosticoNivelExperiencia').textContent = diagnostico.nivelExperiencia || 'N/A';
                    document.getElementById('diagnosticoDisponibilidad').textContent = diagnostico.disponibilidadTiempo || 'N/A';
                    document.getElementById('diagnosticoRecursos').textContent = diagnostico.accesoRecursos || 'N/A';
                    document.getElementById('diagnosticoLesiones').textContent = diagnostico.lesiones || 'N/A';
                    document.getElementById('diagnosticoCondiciones').textContent = diagnostico.condicionesMedicas || 'N/A';
                    document.getElementById('diagnosticoGrasa').textContent = diagnostico.porcentajeGrasaCorporal || 'N/A';
                    document.getElementById('diagnosticoCintura').textContent = diagnostico.circunferenciaCintura || 'N/A';
                    document.getElementById('diagnosticoCadera').textContent = diagnostico.circunferenciaCadera || 'N/A';
                    document.getElementById('diagnosticoFrecuencia').textContent = diagnostico.frecuenciaCardiacaReposo || 'N/A';
                    document.getElementById('diagnosticoPresion').textContent = diagnostico.presionArterial || 'N/A';
                    document.getElementById('diagnosticoHabitos').textContent = diagnostico.habitosAlimenticios || 'N/A';

                    // Mostrar el modal
                    const modal = new bootstrap.Modal(document.getElementById('modalDiagnostico'));
                    modal.show();
                } catch (error) {
                    console.error(error);
                    alert('Hubo un error al cargar el diagnóstico.');
                }
            });
        });
    </script>
    <script>
        (function(){
            const btnGrid = document.getElementById('btnVistaGrid');
            const btnLista = document.getElementById('btnVistaLista');
            const vistaGrid = document.getElementById('vistaGrid');
            const vistaLista = document.getElementById('vistaLista');
            const KEY = 'suscripcionesVistaEntrenador';
            function setVista(tipo){
                const grid = tipo==='grid';
                vistaGrid.style.display = grid ? '' : 'none';
                vistaLista.style.display = grid ? 'none' : '';
                btnGrid.classList.toggle('active', grid);
                btnLista.classList.toggle('active', !grid);
                try{localStorage.setItem(KEY, tipo);}catch(e){}
            }
            // Obtener preferencia guardada o establecer 'grid' por defecto
            let pref = null;
            try {
                pref = localStorage.getItem(KEY);
                // Si no hay preferencia guardada, establecer 'grid' como predeterminada
                if (!pref) {
                    localStorage.setItem(KEY, 'grid');
                    pref = 'grid';
                }
            } catch(e) {
                pref = 'grid';
            }

            // Aplicar la vista (será 'grid' por defecto)
            setVista(pref === 'lista' ? 'lista' : 'grid');
            btnGrid?.addEventListener('click', ()=> setVista('grid'));
            btnLista?.addEventListener('click', ()=> setVista('lista'));
        })();
    </script>
    <script>
        // Obtener rango de precio del entrenador y validar input de precio
        (function(){
            let rangoPrecio = null;
            function setPrecioConstraints(min, max){
                const input = document.getElementById('modal-precio');
                if(!input) return;
                if(min != null){ input.min = String(min); }
                if(max != null){ input.max = String(max); }
                // Mostrar texto de rango
                const rangoText = document.getElementById('precio-rango-text');
                const minEl = document.getElementById('precio-min');
                const maxEl = document.getElementById('precio-max');
                if(rangoText && minEl && maxEl){
                    if(min != null || max != null){
                        rangoText.style.display = '';
                        minEl.textContent = (min != null) ? min : '—';
                        maxEl.textContent = (max != null) ? max : '—';
                    } else {
                        rangoText.style.display = 'none';
                    }
                }
                input.placeholder = (min != null && max != null) ? (`Entre ${min} y ${max}`) : input.placeholder;
            }
            function validarPrecioRango(){
                const input = document.getElementById('modal-precio');
                if(!input) return true;
                const val = parseFloat(input.value);
                let ok = !isNaN(val) && val >= 0;
                if(rangoPrecio){
                    const {min, max} = rangoPrecio;
                    if(min != null) ok = ok && val >= min;
                    if(max != null) ok = ok && val <= max;
                }
                input.classList.remove('is-valid','is-invalid');
                input.classList.add(ok ? 'is-valid' : 'is-invalid');
                const msg = document.getElementById('modal-precio-msg');
                if(msg){
                    msg.style.display = ok ? 'none' : 'block';
                    msg.textContent = rangoPrecio ? `El precio debe estar dentro del rango permitido (${rangoPrecio.min} - ${rangoPrecio.max}).` : 'Precio inválido';
                }
                return ok;
            }
            async function cargarRango(entrenadorId){
                try{
                    const resp = await fetch(`/api/entrenador/${entrenadorId}/rango-precio`);
                    if(!resp.ok) return;
                    const data = await resp.json();
                    rangoPrecio = {min: data.min, max: data.max};
                    setPrecioConstraints(data.min, data.max);
                    validarPrecioRango();
                }catch(e){ console.warn('No se pudo cargar rango de precio', e); }
            }
            document.addEventListener('click', function(e){
                if(e.target && e.target.classList.contains('btn-cotizar-diagnostico')){
                    const btn = e.target.closest('.btn-cotizar-diagnostico');
                    const entrenadorId = btn?.getAttribute('data-entrenador');
                    if(entrenadorId){ cargarRango(entrenadorId); }
                }
            });
            document.addEventListener('input', function(e){
                if(e.target && e.target.id === 'modal-precio'){
                    validarPrecioRango();
                }
            });
            const form = document.getElementById('form-editar-suscripcion');
            if(form){
                form.addEventListener('submit', function(e){
                    const okBase = validarTodo(true);
                    const okRango = validarPrecioRango();
                    if(!(okBase && okRango)){
                        e.preventDefault(); e.stopPropagation();
                    }
                });
            }
        })();

        // ========== FILTRADO DE BLOQUES ==========
        (function(){
            const filterButtons = document.querySelectorAll('.btn-filter');

            if (filterButtons.length === 0) return;

            // Mapeo de filtros (plural) a estados (singular)
            const filterToEstado = {
                'pendientes': 'pendiente',
                'cotizadas': 'cotizada',
                'aceptadas': 'aceptada',
                'activas': 'aceptada' // Las activas son aceptadas con rutina
            };

            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const filter = this.getAttribute('data-filter');

                    // Actualizar botones activos
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');

                    // FILTRAR VISTA DE CUADRÍCULA (tarjetas)
                    if (filter === 'todos') {
                        // Mostrar todos los elementos de cuadrícula
                        document.querySelectorAll('[data-bloque]').forEach(el => {
                            el.style.display = '';
                        });
                    } else {
                        // Ocultar todos primero
                        document.querySelectorAll('[data-bloque]').forEach(el => {
                            el.style.display = 'none';
                        });

                        // Mostrar solo los del filtro seleccionado
                        document.querySelectorAll(`[data-bloque="${filter}"]`).forEach(el => {
                            el.style.display = '';
                        });
                    }

                    // FILTRAR VISTA DE LISTA (tabla)
                    const tablaFilas = document.querySelectorAll('#vistaLista tbody tr[data-estado]');

                    if (filter === 'todos') {
                        // Mostrar todas las filas
                        tablaFilas.forEach(fila => {
                            fila.style.display = '';
                        });
                    } else if (filter === 'activas') {
                        // Mostrar solo las que tienen rutina activa
                        tablaFilas.forEach(fila => {
                            const tieneRutina = fila.getAttribute('data-tiene-rutina') === 'true';
                            const estadoFila = fila.getAttribute('data-estado');
                            // Activas son las ACEPTADAS con rutina
                            if (estadoFila === 'aceptada' && tieneRutina) {
                                fila.style.display = '';
                            } else {
                                fila.style.display = 'none';
                            }
                        });
                    } else {
                        // Filtrar por estado específico (pendientes, cotizadas, aceptadas)
                        const estadoBuscado = filterToEstado[filter] || filter.toLowerCase();

                        tablaFilas.forEach(fila => {
                            const estadoFila = fila.getAttribute('data-estado');

                            if (estadoFila === estadoBuscado) {
                                fila.style.display = '';
                            } else {
                                fila.style.display = 'none';
                            }
                        });
                    }

                    // Scroll suave hacia arriba después de filtrar
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                });
            });
        })();

        // Confirmación para rechazar suscripción
        (function() {
            const formsRechazar = document.querySelectorAll('.form-rechazar-suscripcion');

            formsRechazar.forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();

                    Swal.fire({
                        title: '¿Estás seguro?',
                        text: "¿Deseas rechazar esta suscripción?",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#dc3545',
                        cancelButtonColor: '#6c757d',
                        confirmButtonText: 'Sí, rechazar',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            form.submit();
                        }
                    });
                });
            });
        })();

        // Detectar parámetro de estado en la URL y activar filtro automáticamente
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const estadoParam = urlParams.get('estado');

            if (estadoParam) {
                // Buscar el botón correspondiente
                const botonFiltro = document.querySelector(`.btn-filter[data-filter="${estadoParam}"]`);

                if (botonFiltro) {
                    // Simular clic en el botón para aplicar el filtro
                    setTimeout(() => {
                        botonFiltro.click();
                    }, 100);
                }
            }
        })();
    </script>
</section>
</body>

</html>
